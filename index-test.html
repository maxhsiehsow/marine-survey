<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V51 (è€ç‹å„ªåŒ–ç‰ˆ)</title>
    <meta name="theme-color" content="#0056b3">

    <style>
        /* === 1. åŸºç¤è¨­å®š (CSS Variables) === */
        :root {
            --primary-color: #0056b3;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --nav-height: 60px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            padding: 0; 
            padding-bottom: 80px; /* é¿é–‹å°èˆªåˆ— */
            color: var(--text-color); 
            -webkit-tap-highlight-color: transparent;
        }

        /* === 2. ä½ˆå±€èˆ‡å®¹å™¨ === */
        .container { 
            padding: 15px; 
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        } 
        .active-tab { 
            display: block; 
            opacity: 1; 
        }

        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }

        h2 { 
            margin-top: 0; 
            color: var(--primary-color); 
            font-size: 1.2rem; 
            border-bottom: 2px solid #e3f2fd; 
            padding-bottom: 10px; 
        }

        /* === 3. è¡¨å–®å…ƒä»¶ === */
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
            margin-bottom: 15px; 
            border: 1px solid #cfd8dc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            background: #fff;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* === 4. æŒ‰éˆ•è¨­è¨ˆ === */
        button { 
            width: 100%; 
            padding: 14px; 
            font-size: 16px; 
            font-weight: 600; 
            margin-top: 8px; 
            cursor: pointer; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            transition: filter 0.2s;
        }
        button:active { filter: brightness(0.9); transform: scale(0.98); }
        button:disabled { background: #ccc !important; cursor: not-allowed; }

        .btn-blue { background: #0288d1; }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #d32f2f; }
        .btn-orange { background: #f57c00; }
        .btn-purple { background: #673ab7; }
        .btn-outline { background: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }

        /* === 5. åº•éƒ¨å°èˆªåˆ— === */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom); /* é©é… iPhone X+ */
        }
        .nav-item { flex: 1; text-align: center; font-size: 10px; color: #999; cursor: pointer; transition: color 0.3s; }
        .nav-item span { display: block; font-size: 24px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }

        /* === 6. ç›¸æ©Ÿå€åŸŸ === */
        .camera-box { 
            position: relative; 
            display: none; 
            margin-bottom: 15px; 
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
        }
        .scanner-view { width: 100%; min-height: 300px; background: #000; }
        #ai-cam-overlay { 
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            display: flex; justify-content: center; z-index: 10; 
        }
        .btn-snap { 
            width: 70px; height: 70px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.9); 
            border: 4px solid var(--primary-color); 
            padding: 0; margin: 0;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }

        /* === 7. çµ±è¨ˆèˆ‡åœ–è¡¨ === */
        .pie-chart { 
            width: 140px; height: 140px; 
            border-radius: 50%; 
            background: conic-gradient(#eee 0% 100%); 
            margin: 10px auto; 
            border: 5px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
        td:last-child { text-align: right; font-weight: bold; }

        /* === 8. UX æç¤ºå…ƒä»¶ (å–ä»£ alert) === */
        #loading-mask { 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #fff; z-index: 9999; 
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; }
        .toast { 
            background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 50px; 
            text-align: center; margin-bottom: 10px; animation: slideDown 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .ai-result-box { 
            border: 2px solid var(--primary-color); background: #e3f2fd; 
            padding: 15px; border-radius: 12px; margin-top: 10px; display: none; 
        }
        .evidence-img { width: 100%; height: 200px; object-fit: cover; display: none; margin-top: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="loading-mask">
        <div class="spinner"></div>
        <h3>ç³»çµ±å•Ÿå‹•ä¸­...</h3>
        <p style="color:#666;">æ­£åœ¨è¼‰å…¥ AI æ¨¡çµ„èˆ‡è³‡æº</p>
    </div>

    <div id="toast-container"></div>

    <div id="view-basic" class="container">
        <h2>ğŸ“ 1. åŸºæœ¬è³‡è¨Š</h2>
        <div class="card">
            <label>å¡«è¡¨äººå§“å</label>
            <input type="text" id="inp_name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            
            <label>åƒèˆ‡äººæ•¸</label>
            <input type="number" id="inp_participants" value="1" min="1">
            
            <label>åœ°é»å®šä½ (GPS)</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_gps" readonly placeholder="å°šæœªå®šä½" style="background:#f9f9f9; text-align:center; font-size: 12px;">
                <button onclick="runGPS()" class="btn-blue" style="width: 80px; margin-top:0;">ğŸ“ å®šä½</button>
            </div>
            <input type="text" id="inp_loc" placeholder="è«‹è¼¸å…¥åœ°é»æè¿° (ä¾‹: è²¢å¯®æ²™ç˜)" style="margin-top: 10px;">
        </div>
        <div class="card" style="background: #e8f5e9;">
            <p style="margin:0; font-size:14px; color:#2e7d32;">ğŸ’¡ æç¤ºï¼šè«‹å…ˆå®Œæˆå®šä½å†é–‹å§‹æƒæï¼Œé€™å°‡æœ‰åŠ©æ–¼æ•¸æ“šåˆ†æã€‚</p>
        </div>
    </div>

    <div id="view-record" class="container">
        <h2>ğŸ“Š 2. è¨˜éŒ„å»¢æ£„ç‰©</h2>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-size:14px; color:#666;">ç›®æ¨™: <span id="target_count">100</span></div>
                <div style="font-size:28px; font-weight:bold; color:var(--primary-color);">
                    <span id="disp_count">0</span> <span style="font-size:14px; color:#999;">å€‹</span>
                </div>
            </div>

            <button id="btn-scan-start" onclick="startRecordScanner()" class="btn-orange">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ¢ç¢¼</button>
            <button id="btn-scan-stop" onclick="stopRecordScanner()" class="btn-red" style="display:none;">â¹ é—œé–‰ç›¸æ©Ÿ</button>
            
            <div id="camera-box-record" class="camera-box">
                <div id="reader-record" class="scanner-view"></div>
                <p style="color:white; text-align:center; padding:10px;">è«‹å°æº–ç“¶èº«æ¢ç¢¼</p>
            </div>

            <hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">

            <label>æ‰‹å‹•æ–°å¢è¨˜éŒ„</label>
            <div class="input-group" style="display:flex; gap:10px;">
                <select id="sel_country" style="flex:2;">
                    <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                    <option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
                    <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                    <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
                    <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
                    <option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
                    <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                    <option value="å…¶å®ƒ">â“ å…¶å®ƒ</option>
                </select>
                <input type="number" id="inp_qty" value="1" min="1" style="flex:1; text-align:center; margin-bottom:0;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="handleManualAdd()" class="btn-green">â• æ–°å¢</button>
                <button onclick="undoRecord()" class="btn-outline">â†©ï¸ å¾©åŸ</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ çµ±è¨ˆæ¦‚è¦½</h3>
            <div style="display:flex; align-items:flex-start;">
                <div style="flex:1; text-align:center;">
                    <div id="css-pie" class="pie-chart"></div>
                </div>
                <div style="flex:1; padding-left:10px;">
                    <table id="stats-table">
                        <tbody id="stats-body"><tr><td style="color:#999;">å°šç„¡è³‡æ–™</td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <label style="margin-top:20px;">ç¾å ´å‚™è¨»</label>
            <textarea id="inp_note" rows="2" placeholder="ä¾‹å¦‚ï¼šå¤§éƒ¨åˆ†æ˜¯å¯¶ç‰¹ç“¶ï¼Œé¢¨æµªå¾ˆå¤§..."></textarea>
            
            <label>ç¾å ´ç…§ç‰‡ (ä¸Šå‚³è­‰æ“š)</label>
            <input type="file" accept="image/*" onchange="previewAndCompress(event)">
            <img id="out_img" class="evidence-img">
            
            <button id="btn-upload" onclick="uploadData()" class="btn-purple" style="margin-top:20px;">ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯</button>
        </div>
    </div>

    <div id="view-ai" class="container">
        <h2>ğŸ¤– 3. AI é‘‘å®šå®¤</h2>
        <div class="card" style="text-align:center;">
            <p>é‡åˆ°ç„¡æ³•è¾¨è­˜çš„ç“¶ç½ï¼Ÿ<br>æ‹å¼µç…§ï¼Œè®“ AI å¹«ä½ åˆ¤æ–·ä¾†æºã€‚</p>
            
            <button id="btn-ai-start" onclick="startAiCamera()" class="btn-blue">ğŸ“· å•Ÿå‹• AI ç›¸æ©Ÿ</button>
            
            <div id="camera-box-ai" class="camera-box">
                <div id="reader-ai" class="scanner-view"></div>
                <div id="ai-cam-overlay">
                    <button onclick="takeAiSnapshot()" class="btn-snap" aria-label="æ‹ç…§"></button>
                </div>
            </div>

            <div id="ai-result-box" class="ai-result-box">
                <img id="ai-preview-img" style="width:100px; height:100px; object-fit:cover; border-radius:8px; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="color:var(--primary-color); margin:10px 0;">AI èªç‚ºæ˜¯ï¼š<br><span id="ai-country-text" style="font-size:1.5em;"></span></h3>
                <p style="font-size:13px; color:#555; background:#fff; padding:8px; border-radius:4px;">ç‰¹å¾µï¼š<span id="ai-desc-text"></span></p>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button id="btn-google-check" class="btn-outline" style="font-size:13px;">ğŸ” Google æŸ¥è­‰</button>
                    <button id="btn-confirm-add" class="btn-green">âœ… åŠ å…¥è¨˜éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-basic" onclick="switchTab('basic')"><span>ğŸ“</span>åŸºæœ¬</div>
        <div class="nav-item" id="nav-record" onclick="switchTab('record')"><span>ğŸ“Š</span>è¨˜éŒ„</div>
        <div class="nav-item" id="nav-ai" onclick="switchTab('ai')"><span>ğŸ¤–</span>AI é‘‘å®š</div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // === å…¨å±€ç‹€æ…‹ç®¡ç† (ä½¿ç”¨ const/let) ===
        const STATE = {
            count: 0,
            target: 100,
            stats: {},
            historyStack: [],
            currentCity: "æœªå®šä½",
            uploadFileBase64: null,
            scanners: { record: null, ai: null }
        };

        // åœ‹å®¶é¡è‰²æ˜ å°„
        const COLORS = {
            'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 
            'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº': '#8d6e63', 'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 
            'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#ff9800', 'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#212121', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#fbc02d', 'å…¶å®ƒ': '#757575'
        };

        // æ¢ç¢¼å‰ç¶´è³‡æ–™åº«
        const PREFIX_DB = {
            "471": "ğŸ‡¹ğŸ‡¼ å°ç£", "690": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "691": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "692": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "693": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "694": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "695": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "696": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "697": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹",
            "893": "ğŸ‡»ğŸ‡³ è¶Šå—", "480": "ğŸ‡µğŸ‡­ è²å¾‹è³“", "955": "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº", "899": "ğŸ‡®ğŸ‡© å°å°¼", "885": "ğŸ‡¹ğŸ‡­ æ³°åœ‹", "880": "ğŸ‡°ğŸ‡· éŸ“åœ‹", "450": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬", "490": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬"
        };

        // âš ï¸âš ï¸âš ï¸ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1kiaaRdWuUtBEBnjG-HuTqedenqisFug4zQ6pyCWXrT0Ja7TF4RCAicTA1Q3u8TA9/exec";

        // === åˆå§‹åŒ– ===
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('loading-mask').style.display = 'none';
                switchTab('basic');
            }, 800);
        };

        // === UI äº’å‹•é‚è¼¯ ===
        function switchTab(tabName) {
            // åˆ‡æ› CSS
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active-tab');
            document.getElementById('nav-' + tabName).classList.add('active');

            // è‡ªå‹•é—œé–‰ç›¸æ©Ÿä»¥ç¯€çœè³‡æºä¸¦é¿å…è¡çª
            stopRecordScanner();
            stopAiScanner();
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerText = msg;
            if (type === 'error') el.style.background = '#d32f2f';
            if (type === 'success') el.style.background = '#2e7d32';
            
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-20px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // === åŠŸèƒ½ 1: GPS å®šä½ ===
        function runGPS() {
            const gpsInput = document.getElementById('inp_gps');
            gpsInput.value = "å®šä½ä¸­...";
            
            if (!navigator.geolocation) { 
                showToast("æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS", "error"); 
                return; 
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    gpsInput.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    fetchCityName(latitude, longitude);
                },
                (err) => {
                    showToast("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªå·²æˆæ¬Šç€è¦½å™¨ä½¿ç”¨ GPS", "error");
                    gpsInput.value = "";
                }
            );
        }

        function fetchCityName(lat, lng) {
            // ä½¿ç”¨å…è²» API åæŸ¥åœ°å
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=zh`)
                .then(res => res.json())
                .then(data => {
                    STATE.currentCity = (data.principalSubdivision || data.locality || "æœªçŸ¥").replace("Province", "").trim();
                    document.getElementById('inp_loc').value = STATE.currentCity + " (è‡ªå‹•å¸¶å…¥)";
                    showToast(`ğŸ“ å®šä½æˆåŠŸï¼š${STATE.currentCity}`, "success");
                })
                .catch(() => showToast("ç„¡æ³•å–å¾—åœ°åï¼Œè«‹æ‰‹å‹•è¼¸å…¥", "error"));
        }

        // === åŠŸèƒ½ 2: æƒææ¢ç¢¼ (ä½¿ç”¨ Promise ç¢ºä¿ç›¸æ©Ÿç‹€æ…‹) ===
        function startRecordScanner() {
            if (STATE.scanners.record) return; // é¿å…é‡è¤‡å•Ÿå‹•

            document.getElementById('camera-box-record').style.display = 'block';
            document.getElementById('btn-scan-start').style.display = 'none';
            document.getElementById('btn-scan-stop').style.display = 'inline-block';

            STATE.scanners.record = new Html5Qrcode("reader-record");
            
            STATE.scanners.record.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    // æƒææˆåŠŸå›èª¿
                    if (navigator.vibrate) navigator.vibrate(50); // è¼•å¾®éœ‡å‹•å›é¥‹
                    STATE.scanners.record.pause();
                    
                    const country = getCountryFromCode(decodedText);
                    
                    // ä½¿ç”¨ setTimeout è®“ UI å…ˆæ¸²æŸ“æš«åœç‹€æ…‹ï¼Œé¿å…å¡é “
                    setTimeout(() => {
                        if (confirm(`ğŸ“¦ æƒæçµæœï¼š${country}\næ¢ç¢¼ï¼š${decodedText}\n\nè¦åŠ å…¥è¨˜éŒ„å—ï¼Ÿ`)) {
                            addRecord(country, 1);
                        }
                        STATE.scanners.record.resume();
                    }, 100);
                },
                () => {} // å¿½ç•¥æƒæå¤±æ•—çš„éŒ¯èª¤ (æ¯å¹€éƒ½æœƒè§¸ç™¼)
            ).catch(err => {
                console.error(err);
                showToast("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™", "error");
                stopRecordScanner();
            });
        }

        function stopRecordScanner() {
            if (STATE.scanners.record) {
                STATE.scanners.record.stop().then(() => {
                    STATE.scanners.record.clear();
                    STATE.scanners.record = null;
                }).catch(err => console.log("Stop failed", err));
            }
            document.getElementById('camera-box-record').style.display = 'none';
            document.getElementById('btn-scan-start').style.display = 'inline-block';
            document.getElementById('btn-scan-stop').style.display = 'none';
        }

        function getCountryFromCode(code) {
            if (!code || code.length < 3) return "æœªçŸ¥æ¢ç¢¼";
            const prefix = code.substring(0, 3);
            return PREFIX_DB[prefix] || `[${prefix}] æœªçŸ¥ä¾†æº`;
        }

        // === åŠŸèƒ½ 3: æ•¸æ“šç®¡ç† ===
        function addRecord(country, qty) {
            if (STATE.count + qty > STATE.target) {
                showToast("âš ï¸ å·²é”ç›®æ¨™æ•¸é‡ï¼Œè«‹å…ˆä¸Šå‚³è³‡æ–™", "error");
                return;
            }
            
            if (!STATE.stats[country]) STATE.stats[country] = 0;
            STATE.stats[country] += qty;
            STATE.count += qty;
            
            // è¨˜éŒ„æ­·å²ä»¥ä¾¿å¾©åŸ
            for(let i=0; i<qty; i++) STATE.historyStack.push({key: country, qty: 1});
            
            updateUI();
            showToast(`å·²åŠ å…¥: ${country}`, "success");
        }

        function undoRecord() {
            if (STATE.historyStack.length === 0) {
                showToast("æ²’æœ‰å¯å¾©åŸçš„å‹•ä½œ");
                return;
            }
            const last = STATE.historyStack.pop();
            STATE.stats[last.key] -= last.qty;
            if (STATE.stats[last.key] <= 0) delete STATE.stats[last.key];
            STATE.count -= last.qty;
            updateUI();
            showToast("å·²å¾©åŸä¸Šä¸€ç­†", "info");
        }

        function handleManualAdd() {
            const country = document.getElementById('sel_country').value;
            const qty = parseInt(document.getElementById('inp_qty').value);
            if (qty > 0) {
                addRecord(country, qty);
                document.getElementById('inp_qty').value = 1;
            }
        }

        function updateUI() {
            // æ›´æ–°æ•¸å­—
            document.getElementById('disp_count').innerText = STATE.count;
            
            // æ›´æ–°åˆ—è¡¨èˆ‡åœ“é¤…åœ–
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = "";
            let gradientStr = [], deg = 0;

            if (STATE.count === 0) {
                tbody.innerHTML = "<tr><td colspan='2' style='text-align:center'>å°šç„¡è³‡æ–™</td></tr>";
                document.getElementById('css-pie').style.background = "#eee";
                return;
            }

            for (const [key, val] of Object.entries(STATE.stats)) {
                const color = COLORS[key] || '#999';
                const percent = ((val / STATE.count) * 100).toFixed(1);
                
                // åˆ—è¡¨
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><span style='color:${color}'>â– </span> ${key} <small style='color:#999'>(${percent}%)</small></td><td>${val}</td>`;
                tbody.appendChild(tr);

                // åœ“é¤…åœ– CSS è¨ˆç®—
                const p = val / STATE.count;
                const d = p * 360;
                gradientStr.push(`${color} ${deg.toFixed(1)}deg ${(deg + d).toFixed(1)}deg`);
                deg += d;
            }
            
            document.getElementById('css-pie').style.background = `conic-gradient(${gradientStr.join(", ")})`;
        }

        // === åŠŸèƒ½ 4: AI é‘‘å®š ===
        function startAiCamera() {
            document.getElementById('ai-result-box').style.display = 'none';
            document.getElementById('camera-box-ai').style.display = 'block';
            document.getElementById('btn-ai-start').style.display = 'none';

            STATE.scanners.ai = new Html5Qrcode("reader-ai");
            STATE.scanners.ai.start({ facingMode: "environment" }, { fps: 10 }, () => {}, () => {})
                .catch(err => showToast("AI ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—", "error"));
        }

        function stopAiScanner() {
            if (STATE.scanners.ai) {
                STATE.scanners.ai.stop().then(() => {
                    STATE.scanners.ai.clear();
                    STATE.scanners.ai = null;
                }).catch(() => {});
            }
            document.getElementById('camera-box-ai').style.display = 'none';
            document.getElementById('btn-ai-start').style.display = 'inline-block';
        }

        function takeAiSnapshot() {
            const videoEl = document.querySelector("#reader-ai video");
            if (!videoEl) return;

            // æ“·å–å½±åƒ
            const canvas = document.createElement("canvas");
            canvas.width = videoEl.videoWidth; 
            canvas.height = videoEl.videoHeight;
            canvas.getContext("2d").drawImage(videoEl, 0, 0);
            
            // å£“ç¸®
            const fullBase64 = canvas.toDataURL("image/jpeg", 0.6); // å“è³ª 0.6
            const base64Data = fullBase64.split(',')[1];

            stopAiScanner();
            
            // å‘¼å«å¾Œç«¯
            showLoading(true, "AI æ­£åœ¨åˆ†æå½±åƒ...");
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "identify", image: base64Data })
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if (data.status === "success") {
                    try {
                        const result = JSON.parse(data.result);
                        displayAiResult(result, fullBase64);
                    } catch (e) { showToast("AI å›å‚³æ ¼å¼ç„¡æ³•è§£æ", "error"); }
                } else {
                    showToast("AI åˆ†æå¤±æ•—: " + data.message, "error");
                }
            })
            .catch(err => {
                showLoading(false);
                showToast("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error");
            });
        }

        function displayAiResult(data, imgSrc) {
            const box = document.getElementById('ai-result-box');
            box.style.display = 'block';
            
            document.getElementById('ai-country-text').innerText = data.country || "ç„¡æ³•è¾¨è­˜";
            document.getElementById('ai-desc-text').innerText = data.keywords || "ç„¡ç‰¹å¾µæè¿°";
            document.getElementById('ai-preview-img').src = imgSrc;

            // è¨­å®šæŒ‰éˆ•
            const searchBtn = document.getElementById('btn-google-check');
            const searchUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(data.keywords + " marine debris")}`;
            searchBtn.onclick = () => window.open(searchUrl, '_blank');

            const addBtn = document.getElementById('btn-confirm-add');
            addBtn.onclick = () => {
                addRecord(data.country || "å…¶å®ƒ", 1);
                box.style.display = 'none';
                switchTab('record');
            };
        }

        // === åŠŸèƒ½ 5: æª”æ¡ˆä¸Šå‚³èˆ‡åœ–ç‰‡å£“ç¸® ===
        function previewAndCompress(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.src = evt.target.result;
                img.onload = () => {
                    // é¡¯ç¤ºé è¦½
                    const outImg = document.getElementById('out_img');
                    outImg.src = img.src;
                    outImg.style.display = 'block';

                    // å£“ç¸®é‚è¼¯ (æœ€å¤§é‚Šé•· 1024px)
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 1024;

                    if (width > height && width > maxDim) {
                        height *= maxDim / width;
                        width = maxDim;
                    } else if (height > maxDim) {
                        width *= maxDim / height;
                        height = maxDim;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    STATE.uploadFileBase64 = canvas.toDataURL('image/jpeg', 0.7);
                };
            };
            reader.readAsDataURL(file);
        }

        function uploadData() {
            if (STATE.count === 0) { showToast("æ²’æœ‰è³‡æ–™å¯ä¸Šå‚³", "error"); return; }
            const name = document.getElementById('inp_name').value;
            if (!name) { showToast("è«‹å…ˆè¼¸å…¥å¡«è¡¨äººå§“å", "error"); switchTab('basic'); return; }

            const btn = document.getElementById('btn-upload');
            btn.disabled = true;
            btn.innerText = "â³ ä¸Šå‚³æ•¸æ“šä¸­...";

            // æº–å‚™è³‡æ–™ Payload
            const payload = {
                action: "save",
                name: name,
                participants: document.getElementById('inp_participants').value,
                loc: document.getElementById('inp_loc').value,
                city: STATE.currentCity,
                gps: document.getElementById('inp_gps').value,
                total: STATE.count,
                note: document.getElementById('inp_note').value,
                fileData: STATE.uploadFileBase64 ? STATE.uploadFileBase64.split(',')[1] : "",
                mimeType: "image/jpeg",
                // å±•é–‹çµ±è¨ˆæ•¸æ“š
                ...parseStatsForUpload()
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // å¦‚æœ GAS æ²’æœ‰å›å‚³æ­£ç¢º CORS Headerï¼Œä½¿ç”¨ no-cors (ä½†ç„¡æ³•è®€å–å›æ‡‰)
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                // æ³¨æ„: no-cors æ¨¡å¼ä¸‹ res.ok å¯èƒ½æ˜¯ falseï¼Œä¸”ç„¡æ³•è®€å– JSON
                // é€™è£¡å‡è¨­é€å‡ºå³æˆåŠŸï¼Œå¯¦éš›å°ˆæ¡ˆå»ºè­°å¾Œç«¯æ­£ç¢ºè¨­å®š CORS
                showToast("ğŸš€ è³‡æ–™å·²å‚³é€ (è‹¥ç„¡éŒ¯èª¤è«‹è¦–ç‚ºæˆåŠŸ)", "success");
                resetForm();
            })
            .catch(err => {
                showToast("âŒ ä¸Šå‚³å¤±æ•—: " + err.message, "error");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯";
            });
        }

        function parseStatsForUpload() {
            // å°‡çµ±è¨ˆç‰©ä»¶å¹³é¢åŒ–ä»¥ä¾¿ Google Sheet è®€å–
            const output = { cnt_tw:0, cnt_cn:0, cnt_vn:0, cnt_ph:0, cnt_my:0, cnt_id:0, cnt_th:0, cnt_kr:0, cnt_jp:0, cnt_other:"" };
            const others = [];
            
            for (const [key, val] of Object.entries(STATE.stats)) {
                if (key.includes("å°ç£")) output.cnt_tw += val;
                else if (key.includes("ä¸­åœ‹")) output.cnt_cn += val;
                else if (key.includes("è¶Šå—")) output.cnt_vn += val;
                else if (key.includes("è²å¾‹è³“")) output.cnt_ph += val;
                else if (key.includes("æ³°åœ‹")) output.cnt_th += val;
                else if (key.includes("éŸ“åœ‹")) output.cnt_kr += val;
                else if (key.includes("æ—¥æœ¬")) output.cnt_jp += val;
                else others.push(`${key}*${val}`);
            }
            output.cnt_other = others.join(", ");
            return output;
        }

        function resetForm() {
            STATE.count = 0;
            STATE.stats = {};
            STATE.historyStack = [];
            STATE.uploadFileBase64 = null;
            document.getElementById('inp_qty').value = "1";
            document.getElementById('out_img').style.display = 'none';
            document.getElementById('inp_note').value = "";
            updateUI();
            switchTab('basic');
        }

        function showLoading(show, text) {
            const mask = document.getElementById('loading-mask');
            mask.style.display = show ? 'flex' : 'none';
            if(text) mask.querySelector('p').innerText = text;
        }
    </script>
</body>
</html>
