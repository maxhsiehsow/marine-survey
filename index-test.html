<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êµ∑Âª¢Ë™øÊü•Âì° V48</title>
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>

    <style>
        /* ÂÖ®Â±ÄÊ®£Âºè */
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 0; padding-bottom: 70px; color: #333; }
        .container { padding: 15px; display: none; } 
        .active-tab { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #0056b3; font-size: 18px; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 12px; font-size: 16px; margin: 5px 0 15px 0; border: 2px solid #cfd8dc; border-radius: 8px; background: #fff; box-sizing: border-box; }
        
        button { width: 100%; padding: 14px; font-size: 16px; font-weight: bold; margin-top: 5px; cursor: pointer; color: white; border: none; border-radius: 8px; }
        .btn-blue { background: #0288d1; }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #d32f2f; }
        .btn-orange { background: #f57c00; }
        .btn-upload { background: #673ab7; }
        .btn-link { background: #fff; color: #0288d1; border: 1px solid #0288d1; margin-top: 5px; }

        /* Â∫ïÈÉ®Â∞éËà™Âàó */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; border-top: 1px solid #ccc; display: flex;
            justify-content: space-around; align-items: center; z-index: 1000;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        .nav-item { flex: 1; text-align: center; font-size: 12px; color: #666; cursor: pointer; }
        .nav-item span { display: block; font-size: 20px; margin-bottom: 2px; }
        .nav-item.active { color: #0056b3; font-weight: bold; }

        /* Áõ∏Ê©üÂÆπÂô® */
        .camera-box { position: relative; display: none; margin-bottom: 15px; background: #000; border-radius: 8px; overflow: hidden; }
        .scanner-view { width: 100%; min-height: 250px; }
        
        /* Tab 3 AI Áõ∏Ê©üÁöÑË¶ÜËìãÊåâÈàï */
        #ai-cam-overlay {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; text-align: center; width: 90%;
        }
        .btn-snap {
            background: rgba(255, 255, 255, 0.9); border: 4px solid #0288d1; color: #0288d1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); padding: 15px 30px; font-size: 18px; border-radius: 50px;
        }

        .pie-chart { width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(#eee 0% 100%); margin: 10px auto; border: 1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
        
        #loading-mask { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; z-index:9999; text-align:center; padding-top:50%; font-size:18px; }
        
        /* AI ÁµêÊûúÂç°Áâá */
        .ai-result-box { border: 2px solid #0056b3; background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; }
        .evidence-img { width: 100%; height: 150px; object-fit: cover; display: none; margin-top: 5px; border: 1px solid #333; }
    </style>

    <script>
        // === ÂÖ®Â±ÄËÆäÊï∏ ===
        var count = 0; var target = 100;
        var stats = {}; var historyStack = [];
        var html5QrCodeRecord = null; var html5QrCodeAi = null;
        var currentCity = "Êú™ÂÆö‰Ωç"; var uploadFileBase64 = null;
        var fixedColors = { 'üáπüáº Âè∞ÁÅ£': '#e53935', 'üá®üá≥ ‰∏≠Âúã': '#1e88e5', 'üáªüá≥ Ë∂äÂçó': '#8e24aa', 'üáµüá≠ Ëè≤ÂæãË≥ì': '#6d4c41', 'üá≤üáæ È¶¨‰æÜË•ø‰∫û': '#8d6e63', 'üáÆüá© Âç∞Â∞º': '#00acc1', 'üáπüá≠ Ê≥∞Âúã': '#ff9800', 'üá∞üá∑ ÈüìÂúã': '#000000', 'üáØüáµ Êó•Êú¨': '#fbc02d', 'ÂÖ∂ÂÆÉ': '#757575' };
        
        const prefixDB = {
            "471": "üáπüáº Âè∞ÁÅ£", "690": "üá®üá≥ ‰∏≠Âúã", "691": "üá®üá≥ ‰∏≠Âúã", "692": "üá®üá≥ ‰∏≠Âúã", "693": "üá®üá≥ ‰∏≠Âúã", "694": "üá®üá≥ ‰∏≠Âúã", "695": "üá®üá≥ ‰∏≠Âúã", "696": "üá®üá≥ ‰∏≠Âúã", "697": "üá®üá≥ ‰∏≠Âúã",
            "893": "üáªüá≥ Ë∂äÂçó", "480": "üáµüá≠ Ëè≤ÂæãË≥ì", "955": "üá≤üáæ È¶¨‰æÜË•ø‰∫û", "899": "üáÆüá© Âç∞Â∞º", "885": "üáπüá≠ Ê≥∞Âúã", "880": "üá∞üá∑ ÈüìÂúã", "450": "üáØüáµ Êó•Êú¨", "490": "üáØüáµ Êó•Êú¨"
        };

        window.onload = function() { resetDate(); switchTab('basic'); };

        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active-tab');
            document.getElementById('nav-' + tabName).classList.add('active');
            stopRecordScanner();
            stopAiScanner();
        }

        // === Tab 1 Basic ===
        function runGPS() {
            document.getElementById('inp_gps').value = "ÂÆö‰Ωç‰∏≠...";
            if(!navigator.geolocation) { alert("‰∏çÊîØÊè¥ GPS"); return; }
            navigator.geolocation.getCurrentPosition(pos => {
                var txt = pos.coords.latitude.toFixed(5) + ", " + pos.coords.longitude.toFixed(5);
                document.getElementById('inp_gps').value = txt;
                fetchCityName(pos.coords.latitude, pos.coords.longitude);
            }, err => { alert("ÂÆö‰ΩçÂ§±Êïó"); });
        }
        function fetchCityName(lat, lng) {
            fetch("https://api.bigdatacloud.net/data/reverse-geocode-client?latitude="+lat+"&longitude="+lng+"&localityLanguage=zh")
            .then(res => res.json()).then(data => {
                currentCity = (data.principalSubdivision || data.locality || "Êú™Áü•").replace("Province", "").trim();
                document.getElementById('out_loc_city').innerText = currentCity;
                alert("üìç ÂÆö‰ΩçÊàêÂäüÔºö"+currentCity);
            });
        }

        // === Tab 2 Record (Ê¢ùÁ¢ºÊéÉÊèè) ===
        function startRecordScanner() {
            // V48 ‰øÆÊîπÔºöÁõ¥Êé•ÂïüÂãïÔºå‰∏çÈúÄË¶ÅÁ≠âÂæÖ loadScannerLib
            document.getElementById('camera-box-record').style.display = 'block';
            document.getElementById('btn-scan-start').style.display = 'none';
            document.getElementById('btn-scan-stop').style.display = 'inline-block';
            try {
                html5QrCodeRecord = new Html5Qrcode("reader-record");
                html5QrCodeRecord.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                    function(decodedText) {
                        if(navigator.vibrate) navigator.vibrate(200);
                        var country = getCountryFromCode(decodedText);
                        if(confirm("‚úÖ ÊéÉÂà∞Ôºö" + country + "\nË¶ÅÂä†ÂÖ•Ë®òÈåÑÂóéÔºü")) { addRecord(country, 1); }
                    }, () => {} 
                );
            } catch(e) { alert("Áõ∏Ê©üÂïüÂãïÈåØË™§ (Ë´ãÁ¢∫‰øùÁ∂≤ÂùÄÁÇ∫ https): " + e); stopRecordScanner(); }
        }

        function stopRecordScanner() {
            if(html5QrCodeRecord && html5QrCodeRecord.isScanning) { html5QrCodeRecord.stop().then(() => html5QrCodeRecord.clear()).catch(()=>{}); }
            document.getElementById('camera-box-record').style.display = 'none';
            document.getElementById('btn-scan-start').style.display = 'inline-block';
            document.getElementById('btn-scan-stop').style.display = 'none';
        }

        function getCountryFromCode(code) {
            if(!code || code.length < 3) return "Êú™Áü•Ê¢ùÁ¢º";
            var p3 = code.substring(0,3);
            return prefixDB[p3] || "[" + p3 + "]";
        }

        // === Tab 3 AI (ÊãçÁÖßËæ®Ë≠ò) ===
        function startAiCamera() {
            document.getElementById('ai-result-box').style.display = 'none';
            // V48 ‰øÆÊîπÔºöÁõ¥Êé•ÂïüÂãï
            document.getElementById('camera-box-ai').style.display = 'block';
            document.getElementById('btn-ai-start').style.display = 'none';
            try {
                html5QrCodeAi = new Html5Qrcode("reader-ai");
                html5QrCodeAi.start({ facingMode: "environment" }, { fps: 10 }, () => {}, () => {});
            } catch(e) { alert("Áõ∏Ê©üÂïüÂãïÂ§±Êïó: " + e); stopAiScanner(); }
        }

        function stopAiScanner() {
            if(html5QrCodeAi && html5QrCodeAi.isScanning) { html5QrCodeAi.stop().then(() => html5QrCodeAi.clear()).catch(()=>{}); }
            document.getElementById('camera-box-ai').style.display = 'none';
            document.getElementById('btn-ai-start').style.display = 'inline-block';
        }

        function takeAiSnapshot() {
            var videoEl = document.querySelector("#reader-ai video");
            if (!videoEl) { alert("Áõ∏Ê©üÊú™ÂïüÂãï"); return; }
            videoEl.pause();
            showLoading("ü§ñ Ê≠£Âú®ÂàÜÊûê‰∏¶Âª∫Á´ãÊêúÂ∞ãÈÄ£Áµê...");
            
            var canvas = document.createElement("canvas");
            canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
            canvas.getContext("2d").drawImage(videoEl, 0, 0);
            var fullBase64 = canvas.toDataURL("image/jpeg", 0.7);
            var base64Data = fullBase64.split(',')[1];
            
            stopAiScanner();
            
            sendToGemini(base64Data, fullBase64);
        }

        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Ë´ãÂú®Ê≠§Ë≤º‰∏äÊÇ®ÁöÑ Google Script Á∂≤ÂùÄ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1kiaaRdWuUtBEBnjG-HuTqedenqisFug4zQ6pyCWXrT0Ja7TF4RCAicTA1Q3u8TA9/exec"; 

        function sendToGemini(base64Data, previewSrc) {
            if(GOOGLE_SCRIPT_URL.indexOf("Ë≤ºÂú®ÈÄôË£°") > -1) { hideLoading(); alert("Ë´ãË®≠ÂÆö Google Script Á∂≤ÂùÄÔºÅ"); return; }
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ action: "identify", image: base64Data })
            })
            .
