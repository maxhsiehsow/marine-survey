<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V51 (è€ç‹å„ªåŒ–ç‰ˆ)</title>
    <meta name="theme-color" content="#0056b3">

    <style>
        /* === 1. åŸºç¤è¨­å®š (CSS Variables) === */
        :root {
            --primary-color: #0056b3;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --nav-height: 60px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            padding: 0; 
            padding-bottom: 80px; /* é¿é–‹å°èˆªåˆ— */
            color: var(--text-color); 
            -webkit-tap-highlight-color: transparent;
        }

        /* === 2. ä½ˆå±€èˆ‡å®¹å™¨ === */
        .container { 
            padding: 15px; 
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        } 
        .active-tab { 
            display: block; 
            opacity: 1; 
        }

        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
        }

        h2 { 
            margin-top: 0; 
            color: var(--primary-color); 
            font-size: 1.2rem; 
            border-bottom: 2px solid #e3f2fd; 
            padding-bottom: 10px; 
        }

        /* === 3. è¡¨å–®å…ƒä»¶ === */
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
            margin-bottom: 15px; 
            border: 1px solid #cfd8dc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            background: #fff;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* === 4. æŒ‰éˆ•è¨­è¨ˆ === */
        button { 
            width: 100%; 
            padding: 14px; 
            font-size: 16px; 
            font-weight: 600; 
            margin-top: 8px; 
            cursor: pointer; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            transition: filter 0.2s;
        }
        button:active { filter: brightness(0.9); transform: scale(0.98); }
        button:disabled { background: #ccc !important; cursor: not-allowed; }

        .btn-blue { background: #0288d1; }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #d32f2f; }
        .btn-orange { background: #f57c00; }
        .btn-purple { background: #673ab7; }
        .btn-outline { background: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }

        /* === 5. åº•éƒ¨å°èˆªåˆ— === */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom); /* é©é… iPhone X+ */
        }
        .nav-item { flex: 1; text-align: center; font-size: 10px; color: #999; cursor: pointer; transition: color 0.3s; }
        .nav-item span { display: block; font-size: 24px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }

        /* === 6. ç›¸æ©Ÿå€åŸŸ === */
        .camera-box { 
            position: relative; 
            display: none; 
            margin-bottom: 15px; 
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
        }
        .scanner-view { width: 100%; min-height: 300px; background: #000; }
        #ai-cam-overlay { 
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            display: flex; justify-content: center; z-index: 10; 
        }
        .btn-snap { 
            width: 70px; height: 70px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.9); 
            border: 4px solid var(--primary-color); 
            padding: 0; margin: 0;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }

        /* === 7. çµ±è¨ˆèˆ‡åœ–è¡¨ === */
        .pie-chart { 
            width: 140px; height: 140px; 
            border-radius: 50%; 
            background: conic-gradient(#eee 0% 100%); 
            margin: 10px auto; 
            border: 5px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
        td:last-child { text-align: right; font-weight: bold; }

        /* === 8. UX æç¤ºå…ƒä»¶ (å–ä»£ alert) === */
        #loading-mask { 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #fff; z-index: 9999; 
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; }
        .toast { 
            background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 50px; 
            text-align: center; margin-bottom: 10px; animation: slideDown 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .ai-result-box { 
            border: 2px solid var(--primary-color); background: #e3f2fd; 
            padding: 15px; border-radius: 12px; margin-top: 10px; display: none; 
        }
        .evidence-img { width: 100%; height: 200px; object-fit: cover; display: none; margin-top: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="loading-mask">
        <div class="spinner"></div>
        <h3>ç³»çµ±å•Ÿå‹•ä¸­...</h3>
        <p style="color:#666;">æ­£åœ¨è¼‰å…¥ AI æ¨¡çµ„èˆ‡è³‡æº</p>
    </div>

    <div id="toast-container"></div>

    <div id="view-basic" class="container">
        <h2>ğŸ“ 1. åŸºæœ¬è³‡è¨Š</h2>
        <div class="card">
            <label>å¡«è¡¨äººå§“å</label>
            <input type="text" id="inp_name" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            
            <label>åƒèˆ‡äººæ•¸</label>
            <input type="number" id="inp_participants" value="1" min="1">
            
            <label>åœ°é»å®šä½ (GPS)</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_gps" readonly placeholder="å°šæœªå®šä½" style="background:#f9f9f9; text-align:center; font-size: 12px;">
                <button onclick="runGPS()" class="btn-blue" style="width: 80px; margin-top:0;">ğŸ“ å®šä½</button>
            </div>
            <input type="text" id="inp_loc" placeholder="è«‹è¼¸å…¥åœ°é»æè¿° (ä¾‹: è²¢å¯®æ²™ç˜)" style="margin-top: 10px;">
        </div>
        <div class="card" style="background: #e8f5e9;">
            <p style="margin:0; font-size:14px; color:#2e7d32;">ğŸ’¡ æç¤ºï¼šè«‹å…ˆå®Œæˆå®šä½å†é–‹å§‹æƒæï¼Œé€™å°‡æœ‰åŠ©æ–¼æ•¸æ“šåˆ†æã€‚</p>
        </div>
    </div>

    <div id="view-record" class="container">
        <h2>ğŸ“Š 2. è¨˜éŒ„å»¢æ£„ç‰©</h2>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-size:14px; color:#666;">ç›®æ¨™: <span id="target_count">100</span></div>
                <div style="font-size:28px; font-weight:bold; color:var(--primary-color);">
                    <span id="disp_count">0</span> <span style="font-size:14px; color:#999;">å€‹</span>
                </div>
            </div>

            <button id="btn-scan-start" onclick="startRecordScanner()" class="btn-orange">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ¢ç¢¼</button>
            <button id="btn-scan-stop" onclick="stopRecordScanner()" class="btn-red" style="display:none;">â¹ é—œé–‰ç›¸æ©Ÿ</button>
            
            <div id="camera-box-record" class="camera-box">
                <div id="reader-record" class="scanner-view"></div>
                <p style="color:white; text-align:center; padding:10px;">è«‹å°æº–ç“¶èº«æ¢ç¢¼</p>
            </div>

            <hr style="border:0; border-top:1px dashed #ccc; margin: 20px 0;">

            <label>æ‰‹å‹•æ–°å¢è¨˜éŒ„</label>
            <div class="input-group" style="display:flex; gap:10px;">
                <select id="sel_country" style="flex:2;">
                    <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                    <option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
                    <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                    <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
                    <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
                    <option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
                    <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                    <option value="å…¶å®ƒ">â“ å…¶å®ƒ</option>
                </select>
                <input type="number" id="inp_qty" value="1" min="1" style="flex:1; text-align:center; margin-bottom:0;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="handleManualAdd()" class="btn-green">â• æ–°å¢</button>
                <button onclick="undoRecord()" class="btn-outline">â†©ï¸ å¾©åŸ</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ çµ±è¨ˆæ¦‚è¦½</h3>
            <div style="display:flex; align-items:flex-start;">
                <div style="flex:1; text-align:center;">
                    <div id="css-pie" class="pie-chart"></div>
                </div>
                <div style="flex:1; padding-left:10px;">
                    <table id="stats-table">
                        <tbody id="stats-body"><tr><td style="color:#999;">å°šç„¡è³‡æ–™</td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <label style="margin-top:20px;">ç¾å ´å‚™è¨»</label>
            <textarea id="inp_note" rows="2" placeholder="ä¾‹å¦‚ï¼šå¤§éƒ¨åˆ†æ˜¯å¯¶ç‰¹ç“¶ï¼Œé¢¨æµªå¾ˆå¤§..."></textarea>
            
            <label>ç¾å ´ç…§ç‰‡ (ä¸Šå‚³è­‰æ“š)</label>
            <input type="file" accept="image/*" onchange="previewAndCompress(event)">
            <img id="out_img" class="evidence-img">
            
            <button id="btn-upload" onclick="uploadData()" class="btn-purple" style="margin-top:20px;">ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯</button>
        </div>
    </div>

    <div id="view-ai" class="container">
        <h2>ğŸ¤– 3. AI é‘‘å®šå®¤</h2>
        <div class="card" style="text-align:center;">
            <p>é‡åˆ°ç„¡æ³•è¾¨è­˜çš„ç“¶ç½ï¼Ÿ<br>æ‹å¼µç…§ï¼Œè®“ AI å¹«ä½ åˆ¤æ–·ä¾†æºã€‚</p>
            
            <button id="btn-ai-start" onclick="startAiCamera()" class="btn-blue">ğŸ“· å•Ÿå‹• AI ç›¸æ©Ÿ</button>
            
            <div id="camera-box-ai" class="camera-box">
                <div id="reader-ai" class="scanner-view"></div>
                <div id="ai-cam-overlay">
                    <div onclick="takeAiSnapshot(event)" class="btn-snap" style="display:flex; justify-content:center; align-items:center; cursor:pointer;">
                        <span style="font-size:30px;">ğŸ“¸</span>
                    </div>
                </div>
            </div>

            <div id="ai-result-box" class="ai-result-box">
                <img id="ai-preview-img" style="width:100px; height:100px; object-fit:cover; border-radius:8px; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                <h3 style="color:var(--primary-color); margin:10px 0;">AI èªç‚ºæ˜¯ï¼š<br><span id="ai-country-text" style="font-size:1.5em;"></span></h3>
                <p style="font-size:13px; color:#555; background:#fff; padding:8px; border-radius:4px;">ç‰¹å¾µï¼š<span id="ai-desc-text"></span></p>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button id="btn-google-check" class="btn-outline" style="font-size:13px;">ğŸ” Google æŸ¥è­‰</button>
                    <button id="btn-confirm-add" class="btn-green">âœ… åŠ å…¥è¨˜éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-basic" onclick="switchTab('basic')"><span>ğŸ“</span>åŸºæœ¬</div>
        <div class="nav-item" id="nav-record" onclick="switchTab('record')"><span>ğŸ“Š</span>è¨˜éŒ„</div>
        <div class="nav-item" id="nav-ai" onclick="switchTab('ai')"><span>ğŸ¤–</span>AI é‘‘å®š</div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
        // === 1. å…¨å±€è®Šæ•¸èˆ‡è¨­å®š ===
        const STATE = {
            count: 0,
            target: 100,
            stats: {},
            historyStack: [],
            currentCity: "æœªå®šä½",
            uploadFileBase64: null,
            scanners: { record: null, ai: null }
        };

        // æ¢ç¢¼å‰ç¶´è³‡æ–™åº«
        const PREFIX_DB = {
            "471": "ğŸ‡¹ğŸ‡¼ å°ç£", "690": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "691": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "692": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "693": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", 
            "694": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "695": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "696": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "697": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹",
            "893": "ğŸ‡»ğŸ‡³ è¶Šå—", "480": "ğŸ‡µğŸ‡­ è²å¾‹è³“", "955": "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº", "899": "ğŸ‡®ğŸ‡© å°å°¼", 
            "885": "ğŸ‡¹ğŸ‡­ æ³°åœ‹", "880": "ğŸ‡°ğŸ‡· éŸ“åœ‹", "450": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬", "490": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬"
        };

        // åœ‹å®¶é¡è‰²æ˜ å°„
        const COLORS = {
            'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 
            'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº': '#8d6e63', 'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 
            'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#ff9800', 'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#212121', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#fbc02d', 'å…¶å®ƒ': '#757575'
        };

        // âš ï¸ è«‹ç¢ºèªé€™æ˜¯ä½ éƒ¨ç½² V65 å¾Œçš„ç¶²å€
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1kiaaRdWuUtBEBnjG-HuTqedenqisFug4zQ6pyCWXrT0Ja7TF4RCAicTA1Q3u8TA9/exec";

        // === 2. æ ¸å¿ƒé‚è¼¯ï¼šåç¨±æ­£è¦åŒ– ===
        function normalizeName(rawName) {
            if (!rawName) return "æœªçŸ¥";
            let clean = rawName.toString().trim();
            
            // é—œéµå­—å°æ‡‰ (è§£æ±º AI å›å‚³ "ä¸­åœ‹å¤§é™¸" æˆ– "Taiwan" çš„å•é¡Œ)
            if (clean.includes("å°ç£") || clean.includes("Taiwan") || clean.includes("ROC")) return "ğŸ‡¹ğŸ‡¼ å°ç£";
            if (clean.includes("ä¸­åœ‹") || clean.includes("China") || clean.includes("CN") || clean.includes("å¤§é™¸")) return "ğŸ‡¨ğŸ‡³ ä¸­åœ‹";
            if (clean.includes("è¶Šå—") || clean.includes("Vietnam")) return "ğŸ‡»ğŸ‡³ è¶Šå—";
            if (clean.includes("è²å¾‹è³“") || clean.includes("Philippines")) return "ğŸ‡µğŸ‡­ è²å¾‹è³“";
            if (clean.includes("æ³°åœ‹") || clean.includes("Thailand")) return "ğŸ‡¹ğŸ‡­ æ³°åœ‹";
            if (clean.includes("å°å°¼") || clean.includes("Indonesia")) return "ğŸ‡®ğŸ‡© å°å°¼";
            if (clean.includes("é¦¬ä¾†è¥¿äº") || clean.includes("Malaysia")) return "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº";
            if (clean.includes("éŸ“åœ‹") || clean.includes("Korea")) return "ğŸ‡°ğŸ‡· éŸ“åœ‹";
            if (clean.includes("æ—¥æœ¬") || clean.includes("Japan")) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬";

            if (clean.includes("ğŸ‡¹ğŸ‡¼") || clean.includes("ğŸ‡¨ğŸ‡³")) return clean;
            return clean; // æ²’å°æ‡‰åˆ°å°±å›å‚³åŸå
        }

        // === 3. åˆå§‹åŒ– ===
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('loading-mask').style.display = 'none';
                switchTab('basic');
            }, 800);
        };

        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active-tab');
            document.getElementById('nav-' + tabName).classList.add('active');
            stopRecordScanner();
            stopAiScanner();
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerText = msg;
            if (type === 'error') el.style.background = '#d32f2f';
            if (type === 'success') el.style.background = '#2e7d32';
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(-20px)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // === 4. GPS å®šä½ ===
        function runGPS() {
            const gpsInput = document.getElementById('inp_gps');
            gpsInput.value = "å®šä½ä¸­...";
            if (!navigator.geolocation) { showToast("ä¸æ”¯æ´ GPS", "error"); return; }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    gpsInput.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                    fetchCityName(latitude, longitude);
                },
                () => { showToast("å®šä½å¤±æ•—", "error"); gpsInput.value = ""; }
            );
        }

        function fetchCityName(lat, lng) {
            fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=zh`)
                .then(res => res.json())
                .then(data => {
                    STATE.currentCity = (data.principalSubdivision || data.locality || "æœªçŸ¥").replace("Province", "").trim();
                    document.getElementById('inp_loc').value = STATE.currentCity;
                    showToast(`ğŸ“ å®šä½æˆåŠŸï¼š${STATE.currentCity}`, "success");
                });
        }

        // === 5. æƒææ¢ç¢¼ ===
        function startRecordScanner() {
            if (STATE.scanners.record) return;
            document.getElementById('camera-box-record').style.display = 'block';
            document.getElementById('btn-scan-start').style.display = 'none';
            document.getElementById('btn-scan-stop').style.display = 'inline-block';
            
            STATE.scanners.record = new Html5Qrcode("reader-record");
            STATE.scanners.record.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    STATE.scanners.record.pause();
                    const country = getCountryFromCode(decodedText);
                    if (confirm(`ğŸ“¦ æƒåˆ°ï¼š${country}\nè¦åŠ å…¥å—ï¼Ÿ`)) { addRecord(country, 1); }
                    setTimeout(() => STATE.scanners.record.resume(), 500);
                }, () => {}
            );
        }

        function stopRecordScanner() {
            if (STATE.scanners.record) {
                STATE.scanners.record.stop().then(() => {
                    STATE.scanners.record.clear();
                    STATE.scanners.record = null;
                }).catch(() => {});
            }
            document.getElementById('camera-box-record').style.display = 'none';
            document.getElementById('btn-scan-start').style.display = 'inline-block';
            document.getElementById('btn-scan-stop').style.display = 'none';
        }

        function getCountryFromCode(code) {
            if (!code || code.length < 3) return "æœªçŸ¥";
            return PREFIX_DB[code.substring(0, 3)] || "æœªçŸ¥ä¾†æº";
        }

        // === 6. è³‡æ–™ç®¡ç† (æ ¸å¿ƒ) ===
        function addRecord(country, qty) {
            // ğŸ”¥ å¼·åˆ¶æ­£è¦åŒ–ï¼šä¸ç®¡æ˜¯ AI é‚„æ˜¯æƒæï¼Œé€²ä¾†éƒ½å…ˆæ´—ä¸€é
            let safeCountry = normalizeName(country);

            if (STATE.count + qty > STATE.target) { showToast("å·²é”ç›®æ¨™ä¸Šé™", "error"); return; }
            if (!STATE.stats[safeCountry]) STATE.stats[safeCountry] = 0;
            
            STATE.stats[safeCountry] += qty;
            STATE.count += qty;
            for(let i=0; i<qty; i++) STATE.historyStack.push({key: safeCountry, qty: 1});
            
            updateUI();
            showToast(`å·²åŠ å…¥: ${safeCountry}`, "success");
        }

        function undoRecord() {
            if (STATE.historyStack.length === 0) return;
            const last = STATE.historyStack.pop();
            STATE.stats[last.key] -= last.qty;
            if (STATE.stats[last.key] <= 0) delete STATE.stats[last.key];
            STATE.count -= last.qty;
            updateUI();
        }

        function handleManualAdd() {
            addRecord(document.getElementById('sel_country').value, parseInt(document.getElementById('inp_qty').value));
        }

        function updateUI() {
            document.getElementById('disp_count').innerText = STATE.count;
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = "";
            let grad = [], deg = 0;

            if (STATE.count === 0) {
                tbody.innerHTML = "<tr><td colspan='2' style='text-align:center'>ç„¡è³‡æ–™</td></tr>";
                document.getElementById('css-pie').style.background = "#eee";
                return;
            }

            for (const [key, val] of Object.entries(STATE.stats)) {
                const color = COLORS[key] || '#999';
                const percent = ((val / STATE.count) * 100).toFixed(1);
                tbody.innerHTML += `<tr><td><span style='color:${color}'>â– </span> ${key} <small>(${percent}%)</small></td><td>${val}</td></tr>`;
                
                const d = (val / STATE.count) * 360;
                grad.push(`${color} ${deg}deg ${deg + d}deg`);
                deg += d;
            }
            document.getElementById('css-pie').style.background = `conic-gradient(${grad.join(", ")})`;
        }

        // === 7. AI é‘‘å®š (æœ€çµ‚ä¹¾æ·¨ç‰ˆ) ===
        function startAiCamera() {
            document.getElementById('ai-result-box').style.display = 'none';
            document.getElementById('camera-box-ai').style.display = 'block';
            document.getElementById('btn-ai-start').style.display = 'none';
            STATE.scanners.ai = new Html5Qrcode("reader-ai");
            STATE.scanners.ai.start({ facingMode: "environment" }, { fps: 10 }, () => {}, () => {});
        }

        function stopAiScanner() {
            if (STATE.scanners.ai) {
                STATE.scanners.ai.stop().then(() => {
                    STATE.scanners.ai.clear();
                    STATE.scanners.ai = null;
                }).catch(() => {});
            }
            document.getElementById('camera-box-ai').style.display = 'none';
            document.getElementById('btn-ai-start').style.display = 'inline-block';
        }

        function takeAiSnapshot() {
            // å¦‚æœæœ‰å‚³å…¥ eventï¼Œå°±é˜»æ­¢å®ƒçš„é è¨­è¡Œç‚º (é€™æ˜¯é›™é‡ä¿éšª)
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            var videoEl = document.querySelector("#reader-ai video");
            if (!videoEl) { alert("ç›¸æ©Ÿæœªå•Ÿå‹•"); return; }
            videoEl.pause();
            
            // é¡¯ç¤ºè½‰åœˆåœˆ
            var mask = document.getElementById('loading-mask');
            mask.style.display = 'flex';
            mask.querySelector('p').innerText = "AI æ­£åœ¨åˆ†æå½±åƒ (V65)...";

            // ç¸®åœ–
            var canvas = document.createElement("canvas");
            var maxDim = 800; 
            var w = videoEl.videoWidth, h = videoEl.videoHeight;
            var scale = (w > h ? (w > maxDim ? maxDim/w : 1) : (h > maxDim ? maxDim/h : 1));
            canvas.width = w * scale; canvas.height = h * scale;
            canvas.getContext("2d").drawImage(videoEl, 0, 0, canvas.width, canvas.height);
            
            var fullBase64 = canvas.toDataURL("image/jpeg", 0.6);
            var base64Data = fullBase64.split(',')[1];

            stopAiScanner(); // é—œé–‰ç›¸æ©Ÿ

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "identify", image: base64Data })
            })
            .then(res => res.json())
            .then(data => {
                mask.style.display = 'none'; // é—œé–‰è½‰åœˆåœˆ
                if (data.status === "success") {
                    try {
                        // æ™ºæ…§æå– JSON
                        var raw = typeof data.result === 'string' ? data.result : JSON.stringify(data.result);
                        var match = raw.match(/\{[\s\S]*\}/);
                        if (match) {
                            displayAiResult(JSON.parse(match[0]), fullBase64);
                        } else {
                            alert("AI å›æ‡‰æ ¼å¼éŒ¯èª¤: " + raw);
                        }
                    } catch(e) { alert("è§£æå¤±æ•—: " + e.message); }
                } else {
                    alert("å¾Œç«¯éŒ¯èª¤: " + data.message);
                }
            })
            .catch(err => {
                mask.style.display = 'none';
                alert("é€£ç·šå¤±æ•—: " + err.message);
            });
        }

        function displayAiResult(data, imgSrc) {
            const box = document.getElementById('ai-result-box');
            box.style.display = 'block'; // é¡¯ç¤ºçµæœæ¡†
            
            document.getElementById('ai-country-text').innerText = data.country || "æœªçŸ¥";
            document.getElementById('ai-desc-text').innerText = data.keywords || "ç„¡";
            document.getElementById('ai-preview-img').src = imgSrc;

            document.getElementById('btn-confirm-add').onclick = () => {
                addRecord(data.country || "å…¶å®ƒ", 1); // addRecord æœƒè‡ªå‹•æ­£è¦åŒ–
                box.style.display = 'none';
                switchTab('record');
            };
        }

        // === 8. ä¸Šå‚³è³‡æ–™ ===
        function previewAndCompress(e) {
            // (ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œè«‹ä¿ç•™ä½ åŸæœ¬çš„é è¦½å‡½å¼ï¼Œæˆ–è€…åƒè€ƒ Turn 1 çš„ä»£ç¢¼)
            var file = e.target.files[0];
            if(!file) return;
            var reader = new FileReader();
            reader.onload = function(evt) {
                 var img = document.getElementById('out_img');
                 img.src = evt.target.result; img.style.display='block';
                 var temp = new Image(); temp.src = evt.target.result;
                 temp.onload = function() {
                     var cvs = document.createElement('canvas');
                     var s = 1024/temp.width; if(s>1) s=1;
                     cvs.width = temp.width*s; cvs.height = temp.height*s;
                     cvs.getContext('2d').drawImage(temp,0,0,cvs.width,cvs.height);
                     STATE.uploadFileBase64 = cvs.toDataURL('image/jpeg', 0.7);
                 }
            };
            reader.readAsDataURL(file);
        }

        function uploadData() {
            if(STATE.count===0) { showToast("ç„¡è³‡æ–™", "error"); return; }
            var btn = document.getElementById('btn-upload');
            btn.innerText = "â³ ä¸Šå‚³ä¸­..."; btn.disabled = true;

            // æº–å‚™çµ±è¨ˆå­—ä¸²
            let otherStr = [];
            let statsOut = { cnt_tw:0, cnt_cn:0, cnt_vn:0, cnt_ph:0, cnt_my:0, cnt_id:0, cnt_th:0, cnt_kr:0, cnt_jp:0 };
            for(let k in STATE.stats) {
                if(k.includes("å°ç£")) statsOut.cnt_tw += STATE.stats[k];
                else if(k.includes("ä¸­åœ‹")) statsOut.cnt_cn += STATE.stats[k];
                else if(k.includes("è¶Šå—")) statsOut.cnt_vn += STATE.stats[k];
                else if(k.includes("è²å¾‹è³“")) statsOut.cnt_ph += STATE.stats[k];
                else if(k.includes("æ³°åœ‹")) statsOut.cnt_th += STATE.stats[k];
                else if(k.includes("å°å°¼")) statsOut.cnt_id += STATE.stats[k];
                else if(k.includes("é¦¬ä¾†è¥¿äº")) statsOut.cnt_my += STATE.stats[k];
                else if(k.includes("éŸ“åœ‹")) statsOut.cnt_kr += STATE.stats[k];
                else if(k.includes("æ—¥æœ¬")) statsOut.cnt_jp += STATE.stats[k];
                else otherStr.push(k + "*" + STATE.stats[k]);
            }

            var payload = {
                action: "save",
                name: document.getElementById('inp_name').value,
                participants: document.getElementById('inp_participants').value,
                loc: document.getElementById('inp_loc').value,
                city: STATE.currentCity,
                gps: document.getElementById('inp_gps').value,
                total: STATE.count,
                note: document.getElementById('inp_note').value,
                fileData: STATE.uploadFileBase64 ? STATE.uploadFileBase64.split(',')[1] : "",
                mimeType: "image/jpeg",
                cnt_other: otherStr.join(", "),
                ...statsOut
            };

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
                STATE.count=0; STATE.stats={}; STATE.historyStack=[]; STATE.uploadFileBase64=null;
                updateUI(); switchTab('basic');
            })
            .catch(err => alert("ä¸Šå‚³å¤±æ•—: " + err))
            .finally(() => { btn.innerText = "ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯"; btn.disabled = false; });
        }
    </script>
</body>
</html>









