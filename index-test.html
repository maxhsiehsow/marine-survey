<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V76 (å°ˆæ¥­æª”ç®¡ç‰ˆ)</title>
    <style>
        :root { --primary: #00695c; --bg: #f0f2f5; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); -webkit-font-smoothing: antialiased; }
        
        #line-warning { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; color: white; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .arrow-icon { font-size: 40px; animation: bounce 1.5s infinite; margin-bottom: 20px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* é¬§é˜è¦–çª— */
        #alarm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .alarm-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 5px solid #ef5350; animation: shake 0.5s infinite; }
        .alarm-title { font-size: 24px; font-weight: bold; color: #d32f2f; margin-bottom: 10px; }
        .alarm-icon { font-size: 60px; margin-bottom: 10px; display: block; }
        
        .container { padding: 16px; display: none; animation: fadeIn 0.4s ease-out; max-width: 600px; margin: 0 auto; }
        .active-tab { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--primary); font-size: 18px; border-left: 5px solid var(--primary); padding-left: 10px; margin-bottom: 15px; font-weight: 700; letter-spacing: 0.5px; }
        
        label { display: block; margin: 12px 0 6px; font-weight: 600; font-size: 15px; color: #444; }
        .required::after { content: " *"; color: #e53935; }
        
        input, select, textarea { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #fafafa; transition: border 0.2s, background 0.2s; appearance: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #fff; outline: none; }
        
        button, .btn { width: 100%; padding: 14px; font-size: 16px; font-weight: 600; margin-top: 12px; cursor: pointer; color: white; border: none; border-radius: 10px; text-align: center; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.98); }
        .btn-blue { background: #039be5; } .btn-green { background: #43a047; } .btn-red { background: #e53935; } 
        .btn-orange { background: #fb8c00; } .btn-upload { background: #5e35b1; }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); box-shadow: none; }

        .img-preview-box { display: flex; gap: 10px; margin-top: 8px; overflow-x: auto; padding-bottom: 5px; }
        /* ç¸®å°ä¸€é»å¯¬åº¦ä»¥å®¹ç´3å€‹ */
        .preview-item { width: 85px; height: 85px; background: #f5f5f5; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative; border: 2px dashed #ccc; flex-shrink: 0; cursor: pointer; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-label { font-size: 10px; margin-top: 4px; color: #666; font-weight: bold; }
        .preview-icon { font-size: 24px; color: #999; }

        .timer-container { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .timer-box { width: 110px; height: 110px; border-radius: 50%; background: white; border: 6px solid #eceff1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; box-shadow: 0 6px 10px rgba(0,0,0,0.05); transition: all 0.3s; }
        .timer-box.running { border-color: #ffb74d; animation: pulse 1.5s infinite; }
        .timer-box.done { border-color: #ef5350; background: #ffebee; }
        .timer-time { font-size: 26px; font-weight: 800; color: #455a64; font-variant-numeric: tabular-nums; }
        .timer-label { font-size: 12px; color: #90a4ae; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; text-align: center; font-size: 11px; color: #b0bec5; padding-top: 5px; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { display: block; font-size: 24px; margin-bottom: 2px; }

        .footer-credit { text-align: center; font-size: 13px; color: #90a4ae; margin-top: 30px; padding-bottom: 20px; line-height: 1.6; border-top: 1px dashed #cfd8dc; padding-top: 15px; }
        .footer-credit a { color: var(--primary); text-decoration: none; font-weight: bold; }

        .camera-box { position: relative; display: none; background: #000; border-radius: 16px; overflow: hidden; margin-top: 15px; }
        .scanner-view { width: 100%; min-height: 300px; }
        .btn-snap-div { width: 72px; height: 72px; background: rgba(255,255,255,0.95); border-radius: 50%; border: 4px solid var(--primary); display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 0 auto; position: absolute; bottom: 25px; left: 0; right: 0; z-index: 10; font-size: 32px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .ai-result-box { display: none; border: 2px solid var(--primary); background: #e0f2f1; padding: 20px; border-radius: 16px; margin-top: 15px; text-align: center; }
        #loading-mask { display: flex; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); flex-direction:column; justify-content:center; align-items:center; z-index:9999; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 5px solid #eceff1; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .pie-chart { width: 130px; height: 130px; border-radius: 50%; margin: 10px auto; transition: all 0.3s; border: 2px dashed #ddd; background: transparent; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 10px 5px; }
    </style>
</head>
<body>

    <div id="line-warning">
        <div class="arrow-icon">â†—ï¸</div>
        <h1>è«‹é»æ“Šå³ä¸Šè§’<br>ä½¿ç”¨å…¶ä»–ç€è¦½å™¨é–‹å•Ÿ</h1>
        <p>LINE å…§å»ºç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿèˆ‡å®šä½åŠŸèƒ½ã€‚<br>è«‹åˆ‡æ›è‡³ Chrome (Android) æˆ– Safari (iOS)ã€‚</p>
    </div>

    <div id="alarm-modal">
        <div class="alarm-content">
            <span class="alarm-icon">â°</span>
            <div class="alarm-title">æ™‚é–“åˆ°ï¼</div>
            <p>è«‹çµæŸèª¿æŸ¥ä¸¦ä¸Šå‚³è³‡æ–™</p>
            <button class="btn-red" onclick="stopAlarm()">ç¢ºå®š (åœæ­¢éœ‡å‹•)</button>
        </div>
    </div>

    <div id="loading-mask"><div class="spinner"></div><p id="loading-text" style="margin-top:15px; color:#555; font-weight:bold;">ç³»çµ±è¼‰å…¥ä¸­...</p></div>

    <div id="view-basic" class="container active-tab">
        <h2>ğŸ“ 1. åƒèˆ‡äººå“¡è³‡è¨Š</h2>
        <div class="card">
            <label class="required">å¡«è¡¨äººå§“å</label>
            <input type="text" id="inp_name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
            <label class="required">è¯çµ¡äººæ‰‹æ©Ÿ</label>
            <input type="tel" id="inp_phone" placeholder="09xx-xxx-xxx">
            <label class="required">åƒèˆ‡äººæ•¸</label>
            <input type="number" id="inp_participants" value="1" min="1" style="text-align:center;">
        </div>

        <h2>ğŸ“ 2. èª¿æŸ¥åœ°é»</h2>
        <div class="card">
            <label>GPS / ç¸£å¸‚é„‰é®</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_gps" readonly placeholder="å°šæœªå®šä½" style="flex:1; font-size:13px; color:#666; background:#f5f5f5;">
                <button onclick="runGPS()" class="btn-blue" style="flex:0.6; margin-top:0;">ğŸ“¡ å®šä½</button>
            </div>
            <input type="text" id="inp_city" readonly placeholder="å®šä½å¾Œè‡ªå‹•é¡¯ç¤ºç¸£å¸‚é„‰é®" style="margin-top:10px; background:#e0f2f1; color:#00695c; font-weight:bold; border-color:#b2dfdb;">
            <label>èª¿æŸ¥æ¨£é» (è‹±æ–‡ä»£è™Ÿ)</label>
            <input type="text" id="inp_point" placeholder="ä¾‹å¦‚: A, B (è‡ªå‹•è½‰å¤§å¯«)" style="text-transform:uppercase; letter-spacing:1px;" oninput="this.value = this.value.toUpperCase()">
            
            <label>ğŸ“¸ ç¾å ´ç…§ç‰‡ä¸Šå‚³</label>
            <div class="img-preview-box">
                <input type="file" id="file-env" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'env')">
                <input type="file" id="file-group" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'group')">
                <div class="preview-item" onclick="document.getElementById('file-env').click()">
                    <img id="img-preview-env" src="" style="display:none">
                    <span id="icon-env" class="preview-icon">ğŸï¸</span><div class="preview-label">ç’°å¢ƒç…§</div>
                </div>
                <div class="preview-item" onclick="document.getElementById('file-group').click()">
                    <img id="img-preview-group" src="" style="display:none">
                    <span id="icon-group" class="preview-icon">ğŸ‘¥</span><div class="preview-label">åˆç…§</div>
                </div>
            </div>
        </div>

        <h2>â±ï¸ 3. èª¿æŸ¥è¨ˆæ™‚å™¨</h2>
        <div class="card">
            <p style="text-align:center; font-size:13px; color:#78909c; margin:0 0 10px;">é»æ“Šåœ“åœˆé–‹å§‹ / æš«åœ (çµæŸæœƒæŒçºŒéœ‡å‹•)</p>
            <div class="timer-container">
                <div class="timer-box" id="timer-10" onclick="toggleTimer(10)">
                    <div class="timer-time" id="time-display-10">10:00</div>
                    <div class="timer-label">10 åˆ†é˜</div>
                </div>
                <div class="timer-box" id="timer-20" onclick="toggleTimer(20)">
                    <div class="timer-time" id="time-display-20">20:00</div>
                    <div class="timer-label">20 åˆ†é˜</div>
                </div>
            </div>
        </div>

        <div class="footer-credit">
            ç¶²é è¨­è¨ˆè¦åŠƒï¼šè’é‡ä¿è­·å”æœƒ æ£²åœ°å®ˆè­·éƒ¨é›å­<br>
            è¯çµ¡ä¿¡ç®±ï¼š<a href="mailto:max@wilderness.tw">max@wilderness.tw</a>
        </div>
    </div>

    <div id="view-record" class="container">
        <h2>ğŸ“Š 4. è¨˜éŒ„èˆ‡æˆæœ</h2>
        <div class="card">
            <div style="text-align:center; font-size:16px; color:#666; margin-bottom:5px;">ç›®å‰æ”¶é›†ç¸½æ•¸</div>
            <div style="text-align:center; font-size:42px; font-weight:800; color:var(--primary); margin-bottom:15px; font-family:sans-serif;">
                <span id="disp_count">0</span> <span style="font-size:18px; color:#999; font-weight:normal;">/ 100</span>
            </div>
            
            <button id="btn-scan-start" onclick="startRecordScanner()" class="btn-orange">ğŸ“· æƒææ¢ç¢¼è¨˜éŒ„</button>
            <button id="btn-scan-stop" onclick="stopRecordScanner()" class="btn-red" style="display:none;">â¹ åœæ­¢æƒæ</button>
            <div id="camera-box-record" class="camera-box"><div id="reader-record" class="scanner-view"></div></div>
            
            <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
            
            <label>ğŸ” æ¢ç¢¼å‰ 3 ç¢¼æŸ¥è©¢è¨˜éŒ„</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_prefix" inputmode="numeric" maxlength="3" placeholder="å¦‚ 005" style="margin-bottom:0;">
                <button onclick="handlePrefixCheck()" class="btn-blue" style="width:90px; margin-top:0;">æŸ¥è©¢</button>
            </div>
            
            <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
            
            <label>æ‰‹å‹•æ–°å¢è¨˜éŒ„</label>
            <div style="display:flex; gap:10px;">
                <select id="sel_country" style="flex:2;">
                    <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option><option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
                    <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option><option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
                    <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option><option value="ğŸ‡®ğŸ‡© å°å°¼">ğŸ‡®ğŸ‡© å°å°¼</option>
                    <option value="ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº</option><option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
                    <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="å…¶å®ƒ">â“ å…¶å®ƒ</option>
                </select>
                <input type="number" id="inp_qty" value="1" style="flex:1; text-align:center; margin-bottom:0;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="handleManualAdd()" class="btn-green">â• æ–°å¢</button>
                <button onclick="undoRecord()" class="btn-outline">â†©ï¸ å¾©åŸ</button>
            </div>

            <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
            <div style="display:flex;">
                <div style="flex:1; text-align:center;"><div id="css-pie" class="pie-chart"></div></div>
                <div style="flex:1;"><table id="stats-table"><tbody id="stats-body"></tbody></table></div>
            </div>
        </div>

        <h2>ğŸš€ 5. æˆæœä¸Šå‚³</h2>
        <div class="card">
            <label>ç‰¹æ®Šï¼ç†±é»ç…§ (æœ€å¤š3å¼µ)</label>
            <div class="img-preview-box">
                <input type="file" id="file-hotspot1" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'hotspot1')">
                <div class="preview-item" onclick="document.getElementById('file-hotspot1').click()">
                    <img id="img-preview-hotspot1" src="" style="display:none">
                    <span id="icon-hotspot1" class="preview-icon">1</span><div class="preview-label">ç…§ç‰‡ 1</div>
                </div>
                <input type="file" id="file-hotspot2" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'hotspot2')">
                <div class="preview-item" onclick="document.getElementById('file-hotspot2').click()">
                    <img id="img-preview-hotspot2" src="" style="display:none">
                    <span id="icon-hotspot2" class="preview-icon">2</span><div class="preview-label">ç…§ç‰‡ 2</div>
                </div>
                <input type="file" id="file-hotspot3" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'hotspot3')">
                <div class="preview-item" onclick="document.getElementById('file-hotspot3').click()">
                    <img id="img-preview-hotspot3" src="" style="display:none">
                    <span id="icon-hotspot3" class="preview-icon">3</span><div class="preview-label">ç…§ç‰‡ 3</div>
                </div>
            </div>

            <label style="margin-top:15px;">å…¶ä»–è¨˜éŒ„</label>
            <textarea id="inp_note" rows="3" placeholder="è«‹å¡«å¯«ä»»ä½•å€¼å¾—è¨˜éŒ„çš„è§€å¯Ÿ..."></textarea>
            
            <button id="btn-upload" onclick="uploadData()" class="btn-upload" style="margin-top:20px;">ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯</button>
        </div>
    </div>

    <div id="view-ai" class="container">
        <h2>ğŸ¤– AI é‘‘å®šå®¤</h2>
        <div class="card" style="text-align:center;">
            <p style="color:#666;">æ‹ä¸€å¼µï¼ŒAI å¹«ä½ åˆ†é¡ï¼</p>
            <button id="btn-ai-start" onclick="startAiCamera()" class="btn-blue">ğŸ“· å•Ÿå‹• AI ç›¸æ©Ÿ</button>
            <div id="camera-box-ai" class="camera-box">
                <div id="reader-ai" class="scanner-view"></div><div onclick="takeAiSnapshot()" class="btn-snap-div">ğŸ“¸</div>
            </div>
            <div id="ai-result-box" class="ai-result-box">
                <img id="ai-preview-img" style="width:140px; height:140px; object-fit:cover; border-radius:12px; border:3px solid white; box-shadow:0 4px 8px rgba(0,0,0,0.15);">
                <h3 style="color:#00695c; margin:15px 0 8px;">AI èªç‚ºæ˜¯ï¼š</h3>
                <select id="ai-country-select" style="font-size:18px; font-weight:bold; color:#333; padding:10px; border:2px solid #00695c;"></select>
                <p style="font-size:14px; color:#546e7a; background:white; padding:8px; border-radius:8px; margin-top:10px;">ç‰¹å¾µï¼š<span id="ai-desc-text"></span></p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button id="btn-google-check" class="btn-outline" style="font-size:14px;">ğŸ” Google æŸ¥è­‰</button>
                    <button id="btn-confirm-ai" class="btn-green">âœ… ç¢ºèªåŠ å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-basic" onclick="switchTab('basic')"><span>ğŸ“</span>åŸºæœ¬</div>
        <div class="nav-item" id="nav-record" onclick="switchTab('record')"><span>ğŸ“Š</span>è¨˜éŒ„</div>
        <div class="nav-item" id="nav-ai" onclick="switchTab('ai')"><span>ğŸ¤–</span>AI é‘‘å®š</div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // V76 State: æ”¯æ´5å¼µåœ–
        const STATE = { count: 0, target: 100, stats: {}, historyStack: [], currentCity: "æœªå®šä½", imgs: { env: null, group: null, hotspot1: null, hotspot2: null, hotspot3: null }, scanners: { record: null, ai: null } };
        const GS1_RANGES = [ { s: 0, e: 19, c: "ğŸ‡ºğŸ‡¸ ç¾åœ‹" }, { s: 30, e: 39, c: "ğŸ‡ºğŸ‡¸ ç¾åœ‹" }, { s: 60, e: 139, c: "ğŸ‡ºğŸ‡¸ ç¾åœ‹" }, { s: 754, e: 755, c: "ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§" }, { s: 750, e: 750, c: "ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥" }, { s: 300, e: 379, c: "ğŸ‡«ğŸ‡· æ³•åœ‹" }, { s: 400, e: 440, c: "ğŸ‡©ğŸ‡ª å¾·åœ‹" }, { s: 500, e: 509, c: "ğŸ‡¬ğŸ‡§ è‹±åœ‹" }, { s: 800, e: 839, c: "ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©" }, { s: 840, e: 849, c: "ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™" }, { s: 460, e: 469, c: "ğŸ‡·ğŸ‡º ä¿„ç¾…æ–¯" }, { s: 540, e: 549, c: "ğŸ‡§ğŸ‡ª æ¯”åˆ©æ™‚" }, { s: 570, e: 579, c: "ğŸ‡©ğŸ‡° ä¸¹éº¥" }, { s: 590, e: 590, c: "ğŸ‡µğŸ‡± æ³¢è˜­" }, { s: 599, e: 599, c: "ğŸ‡­ğŸ‡º åŒˆç‰™åˆ©" }, { s: 640, e: 649, c: "ğŸ‡«ğŸ‡® èŠ¬è˜­" }, { s: 700, e: 709, c: "ğŸ‡³ğŸ‡´ æŒªå¨" }, { s: 730, e: 739, c: "ğŸ‡¸ğŸ‡ª ç‘å…¸" }, { s: 760, e: 769, c: "ğŸ‡¨ğŸ‡­ ç‘å£«" }, { s: 870, e: 879, c: "ğŸ‡³ğŸ‡± è·è˜­" }, { s: 900, e: 919, c: "ğŸ‡¦ğŸ‡¹ å¥§åœ°åˆ©" }, { s: 560, e: 560, c: "ğŸ‡µğŸ‡¹ è‘¡è„ç‰™" }, { s: 520, e: 521, c: "ğŸ‡¬ğŸ‡· å¸Œè‡˜" }, { s: 539, e: 539, c: "ğŸ‡®ğŸ‡ª æ„›çˆ¾è˜­" }, { s: 859, e: 859, c: "ğŸ‡¨ğŸ‡¿ æ·å…‹" }, { s: 868, e: 869, c: "ğŸ‡¹ğŸ‡· åœŸè€³å…¶" }, { s: 450, e: 459, c: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬" }, { s: 490, e: 499, c: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬" }, { s: 471, e: 471, c: "ğŸ‡¹ğŸ‡¼ å°ç£" }, { s: 690, e: 699, c: "ğŸ‡¨ğŸ‡³ ä¸­åœ‹" }, { s: 489, e: 489, c: "ğŸ‡­ğŸ‡° é¦™æ¸¯" }, { s: 958, e: 958, c: "ğŸ‡²ğŸ‡´ æ¾³é–€" }, { s: 880, e: 880, c: "ğŸ‡°ğŸ‡· éŸ“åœ‹" }, { s: 885, e: 885, c: "ğŸ‡¹ğŸ‡­ æ³°åœ‹" }, { s: 893, e: 893, c: "ğŸ‡»ğŸ‡³ è¶Šå—" }, { s: 480, e: 480, c: "ğŸ‡µğŸ‡­ è²å¾‹è³“" }, { s: 899, e: 899, c: "ğŸ‡®ğŸ‡© å°å°¼" }, { s: 955, e: 955, c: "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº" }, { s: 888, e: 888, c: "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡" }, { s: 890, e: 890, c: "ğŸ‡®ğŸ‡³ å°åº¦" }, { s: 884, e: 884, c: "ğŸ‡°ğŸ‡­ æŸ¬åŸ”å¯¨" }, { s: 883, e: 883, c: "ğŸ‡²ğŸ‡² ç·¬ç”¸" }, { s: 896, e: 896, c: "ğŸ‡µğŸ‡° å·´åŸºæ–¯å¦" }, { s: 930, e: 939, c: "ğŸ‡¦ğŸ‡º æ¾³æ´²" }, { s: 940, e: 949, c: "ğŸ‡³ğŸ‡¿ ç´è¥¿è˜­" }, { s: 600, e: 601, c: "ğŸ‡¿ğŸ‡¦ å—é" }, { s: 615, e: 615, c: "ğŸ‡³ğŸ‡¬ å¥ˆåŠåˆ©äº" }, { s: 789, e: 790, c: "ğŸ‡§ğŸ‡· å·´è¥¿" }, { s: 779, e: 779, c: "ğŸ‡¦ğŸ‡· é˜¿æ ¹å»·" }, { s: 780, e: 780, c: "ğŸ‡¨ğŸ‡± æ™ºåˆ©" } ];
        const PREFIX_DB = {}; GS1_RANGES.forEach(r => { for (let i = r.s; i <= r.e; i++) PREFIX_DB[i.toString().padStart(3, '0')] = r.c; });
        const COLORS = { 'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº': '#8d6e63', 'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#ff9800', 'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#212121', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#fbc02d', 'ğŸ‡ºğŸ‡¸ ç¾åœ‹': '#3f51b5', 'ğŸ‡¦ğŸ‡º æ¾³æ´²': '#009688', 'ğŸ‡©ğŸ‡ª å¾·åœ‹': '#000000', 'å…¶å®ƒ': '#757575' };
        
        // âš ï¸ GAS URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1kiaaRdWuUtBEBnjG-HuTqedenqisFug4zQ6pyCWXrT0Ja7TF4RCAicTA1Q3u8TA9/exec";

        window.onload = () => { 
            if (navigator.userAgent.match(/Line/i)) {
                document.getElementById('line-warning').style.display = 'flex';
                document.getElementById('loading-mask').style.display = 'none';
                return;
            }
            setTimeout(() => { document.getElementById('loading-mask').style.display = 'none'; switchTab('basic'); }, 800); 
        };

        // è¨ˆæ™‚å™¨ (V75 é¬§é˜é‚è¼¯)
        const timers = { 10: { total: 600, left: 600, interval: null, running: false }, 20: { total: 1200, left: 1200, interval: null, running: false } };
        let vibrationInterval;

        function toggleTimer(min) {
            let t = timers[min]; let box = document.getElementById(`timer-${min}`);
            if (t.running) { clearInterval(t.interval); t.running = false; box.classList.remove('running'); }
            else {
                if (t.left <= 0) t.left = t.total;
                box.classList.remove('done'); box.classList.add('running'); t.running = true;
                t.interval = setInterval(() => {
                    t.left--; updateTimerDisplay(min);
                    if (t.left <= 0) { 
                        clearInterval(t.interval); t.running = false; 
                        box.classList.remove('running'); box.classList.add('done'); 
                        triggerAlarm(); 
                    }
                }, 1000);
            }
        }
        function updateTimerDisplay(min) {
            let sec = timers[min].left; let m = Math.floor(sec / 60).toString().padStart(2, '0'); let s = (sec % 60).toString().padStart(2, '0');
            document.getElementById(`time-display-${min}`).innerText = `${m}:${s}`;
        }
        function triggerAlarm() {
            let utterance = new SpeechSynthesisUtterance("æ™‚é–“åˆ°ï¼Œè«‹çµæŸèª¿æŸ¥"); window.speechSynthesis.speak(utterance);
            document.getElementById('alarm-modal').style.display = 'flex';
            if(navigator.vibrate) { navigator.vibrate([500, 200, 500]); vibrationInterval = setInterval(() => { navigator.vibrate([500, 200, 500]); }, 1500); }
        }
        function stopAlarm() {
            document.getElementById('alarm-modal').style.display = 'none';
            if(vibrationInterval) clearInterval(vibrationInterval);
            if(navigator.vibrate) navigator.vibrate(0);
        }

        // æ¨™æº–åŠŸèƒ½
        function normalizeName(rawName) {
            if (!rawName) return "å…¶å®ƒ"; let clean = rawName.toString().trim();
            if (clean.includes("å°ç£") || clean.includes("Taiwan")) return "ğŸ‡¹ğŸ‡¼ å°ç£";
            if (clean.includes("ä¸­åœ‹") || clean.includes("China") || clean.includes("CN") || clean.includes("å¤§é™¸")) return "ğŸ‡¨ğŸ‡³ ä¸­åœ‹";
            if (clean.includes("è¶Šå—") || clean.includes("Vietnam")) return "ğŸ‡»ğŸ‡³ è¶Šå—";
            if (clean.includes("è²å¾‹è³“") || clean.includes("Philippines")) return "ğŸ‡µğŸ‡­ è²å¾‹è³“";
            if (clean.includes("æ³°åœ‹") || clean.includes("Thailand")) return "ğŸ‡¹ğŸ‡­ æ³°åœ‹";
            if (clean.includes("å°å°¼") || clean.includes("Indonesia")) return "ğŸ‡®ğŸ‡© å°å°¼";
            if (clean.includes("é¦¬ä¾†è¥¿äº")) return "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº";
            if (clean.includes("éŸ“åœ‹") || clean.includes("Korea")) return "ğŸ‡°ğŸ‡· éŸ“åœ‹";
            if (clean.includes("æ—¥æœ¬") || clean.includes("Japan")) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬";
            for (let code in PREFIX_DB) { if (PREFIX_DB[code] === clean) return clean; }
            if (Object.keys(COLORS).includes(clean)) return clean; return "å…¶å®ƒ";
        }
        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active-tab');
            document.getElementById('nav-' + tabName).classList.add('active');
            stopRecordScanner(); stopAiScanner();
        }
        function handleImgUpload(input, type) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0]; const reader = new FileReader();
            reader.onload = function(e) {
                const imgId = `img-preview-${type}`;
                const imgEl = document.getElementById(imgId);
                imgEl.src = e.target.result; imgEl.style.display = 'block';
                // éš±è—åœ–ç¤º
                const icon = document.getElementById(`icon-${type}`);
                if(icon) icon.style.display = 'none';

                const temp = new Image(); temp.src = e.target.result;
                temp.onload = function() {
                    const cvs = document.createElement('canvas');
                    let s = 1024 / temp.width; if (s > 1) s = 1;
                    cvs.width = temp.width * s; cvs.height = temp.height * s;
                    cvs.getContext('2d').drawImage(temp, 0, 0, cvs.width, cvs.height);
                    STATE.imgs[type] = cvs.toDataURL('image/jpeg', 0.7).split(',')[1];
                }
            };
            reader.readAsDataURL(file);
        }
        function takeAiSnapshot() {
            var videoEl = document.querySelector("#reader-ai video"); if (!videoEl) { alert("ç›¸æ©Ÿæœªå•Ÿå‹•"); return; }
            videoEl.pause(); document.getElementById('loading-mask').style.display = 'flex';
            var cvs = document.createElement("canvas"); var max = 800; var w = videoEl.videoWidth; var h = videoEl.videoHeight;
            var s = (w>h ? (w>max?max/w:1) : (h>max?max/h:1)); cvs.width = w*s; cvs.height = h*s;
            cvs.getContext("2d").drawImage(videoEl, 0, 0, cvs.width, cvs.height);
            var b64Full = cvs.toDataURL("image/jpeg", 0.6); stopAiScanner();
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "identify", image: b64Full.split(',')[1] }) })
            .then(res => res.json()).then(data => {
                document.getElementById('loading-mask').style.display = 'none';
                if (data.status === "success") {
                    try {
                        var raw = typeof data.result === 'string' ? data.result : JSON.stringify(data.result);
                        var match = raw.match(/\{[\s\S]*\}/);
                        if (match) displayAiResult(JSON.parse(match[0]), b64Full); else alert("AI æ ¼å¼éŒ¯èª¤: " + raw);
                    } catch(e) { alert("è§£æå¤±æ•—: " + e.message); }
                } else { alert("å¾Œç«¯éŒ¯èª¤: " + data.message); }
            }).catch(err => { document.getElementById('loading-mask').style.display = 'none'; alert("é€£ç·šå¤±æ•—: " + err); });
        }
        function displayAiResult(data, imgSrc) {
            const box = document.getElementById('ai-result-box'); box.style.display = 'block';
            document.getElementById('ai-preview-img').src = imgSrc; document.getElementById('ai-desc-text').innerText = data.keywords || "ç„¡ç‰¹å¾µ";
            const select = document.getElementById('ai-country-select'); select.innerHTML = "";
            let aiGuess = normalizeName(data.country); 
            if (aiGuess !== "å…¶å®ƒ") { select.add(new Option(`ğŸ¤– AI: ${aiGuess}`, aiGuess, true, true)); select.add(new Option("---", "disabled", false, false)); }
            for (let c of Object.keys(COLORS)) { if (c !== aiGuess) select.add(new Option(c, c)); }
            if (aiGuess === "å…¶å®ƒ") select.value = "å…¶å®ƒ";
            const query = `${data.country || ""} ${data.keywords || ""} bottle`.trim();
            document.getElementById('btn-google-check').onclick = () => window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank');
            document.getElementById('btn-confirm-ai').onclick = () => { if (select.value === "disabled") return; addRecord(select.value, 1); box.style.display = 'none'; switchTab('record'); };
        }
        function handlePrefixCheck() {
            const code = document.getElementById('inp_prefix').value; if (!code || code.length < 3) { alert("è«‹è¼¸å…¥è‡³å°‘ 3 ç¢¼"); return; }
            const prefix = code.substring(0, 3); const country = PREFIX_DB[prefix];
            if (country) { if(confirm(`ğŸ” æŸ¥è©¢çµæœï¼š${country}\n\nè¦åŠ å…¥è¨˜éŒ„å—ï¼Ÿ`)) { addRecord(country, 1); document.getElementById('inp_prefix').value = ""; } } else { alert(`âŒ æŸ¥ç„¡ä»£ç¢¼ [${prefix}] çš„æ­¸å±¬åœ°`); }
        }
        function addRecord(country, qty) { let safeName = normalizeName(country); if (!STATE.stats[safeName]) STATE.stats[safeName] = 0; STATE.stats[safeName] += qty; STATE.count += qty; for(let i=0; i<qty; i++) STATE.historyStack.push({key: safeName, qty: 1}); updateUI(); }
        function undoRecord() { if (STATE.historyStack.length === 0) return; const last = STATE.historyStack.pop(); STATE.stats[last.key] -= last.qty; if (STATE.stats[last.key] <= 0) delete STATE.stats[last.key]; STATE.count -= last.qty; updateUI(); }
        function handleManualAdd() { addRecord(document.getElementById('sel_country').value, parseInt(document.getElementById('inp_qty').value)); }
        
        function updateUI() {
            document.getElementById('disp_count').innerText = STATE.count; const tbody = document.getElementById('stats-body'); tbody.innerHTML = ""; let grad = [], deg = 0;
            if (STATE.count === 0) { document.getElementById('css-pie').style.background = "transparent"; document.getElementById('css-pie').style.border = "2px dashed #ddd"; return; }
            else { document.getElementById('css-pie').style.border = "4px solid #fff"; }
            for (const [key, val] of Object.entries(STATE.stats)) {
                const color = COLORS[key] || '#757575'; const pct = ((val / STATE.count) * 100).toFixed(1);
                tbody.innerHTML += `<tr><td><span style='color:${color}'>â– </span> ${key} <small>(${pct}%)</small></td><td>${val}</td></tr>`;
                const d = (val / STATE.count) * 360; grad.push(`${color} ${deg}deg ${deg + d}deg`); deg += d;
            }
            document.getElementById('css-pie').style.background = `conic-gradient(${grad.join(", ")})`;
        }

        // Upload V76
        function uploadData() {
            if (STATE.count === 0) { alert("ç„¡è³‡æ–™"); return; }
            if (!document.getElementById('inp_name').value) { alert("è«‹å¡«å¯«å§“å"); switchTab('basic'); return; }
            if (!document.getElementById('inp_phone').value) { alert("è«‹å¡«å¯«è¯çµ¡æ‰‹æ©Ÿ"); switchTab('basic'); return; }
            if (!document.getElementById('inp_participants').value) { alert("è«‹å¡«å¯«åƒèˆ‡äººæ•¸"); switchTab('basic'); return; }
            var btn = document.getElementById('btn-upload'); btn.innerText = "â³ ä¸Šå‚³ä¸­..."; btn.disabled = true;
            let statsOut = { cnt_tw:0, cnt_cn:0, cnt_vn:0, cnt_ph:0, cnt_my:0, cnt_id:0, cnt_th:0, cnt_kr:0, cnt_jp:0, cnt_other:"" }; let others = [];
            for(let k in STATE.stats) {
                if(k.includes("å°ç£")) statsOut.cnt_tw += STATE.stats[k]; else if(k.includes("ä¸­åœ‹")) statsOut.cnt_cn += STATE.stats[k]; else if(k.includes("è¶Šå—")) statsOut.cnt_vn += STATE.stats[k];
                else if(k.includes("è²å¾‹è³“")) statsOut.cnt_ph += STATE.stats[k]; else if(k.includes("æ³°åœ‹")) statsOut.cnt_th += STATE.stats[k]; else if(k.includes("å°å°¼")) statsOut.cnt_id += STATE.stats[k];
                else if(k.includes("é¦¬ä¾†è¥¿äº")) statsOut.cnt_my += STATE.stats[k]; else if(k.includes("éŸ“åœ‹")) statsOut.cnt_kr += STATE.stats[k]; else if(k.includes("æ—¥æœ¬")) statsOut.cnt_jp += STATE.stats[k];
                else others.push(`${k}*${STATE.stats[k]}`);
            }
            statsOut.cnt_other = others.join(", ");
            var payload = {
                action: "save", name: document.getElementById('inp_name').value, phone: document.getElementById('inp_phone').value, participants: document.getElementById('inp_participants').value,
                city: document.getElementById('inp_city').value, surveyPoint: document.getElementById('inp_point').value, gps: document.getElementById('inp_gps').value,
                total: STATE.count, note: document.getElementById('inp_note').value, 
                // V76: 5å¼µåœ–
                hotspotData1: STATE.imgs.hotspot1 || "", hotspotData2: STATE.imgs.hotspot2 || "", hotspotData3: STATE.imgs.hotspot3 || "",
                envData: STATE.imgs.env || "", groupData: STATE.imgs.group || "", 
                ...statsOut
            };
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => {
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼"); STATE.count=0; STATE.stats={}; STATE.historyStack=[]; 
                STATE.imgs = { env: null, group: null, hotspot1: null, hotspot2: null, hotspot3: null };
                // Reset all images
                ['env', 'group', 'hotspot1', 'hotspot2', 'hotspot3'].forEach(k => {
                    document.getElementById(`img-preview-${k}`).style.display='none';
                    if(document.getElementById(`icon-${k}`)) document.getElementById(`icon-${k}`).style.display='block';
                });
                document.getElementById('inp_note').value = ""; updateUI(); switchTab('basic');
            }).catch(err => alert("ä¸Šå‚³å¤±æ•—: " + err)).finally(() => { btn.innerText = "ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯"; btn.disabled = false; });
        }
        function runGPS() {
            document.getElementById('inp_gps').value="å®šä½ä¸­...";
            navigator.geolocation.getCurrentPosition(p=>{
                document.getElementById('inp_gps').value=`${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&localityLanguage=zh`).then(r=>r.json()).then(d=>{
                    let city = (d.principalSubdivision || "").replace("Province", "").trim(); let town = (d.locality || "").trim();
                    STATE.currentCity = `${city} ${town}`; document.getElementById('inp_city').value=STATE.currentCity;
                });
            }, ()=>{alert("å®šä½å¤±æ•—"); document.getElementById('inp_gps').value="";});
        }
        function startRecordScanner() { if (STATE.scanners.record) return; document.getElementById('camera-box-record').style.display = 'block'; document.getElementById('btn-scan-start').style.display = 'none'; document.getElementById('btn-scan-stop').style.display = 'inline-block'; STATE.scanners.record = new Html5Qrcode("reader-record"); STATE.scanners.record.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { STATE.scanners.record.pause(); const c = getCountryFromCode(txt); if(confirm(`æƒæï¼š${c}\nåŠ å…¥å—ï¼Ÿ`)) { addRecord(c, 1); } setTimeout(()=>STATE.scanners.record.resume(), 500); }, ()=>{} ); }
        function stopRecordScanner() { if(STATE.scanners.record) STATE.scanners.record.stop().then(()=>{STATE.scanners.record.clear(); STATE.scanners.record=null;}).catch(()=>{}); document.getElementById('camera-box-record').style.display='none'; document.getElementById('btn-scan-start').style.display='inline-block'; document.getElementById('btn-scan-stop').style.display='none'; }
        function startAiCamera() { document.getElementById('ai-result-box').style.display='none'; document.getElementById('camera-box-ai').style.display='block'; document.getElementById('btn-ai-start').style.display='none'; STATE.scanners.ai = new Html5Qrcode("reader-ai"); STATE.scanners.ai.start({ facingMode: "environment" }, { fps: 10 }, ()=>{}, ()=>{}); }
        function stopAiScanner() { if(STATE.scanners.ai) STATE.scanners.ai.stop().then(()=>{STATE.scanners.ai.clear(); STATE.scanners.ai=null;}).catch(()=>{}); document.getElementById('camera-box-ai').style.display='none'; document.getElementById('btn-ai-start').style.display='inline-block'; }
        function getCountryFromCode(code) { return (code && code.length>=3) ? (PREFIX_DB[code.substring(0,3)]||"æœªçŸ¥") : "æœªçŸ¥"; }
    </script>
</body>
</html>
