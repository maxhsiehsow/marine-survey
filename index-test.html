<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è’é‡ç“¶ç½èª¿æŸ¥å›å ±ç«™ V96</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #587a30; --primary-dark: #3e5c20; --bg: #f4f7f4; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; padding-top: 40px; color: var(--text); -webkit-font-smoothing: antialiased; }
        #network-status { position: fixed; top: 0; left: 0; width: 100%; height: 35px; line-height: 35px; text-align: center; color: white; font-size: 13px; font-weight: bold; z-index: 9000; transition: background 0.3s; }
        .status-online { background: #689f38; } .status-offline { background: #d32f2f; }
        #offline-sync-box { display: none; margin-bottom: 15px; background: #fff3e0; padding: 15px; border-radius: 12px; border: 2px solid #ff9800; text-align: center; animation: fadeIn 0.5s; }
        #btn-sync { background: #ff9800; width: 100%; margin-top: 5px; animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #line-warning { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; color: white; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .arrow-icon { font-size: 40px; animation: bounce 1.5s infinite; margin-bottom: 20px; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(4px); animation: fadeIn 0.2s; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 340px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); animation: popUp 0.3s forwards; }
        @keyframes popUp { to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-icon { font-size: 50px; margin-bottom: 15px; display: block; }
        .modal-title { font-size: 22px; font-weight: 800; margin-bottom: 10px; color: #333; }
        .modal-msg { font-size: 16px; color: #666; margin-bottom: 25px; line-height: 1.5; }
        .big-result-text { font-size: 32px; font-weight: 900; color: var(--primary); margin: 15px 0; display: block; background: #e8f5e9; padding: 10px; border-radius: 12px; border: 2px solid var(--primary); }
        .modal-btns { display: flex; gap: 15px; justify-content: center; }
        .modal-btns button { flex: 1; padding: 15px; font-size: 18px; margin: 0; border-radius: 12px; }
        .style-warning .modal-title { color: #f57c00; } .style-warning { border-top: 8px solid #f57c00; }
        .style-success .modal-title { color: var(--primary); } .style-success { border-top: 8px solid var(--primary); }
        .style-alarm .modal-title { color: #d32f2f; } .style-alarm { border-top: 8px solid #d32f2f; animation: shake 0.5s infinite; }
        .style-offline .modal-title { color: #607d8b; } .style-offline { border-top: 8px solid #607d8b; }
        #map-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 11000; flex-direction: column; }
        #map-header { height: 50px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 11001; }
        #map-container { flex: 1; width: 100%; z-index: 10000; }
        #map-footer { height: auto; min-height: 120px; background: white; border-top: 1px solid #ddd; padding: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 11001; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .point-item { padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .point-item.selected { border: 2px solid var(--primary); background: #f1f8e9; }
        .point-dist { font-size: 12px; color: var(--primary); background: #e8f5e9; padding: 4px 8px; border-radius: 12px; font-weight: bold; }
        .container { padding: 16px; display: none; animation: fadeIn 0.4s ease-out; max-width: 600px; margin: 0 auto; }
        .active-tab { display: block; }
        .app-title { text-align: center; color: var(--primary); font-size: 26px; margin: 15px 0 25px; font-weight: 900; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--primary); font-size: 18px; border-left: 5px solid var(--primary); padding-left: 10px; margin-bottom: 15px; font-weight: 700; letter-spacing: 0.5px; }
        label { display: block; margin: 12px 0 6px; font-weight: 600; font-size: 15px; color: #444; }
        .required::after { content: " *"; color: #e53935; }
        input, select, textarea { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; background: #fafafa; transition: border 0.2s, background 0.2s; appearance: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #fff; outline: none; }
        input[readonly].locked-field { background: #e0e0e0; color: #555; border-color: #bdbdbd; cursor: not-allowed; }
        input[readonly] { color: var(--primary); font-weight: bold; background: #f1f8e9; }
        #ai-country-select { font-size: 24px; font-weight: 800; color: #333; padding: 15px; border: 3px solid var(--primary); border-radius: 12px; height: auto; background: #fff; }
        button, .btn { width: 100%; padding: 14px; font-size: 16px; font-weight: 600; margin-top: 12px; cursor: pointer; color: white; border: none; border-radius: 10px; text-align: center; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.98); }
        .btn-blue { background: #0288d1; } .btn-green { background: var(--primary); } .btn-red { background: #d32f2f; } .btn-orange { background: #f57c00; } .btn-upload { background: var(--primary-dark); } .btn-grey { background: #90a4ae; color: white; } .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); box-shadow: none; }
        .btn-disabled { background: #cfd8dc !important; color: #90a4ae !important; cursor: not-allowed !important; pointer-events: none; }
        .img-preview-box { display: flex; gap: 10px; margin-top: 8px; overflow-x: auto; padding-bottom: 5px; }
        .preview-item { width: 85px; height: 85px; background: #f5f5f5; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative; border: 2px dashed #ccc; flex-shrink: 0; cursor: pointer; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-label { font-size: 10px; margin-top: 4px; color: #666; font-weight: bold; }
        .preview-icon { font-size: 24px; color: #999; }
        .photo-warning { color: #d32f2f; font-size: 13px; font-weight: bold; margin-top: 5px; display: none; background: #ffebee; padding: 8px; border-radius: 6px; border: 1px dashed #ef5350; }
        .timer-container { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
        .timer-box { width: 110px; height: 110px; border-radius: 50%; background: white; border: 6px solid #eceff1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; box-shadow: 0 6px 10px rgba(0,0,0,0.05); transition: all 0.3s; }
        .timer-box.running { border-color: #ffb74d; animation: pulse 1.5s infinite; }
        .timer-box.done { border-color: #ef5350; background: #ffebee; }
        .timer-time { font-size: 26px; font-weight: 800; color: #455a64; font-variant-numeric: tabular-nums; }
        .timer-label { font-size: 12px; color: #90a4ae; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.03); }
        .nav-item { flex: 1; text-align: center; font-size: 11px; color: #b0bec5; padding-top: 5px; cursor: pointer; transition: color 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { display: block; font-size: 24px; margin-bottom: 2px; }
        .footer-credit { text-align: center; font-size: 13px; color: #90a4ae; margin-top: 30px; padding-bottom: 20px; line-height: 1.6; border-top: 1px dashed #cfd8dc; padding-top: 15px; }
        .footer-credit a { color: var(--primary); text-decoration: none; font-weight: bold; }
        .camera-box { position: relative; display: none; background: #000; border-radius: 16px; overflow: hidden; margin-top: 15px; }
        .scanner-view { width: 100%; min-height: 300px; }
        .btn-snap-div { width: 72px; height: 72px; background: rgba(255,255,255,0.95); border-radius: 50%; border: 4px solid var(--primary); display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 0 auto; position: absolute; bottom: 25px; left: 0; right: 0; z-index: 10; font-size: 32px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .ai-result-box { display: none; border: 2px solid var(--primary); background: #e8f5e9; padding: 20px; border-radius: 16px; margin-top: 15px; text-align: center; }
        #loading-mask { display: flex; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); flex-direction:column; justify-content:center; align-items:center; z-index:9999; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 5px solid #eceff1; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pie-chart { width: 130px; height: 130px; border-radius: 50%; margin: 10px auto; transition: all 0.3s; border: 2px dashed #ddd; background: transparent; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 10px 5px; }
    </style>
</head>
<body>
    <div id="map-modal">
        <div id="map-header">
            <div style="font-weight:bold; font-size:18px;">èª¿æŸ¥å°èˆªåŠ©ç†</div>
            <button onclick="closeMap()" style="background:transparent; border:none; color:white; font-size:24px; padding:0; width:auto; margin:0;">âœ•</button>
        </div>
        <div id="map-container"></div>
        <div id="map-footer">
            <div style="display:flex; gap:10px;">
                <button id="btn-toggle-map" class="btn-outline" onclick="toggleMapMode()" style="flex:1; margin:0; font-size:14px;">ğŸ—ºï¸ é¡¯ç¤ºå…¨å°</button>
                <button id="btn-nav-go" class="btn-blue" disabled onclick="navigateToSelected()" style="flex:1; margin:0;">ğŸš— é¸æ“‡æ­¤æ¨£é»</button>
            </div>
            <div id="map-list" style="overflow-y:auto; max-height:150px; margin-top:10px;">
                <div style="color:#999; text-align:center; padding:10px;">æ­£åœ¨å®šä½ä¸­...</div>
            </div>
        </div>
    </div>
    <div id="network-status" class="status-online">ğŸŸ¢ ç³»çµ±é€£ç·šä¸­</div>
    <div id="line-warning">
        <div class="arrow-icon">â†—ï¸</div>
        <h1>è«‹é»æ“Šå³ä¸Šè§’<br>ä½¿ç”¨å…¶ä»–ç€è¦½å™¨é–‹å•Ÿ</h1>
        <p>LINE å…§å»ºç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿèˆ‡å®šä½åŠŸèƒ½ã€‚<br>è«‹åˆ‡æ›è‡³ Chrome (Android) æˆ– Safari (iOS)ã€‚</p>
    </div>
    <div id="custom-modal" class="modal-overlay">
        <div id="modal-content-box" class="modal-content">
            <span id="modal-icon" class="modal-icon">âš ï¸</span>
            <div id="modal-title" class="modal-title">æç¤º</div>
            <p id="modal-msg" class="modal-msg">å…§å®¹</p>
            <div id="modal-btns" class="modal-btns">
                <button id="btn-modal-cancel" class="btn-grey">å–æ¶ˆ</button>
                <button id="btn-modal-confirm" class="btn-green">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <div id="loading-mask"><div class="spinner"></div><p id="loading-text" style="margin-top:15px; color:#555; font-weight:bold;">ç³»çµ±è¼‰å…¥ä¸­...</p></div>

    <div id="view-basic" class="container active-tab">
        <h1 class="app-title">è’é‡ç“¶ç½èª¿æŸ¥å›å ±ç«™</h1>
        <div id="offline-sync-box">
            <div style="font-weight:bold; color:#e65100;">âš ï¸ æ‚¨æœ‰ <span id="offline-count">0</span> ç­†è³‡æ–™å°šæœªä¸Šå‚³</div>
            <div style="font-size:12px; color:#666; margin:5px 0;">å·²åµæ¸¬åˆ°ç¶²è·¯ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŒæ­¥</div>
            <button id="btn-sync" class="btn" onclick="syncOfflineData()">â˜ï¸ ç«‹å³ä¸Šå‚³æš«å­˜è³‡æ–™ (å«åœ°å€è£œå…¨)</button>
        </div>
        <h2>ğŸ“ 1. åƒèˆ‡äººå“¡è³‡è¨Š</h2>
        <div class="card">
            <label class="required">å¡«è¡¨äººå§“å</label>
            <input type="text" id="inp_name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" onchange="saveState()">
            <label class="required">è¯çµ¡äººæ‰‹æ©Ÿ</label>
            <input type="tel" id="inp_phone" placeholder="09xx-xxx-xxx" onchange="saveState()">
            <label class="required">åƒèˆ‡äººæ•¸</label>
            <input type="number" id="inp_participants" value="1" min="1" style="text-align:center;" onchange="saveState()">
        </div>
        <h2>ğŸ“ 2. èª¿æŸ¥åœ°é»</h2>
        <div class="card">
            <label class="required">ä½ç½®è¨­å®š</label>
            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <button onclick="runGPS()" class="btn-blue" style="margin:0; flex:1;">ğŸ“¡ è‡ªå‹•å®šä½</button>
                <button onclick="openMap()" class="btn-outline" style="margin:0; flex:1;">ğŸ§­ å°‹æ‰¾æ¨£é»</button>
            </div>
            <label>GPS åº§æ¨™</label>
            <input type="text" id="inp_gps" readonly placeholder="å®šä½å¾Œè‡ªå‹•é¡¯ç¤º" style="background:#f5f5f5;">
            <label>èª¿æŸ¥åœ°é»</label>
            <input type="text" id="inp_city" readonly placeholder="ç¸£å¸‚é„‰é®æˆ–æ¨£é»åç¨±">
            <label>èª¿æŸ¥æ¨£é»</label>
            <input type="text" id="inp_point" readonly class="locked-field" placeholder="åƒ…é™å¾åœ°åœ–é¸æ“‡ä»£è™Ÿ">
            <label>ğŸ“¸ ç¾å ´ç…§ç‰‡ä¸Šå‚³</label>
            <div id="photo-warning-env" class="photo-warning">âš ï¸ ç³»çµ±å‰›å¾ä¼‘çœ ä¸­æ¢å¾©ï¼Œç…§ç‰‡å·²é‡ç½®ï¼Œè«‹é‡æ–°æ‹æ”ã€‚</div>
            <div class="img-preview-box">
                <input type="file" id="file-env" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'env')">
                <input type="file" id="file-group" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'group')">
                <div class="preview-item" onclick="document.getElementById('file-env').click()">
                    <img id="img-preview-env" src="" style="display:none">
                    <span id="icon-env" class="preview-icon">ğŸï¸</span><div class="preview-label">ç’°å¢ƒç…§</div>
                </div>
                <div class="preview-item" onclick="document.getElementById('file-group').click()">
                    <img id="img-preview-group" src="" style="display:none">
                    <span id="icon-group" class="preview-icon">ğŸ‘¥</span><div class="preview-label">åˆç…§</div>
                </div>
            </div>
            <div style="margin-top:20px; border-top:1px dashed #ddd; padding-top:15px;">
                <label style="color:#d32f2f; display:flex; align-items:center; gap:5px;">ğŸš¨ ç™¼ç¾å¤§é‡åƒåœ¾ï¼Ÿ</label>
                <p style="font-size:13px; color:#666; margin:5px 0 10px;">è‹¥ç¾å ´åƒåœ¾é‡è¶…éä¸€å°å°è²¨è»Šçš„é‡ï¼Œè«‹å”åŠ©é€šå ±ã€‚</p>
                <button class="btn-red" onclick="window.open('https://ecolife2.moenv.gov.tw/BeachCleanup/Dirty/Add', '_blank')">ğŸ“¢ å‰å¾€ç’°å¢ƒéƒ¨æµ·å²¸é«’äº‚é€šå ±</button>
            </div>
        </div>
        <h2>â±ï¸ 3. èª¿æŸ¥è¨ˆæ™‚å™¨</h2>
        <div class="card">
            <p style="text-align:center; font-size:13px; color:#78909c; margin:0 0 10px;">è«‹å…è¨±é€šçŸ¥ï¼Œä¸¦å°‡æ‰‹æ©ŸéŸ³é‡é–‹å•Ÿ</p>
            <button id="btn-notify-req" class="btn-outline" onclick="manualRequestNotification()" style="width:100%; margin-bottom:15px; border-style:dashed;">ğŸ”” é»æ­¤é–‹å•Ÿè¨ˆæ™‚é€šçŸ¥ (ç¢ºä¿éŸ¿éˆ´)</button>
            <div class="timer-container">
                <div class="timer-box" id="timer-10" onclick="toggleTimer(10)">
                    <div class="timer-time" id="time-display-10">10:00</div>
                    <div class="timer-label">10 åˆ†é˜</div>
                </div>
                <div class="timer-box" id="timer-20" onclick="toggleTimer(20)">
                    <div class="timer-time" id="time-display-20">20:00</div>
                    <div class="timer-label">20 åˆ†é˜</div>
                </div>
            </div>
        </div>
        <div class="footer-credit">
            ç¶²é è¨­è¨ˆè¦åŠƒï¼šè’é‡ä¿è­·å”æœƒ æ£²åœ°å®ˆè­·éƒ¨é›å­<br>
            è¯çµ¡ä¿¡ç®±ï¼š<a href="mailto:max@wilderness.tw">max@wilderness.tw</a>
        </div>
    </div>

    <div id="view-record" class="container">
        <h2>ğŸ“Š 4. è¨˜éŒ„èˆ‡æˆæœ</h2>
        <div class="card">
            <div style="text-align:center; font-size:16px; color:#666; margin-bottom:5px;">ç›®å‰æ”¶é›†ç¸½æ•¸</div>
            <div style="text-align:center; font-size:42px; font-weight:800; color:var(--primary); margin-bottom:15px; font-family:sans-serif;">
                <span id="disp_count">0</span> <span style="font-size:18px; color:#999; font-weight:normal;">/ 100</span>
            </div>
            <button id="btn-scan-start" onclick="startRecordScanner()" class="btn-orange">ğŸ“· æƒææ¢ç¢¼è¨˜éŒ„</button>
            <button id="btn-scan-stop" onclick="stopRecordScanner()" class="btn-red" style="display:none;">â¹ åœæ­¢æƒæ</button>
            <div id="camera-box-record" class="camera-box"><div id="reader-record" class="scanner-view"></div></div>
            <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
            <label>ğŸ” æ¢ç¢¼å‰ 3 ç¢¼æŸ¥è©¢è¨˜éŒ„</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_prefix" inputmode="numeric" maxlength="3" placeholder="å¦‚ 471" style="margin-bottom:0;">
                <button onclick="handlePrefixCheck()" class="btn-blue" style="width:90px; margin-top:0;">æŸ¥è©¢</button>
            </div>
            <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
            <label>æ‰‹å‹•æ–°å¢è¨˜éŒ„</label>
            <div style="display:flex; gap:10px;">
                <select id="sel_country" style="flex:2;">
                    <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option><option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
                    <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option><option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
                    <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option><option value="ğŸ‡®ğŸ‡© å°å°¼">ğŸ‡®ğŸ‡© å°å°¼</option>
                    <option value="ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº</option><option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
                    <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option><option value="å…¶å®ƒ">â“ å…¶å®ƒ</option>
                </select>
                <input type="number" id="inp_qty" value="1" style="flex:1; text-align:center; margin-bottom:0;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="handleManualAdd()" class="btn-green">â• æ–°å¢</button>
                <button onclick="undoRecord()" class="btn-outline">â†©ï¸ å¾©åŸ</button>
            </div>
            <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
            <div style="display:flex;">
                <div style="flex:1; text-align:center;"><div id="css-pie" class="pie-chart"></div></div>
                <div style="flex:1;"><table id="stats-table"><tbody id="stats-body"></tbody></table></div>
            </div>
        </div>
        <h2>ğŸš€ 5. æˆæœä¸Šå‚³</h2>
        <div class="card">
            <label>ç‰¹æ®Šï¼ç†±é»ç…§ (æœ€å¤š3å¼µ)</label>
            <div id="photo-warning-hotspot" class="photo-warning">âš ï¸ ç³»çµ±å‰›å¾ä¼‘çœ ä¸­æ¢å¾©ï¼Œç…§ç‰‡å·²é‡ç½®ï¼Œè«‹é‡æ–°æ‹æ”ã€‚</div>
            <div class="img-preview-box">
                <input type="file" id="file-hotspot1" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'hotspot1')">
                <div class="preview-item" onclick="document.getElementById('file-hotspot1').click()">
                    <img id="img-preview-hotspot1" src="" style="display:none">
                    <span id="icon-hotspot1" class="preview-icon">1</span><div class="preview-label">ç…§ç‰‡ 1</div>
                </div>
                <input type="file" id="file-hotspot2" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'hotspot2')">
                <div class="preview-item" onclick="document.getElementById('file-hotspot2').click()">
                    <img id="img-preview-hotspot2" src="" style="display:none">
                    <span id="icon-hotspot2" class="preview-icon">2</span><div class="preview-label">ç…§ç‰‡ 2</div>
                </div>
                <input type="file" id="file-hotspot3" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'hotspot3')">
                <div class="preview-item" onclick="document.getElementById('file-hotspot3').click()">
                    <img id="img-preview-hotspot3" src="" style="display:none">
                    <span id="icon-hotspot3" class="preview-icon">3</span><div class="preview-label">ç…§ç‰‡ 3</div>
                </div>
            </div>
            <label style="margin-top:15px;">å…¶ä»–è¨˜éŒ„</label>
            <textarea id="inp_note" rows="3" placeholder="è«‹å¡«å¯«ä»»ä½•å€¼å¾—è¨˜éŒ„çš„è§€å¯Ÿ..." onchange="saveState()"></textarea>
            <button id="btn-upload" onclick="uploadData()" class="btn-upload" style="margin-top:20px;">ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯</button>
        </div>
    </div>

    <div id="view-ai" class="container">
        <h2>ğŸ¤– AI é‘‘å®šå®¤</h2>
        <div class="card" style="text-align:center;">
            <p id="ai-offline-warning" style="display:none; color:#d32f2f; font-weight:bold; background:#ffebee; padding:10px; border-radius:8px;">âš ï¸ é›¢ç·šæ¨¡å¼ç„¡æ³•ä½¿ç”¨ AIï¼Œè«‹æ”¹ç”¨æƒç¢¼</p>
            <p style="color:#666;">æ‹ä¸€å¼µï¼ŒAI å¹«ä½ åˆ†é¡ï¼</p>
            <button id="btn-ai-start" onclick="startAiCamera()" class="btn-blue">ğŸ“· å•Ÿå‹• AI ç›¸æ©Ÿ</button>
            <div id="camera-box-ai" class="camera-box">
                <div id="reader-ai" class="scanner-view"></div><div onclick="takeAiSnapshot()" class="btn-snap-div">ğŸ“¸</div>
            </div>
            <div id="ai-result-box" class="ai-result-box">
                <img id="ai-preview-img" style="width:140px; height:140px; object-fit:cover; border-radius:12px; border:3px solid white; box-shadow:0 4px 8px rgba(0,0,0,0.15);">
                <h3 style="color:var(--primary); margin:15px 0 8px;">AI èªç‚ºæ˜¯ï¼š</h3>
                <p style="font-size:14px; color:#546e7a; background:white; padding:8px; border-radius:8px; margin-top:10px;">ç‰¹å¾µï¼š<span id="ai-desc-text"></span></p>
                <div style="margin-top:15px; text-align:left;">
                    <label style="font-size:13px; color:var(--primary);">ğŸ› ï¸ è‹¥ä¸æº–ç¢ºè«‹ä¿®æ­£ï¼š</label>
                    <select id="ai-country-select"></select>
                </div>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button id="btn-google-check" class="btn-outline" style="font-size:14px;">ğŸ” Google æŸ¥è­‰</button>
                    <button id="btn-confirm-ai" class="btn-green">âœ… ç¢ºèªåŠ å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-basic" onclick="switchTab('basic')"><span>ğŸ“</span>åŸºæœ¬</div>
        <div class="nav-item" id="nav-record" onclick="switchTab('record')"><span>ğŸ“Š</span>è¨˜éŒ„</div>
        <div class="nav-item" id="nav-ai" onclick="switchTab('ai')"><span>ğŸ¤–</span>AI é‘‘å®š</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const STATE = { count: 0, target: 100, stats: {}, historyStack: [], currentCity: "æœªå®šä½", imgs: { env: null, group: null, hotspot1: null, hotspot2: null, hotspot3: null }, scanners: { record: null, ai: null }, surveyPoints: [], map: null, userMarker: null, selectedPoint: null };
        const timers = { 10: { total: 600, endTime: null, interval: null, running: false }, 20: { total: 1200, endTime: null, interval: null, running: false } };
        let vibrationInterval;
        let wakeLock = null; 
        
        // V96: å½è£éŸ³æ¨‚ (æ¥µä½éŸ³é‡çš„ç™½å™ªéŸ³ï¼Œéå®Œå…¨éœéŸ³)
        const activeAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); 
        activeAudio.loop = true;
        activeAudio.volume = 0.01; // 1% éŸ³é‡ï¼Œé¿å…æ‰“æ“¾

        const GS1_RANGES = [ { s: 0, e: 19, c: "ğŸ‡ºğŸ‡¸ ç¾åœ‹" }, { s: 30, e: 39, c: "ğŸ‡ºğŸ‡¸ ç¾åœ‹" }, { s: 60, e: 139, c: "ğŸ‡ºğŸ‡¸ ç¾åœ‹" }, { s: 754, e: 755, c: "ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§" }, { s: 750, e: 750, c: "ğŸ‡²ğŸ‡½ å¢¨è¥¿å“¥" }, { s: 300, e: 379, c: "ğŸ‡«ğŸ‡· æ³•åœ‹" }, { s: 400, e: 440, c: "ğŸ‡©ğŸ‡ª å¾·åœ‹" }, { s: 500, e: 509, c: "ğŸ‡¬ğŸ‡§ è‹±åœ‹" }, { s: 800, e: 839, c: "ğŸ‡®ğŸ‡¹ ç¾©å¤§åˆ©" }, { s: 840, e: 849, c: "ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™" }, { s: 460, e: 469, c: "ğŸ‡·ğŸ‡º ä¿„ç¾…æ–¯" }, { s: 540, e: 549, c: "ğŸ‡§ğŸ‡ª æ¯”åˆ©æ™‚" }, { s: 570, e: 579, c: "ğŸ‡©ğŸ‡° ä¸¹éº¥" }, { s: 590, e: 590, c: "ğŸ‡µğŸ‡± æ³¢è˜­" }, { s: 599, e: 599, c: "ğŸ‡­ğŸ‡º åŒˆç‰™åˆ©" }, { s: 640, e: 649, c: "ğŸ‡«ğŸ‡® èŠ¬è˜­" }, { s: 700, e: 709, c: "ğŸ‡³ğŸ‡´ æŒªå¨" }, { s: 730, e: 739, c: "ğŸ‡¸ğŸ‡ª ç‘å…¸" }, { s: 760, e: 769, c: "ğŸ‡¨ğŸ‡­ ç‘å£«" }, { s: 870, e: 879, c: "ğŸ‡³ğŸ‡± è·è˜­" }, { s: 900, e: 919, c: "ğŸ‡¦ğŸ‡¹ å¥§åœ°åˆ©" }, { s: 560, e: 560, c: "ğŸ‡µğŸ‡¹ è‘¡è„ç‰™" }, { s: 520, e: 521, c: "ğŸ‡¬ğŸ‡· å¸Œè‡˜" }, { s: 539, e: 539, c: "ğŸ‡®ğŸ‡ª æ„›çˆ¾è˜­" }, { s: 859, e: 859, c: "ğŸ‡¨ğŸ‡¿ æ·å…‹" }, { s: 868, e: 869, c: "ğŸ‡¹ğŸ‡· åœŸè€³å…¶" }, { s: 450, e: 459, c: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬" }, { s: 490, e: 499, c: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬" }, { s: 471, e: 471, c: "ğŸ‡¹ğŸ‡¼ å°ç£" }, { s: 690, e: 699, c: "ğŸ‡¨ğŸ‡³ ä¸­åœ‹" }, { s: 489, e: 489, c: "ğŸ‡­ğŸ‡° é¦™æ¸¯" }, { s: 958, e: 958, c: "ğŸ‡²ğŸ‡´ æ¾³é–€" }, { s: 880, e: 880, c: "ğŸ‡°ğŸ‡· éŸ“åœ‹" }, { s: 885, e: 885, c: "ğŸ‡¹ğŸ‡­ æ³°åœ‹" }, { s: 893, e: 893, c: "ğŸ‡»ğŸ‡³ è¶Šå—" }, { s: 480, e: 480, c: "ğŸ‡µğŸ‡­ è²å¾‹è³“" }, { s: 899, e: 899, c: "ğŸ‡®ğŸ‡© å°å°¼" }, { s: 955, e: 955, c: "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº" }, { s: 888, e: 888, c: "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡" }, { s: 890, e: 890, c: "ğŸ‡®ğŸ‡³ å°åº¦" }, { s: 884, e: 884, c: "ğŸ‡°ğŸ‡­ æŸ¬åŸ”å¯¨" }, { s: 883, e: 883, c: "ğŸ‡²ğŸ‡² ç·¬ç”¸" }, { s: 896, e: 896, c: "ğŸ‡µğŸ‡° å·´åŸºæ–¯å¦" }, { s: 930, e: 939, c: "ğŸ‡¦ğŸ‡º æ¾³æ´²" }, { s: 940, e: 949, c: "ğŸ‡³ğŸ‡¿ ç´è¥¿è˜­" }, { s: 600, e: 601, c: "ğŸ‡¿ğŸ‡¦ å—é" }, { s: 615, e: 615, c: "ğŸ‡³ğŸ‡¬ å¥ˆåŠåˆ©äº" }, { s: 789, e: 790, c: "ğŸ‡§ğŸ‡· å·´è¥¿" }, { s: 779, e: 779, c: "ğŸ‡¦ğŸ‡· é˜¿æ ¹å»·" }, { s: 780, e: 780, c: "ğŸ‡¨ğŸ‡± æ™ºåˆ©" } ];
        const PREFIX_DB = {}; GS1_RANGES.forEach(r => { for (let i = r.s; i <= r.e; i++) PREFIX_DB[i.toString().padStart(3, '0')] = r.c; });
        const COLORS = { 'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº': '#8d6e63', 'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#ff9800', 'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#212121', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#fbc02d', 'ğŸ‡ºğŸ‡¸ ç¾åœ‹': '#3f51b5', 'ğŸ‡¦ğŸ‡º æ¾³æ´²': '#009688', 'ğŸ‡©ğŸ‡ª å¾·åœ‹': '#000000', 'å…¶å®ƒ': '#757575' };
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1kiaaRdWuUtBEBnjG-HuTqedenqisFug4zQ6pyCWXrT0Ja7TF4RCAicTA1Q3u8TA9/exec";

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    if (wakeLock === null) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        wakeLock.addEventListener('release', () => { console.log('Wake Lock released'); wakeLock = null; });
                    }
                } catch (err) { console.error(`${err.name}, ${err.message}`); }
            }
        }
        function releaseWakeLock() { if (wakeLock !== null) { wakeLock.release(); wakeLock = null; } }

        function manualRequestNotification() {
            if (!("Notification" in window)) { alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½"); return; }
            Notification.requestPermission().then(permission => {
                updateNotificationButton(permission);
                if (permission === "granted") new Notification("âœ… æ¸¬è©¦é€šçŸ¥", { body: "è¨­å®šæˆåŠŸï¼" });
                else if (permission === "denied") alert("é€šçŸ¥å·²è¢«å°é–ã€‚è«‹è‡³æ‰‹æ©Ÿã€Œè¨­å®šã€æ‰‹å‹•é–‹å•Ÿé€šçŸ¥æ¬Šé™ã€‚");
            });
        }

        function updateNotificationButton(permission) {
            const btn = document.getElementById('btn-notify-req');
            if (permission === 'granted') { btn.innerText = "âœ… é€šçŸ¥å·²é–‹å•Ÿ"; btn.className = "btn-green"; btn.disabled = true; }
            else if (permission === 'denied') { btn.innerText = "ğŸš« é€šçŸ¥è¢«å°é–"; btn.className = "btn-red"; btn.disabled = false; }
            else { btn.innerText = "ğŸ”” é»æ­¤é–‹å•Ÿè¨ˆæ™‚é€šçŸ¥"; btn.className = "btn-outline"; btn.disabled = false; }
        }

        function sendSystemNotification() {
            if ("Notification" in window && Notification.permission === "granted") {
                if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                     navigator.serviceWorker.ready.then(function(registration) { registration.showNotification("â° æ™‚é–“åˆ°ï¼", { body: "èª¿æŸ¥æ™‚é–“å·²çµæŸã€‚", vibrate: [200, 100, 200] }); });
                } else {
                    new Notification("â° æ™‚é–“åˆ°ï¼", { body: "èª¿æŸ¥æ™‚é–“å·²çµæŸã€‚", vibrate: [200, 100, 200] });
                }
            }
        }

        document.addEventListener("visibilitychange", async () => {
          if (document.visibilityState === 'visible') { if (timers[10].running || timers[20].running) requestWakeLock(); }
          else { if (STATE.scanners.record) stopRecordScanner(); if (STATE.scanners.ai) stopAiScanner(); releaseWakeLock(); }
        });

        window.onload = () => { 
            if (navigator.userAgent.match(/Line/i)) { document.getElementById('line-warning').style.display = 'flex'; document.getElementById('loading-mask').style.display = 'none'; return; }
            if(localStorage.getItem('surveyor_name')) document.getElementById('inp_name').value = localStorage.getItem('surveyor_name');
            if(localStorage.getItem('surveyor_phone')) document.getElementById('inp_phone').value = localStorage.getItem('surveyor_phone');
            if ("Notification" in window) updateNotificationButton(Notification.permission);
            restoreState(); checkOfflineQueue(); updateNetworkStatus(); window.addEventListener('online', updateNetworkStatus); window.addEventListener('offline', updateNetworkStatus); loadSurveyPoints();
            setTimeout(() => { document.getElementById('loading-mask').style.display = 'none'; switchTab('basic'); }, 800); 
        };

        function saveState() {
            const currentState = {
                name: document.getElementById('inp_name').value, phone: document.getElementById('inp_phone').value, participants: document.getElementById('inp_participants').value, gps: document.getElementById('inp_gps').value, city: document.getElementById('inp_city').value, point: document.getElementById('inp_point').value, selectedPoint: STATE.selectedPoint, stats: STATE.stats, count: STATE.count, historyStack: STATE.historyStack, note: document.getElementById('inp_note').value, currentCity: STATE.currentCity,
                timer10End: timers[10].running ? timers[10].endTime : null, timer20End: timers[20].running ? timers[20].endTime : null
            };
            localStorage.setItem('survey_session', JSON.stringify(currentState));
        }

        function restoreState() {
            const savedJSON = localStorage.getItem('survey_session');
            if (!savedJSON) return;
            try {
                const saved = JSON.parse(savedJSON);
                if (saved.count > 0 || saved.gps) {
                    showModal('confirm', 'æ¢å¾©èª¿æŸ¥', 'âš ï¸ åµæ¸¬åˆ°æœªå®Œæˆç´€éŒ„ï¼Œæ˜¯å¦æ¢å¾©ï¼Ÿ', () => {
                        document.getElementById('inp_name').value = saved.name || ''; document.getElementById('inp_phone').value = saved.phone || ''; document.getElementById('inp_participants').value = saved.participants || 1; document.getElementById('inp_gps').value = saved.gps || ''; document.getElementById('inp_city').value = saved.city || ''; document.getElementById('inp_point').value = saved.point || ''; document.getElementById('inp_note').value = saved.note || '';
                        STATE.selectedPoint = saved.selectedPoint; STATE.stats = saved.stats || {}; STATE.count = saved.count || 0; STATE.historyStack = saved.historyStack || []; STATE.currentCity = saved.currentCity || "æœªå®šä½"; updateUI();
                        if (saved.timer10End && saved.timer10End > Date.now()) { timers[10].endTime = saved.timer10End; timers[10].running = true; resumeTimer(10); activeAudio.play().catch(()=>{}); }
                        if (saved.timer20End && saved.timer20End > Date.now()) { timers[20].endTime = saved.timer20End; timers[20].running = true; resumeTimer(20); activeAudio.play().catch(()=>{}); }
                        document.querySelectorAll('.photo-warning').forEach(el => el.style.display = 'block');
                    }, () => { localStorage.removeItem('survey_session'); });
                }
            } catch (e) { localStorage.removeItem('survey_session'); }
        }
        function clearState() { localStorage.removeItem('survey_session'); document.querySelectorAll('.photo-warning').forEach(el => el.style.display = 'none'); }
        function loadSurveyPoints() { if (!navigator.onLine) return; fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "getPoints" }) }).then(res => res.json()).then(data => { if(data.status === "success") { STATE.surveyPoints = data.points; } }).catch(e => console.error(e)); }
        function selectPoint(p) { STATE.selectedPoint = p; document.querySelectorAll('.point-item').forEach(el => el.classList.remove('selected')); const btn = document.getElementById('btn-nav-go'); btn.innerText = `âœ… ç¢ºèªé¸æ“‡ï¼š${p.name}`; btn.disabled = false; }
        function navigateToSelected() { if(!STATE.selectedPoint) return; const p = STATE.selectedPoint; document.getElementById('inp_gps').value = `${p.lat}, ${p.lng}`; document.getElementById('inp_city').value = p.name; document.getElementById('inp_point').value = p.id; STATE.currentCity = p.name; saveState(); closeMap(); if(confirm(`å·²å¡«å…¥æ¨£é»ï¼š${p.name}\n\næ˜¯å¦é–‹å•Ÿ Google Maps å°èˆªå‰å¾€ï¼Ÿ`)) { window.open(`https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`, '_blank'); } }
        function runGPS() { document.getElementById('inp_gps').value="å®šä½ä¸­..."; document.getElementById('inp_point').value = ""; if (!navigator.geolocation) { alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS"); return; } navigator.geolocation.getCurrentPosition(p=>{ const gpsText = `${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`; document.getElementById('inp_gps').value = gpsText; if(navigator.onLine) { fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&localityLanguage=zh`).then(r=>r.json()).then(d=>{ let city = (d.principalSubdivision || "").replace("Province", "").trim(); let town = (d.locality || "").trim(); STATE.currentCity = `${city} ${town}`; document.getElementById('inp_city').value=STATE.currentCity; saveState(); }).catch(e => { STATE.currentCity = "å®šä½æˆåŠŸ(ç„¡åœ°å€)"; document.getElementById('inp_city').value = STATE.currentCity; saveState(); }); } else { STATE.currentCity = "é›¢ç·šåº§æ¨™"; document.getElementById('inp_city').value = "âš ï¸ é›¢ç·šæ¨¡å¼ (ç­‰å¾…é€£ç·šå¾Œè‡ªå‹•è£œå…¨)"; saveState(); } }, ()=>{ alert("å®šä½å¤±æ•—"); document.getElementById('inp_gps').value=""; }); }
        function openMap() { document.getElementById('map-modal').style.display = 'flex'; if(!STATE.map) { STATE.map = L.map('map-container').setView([23.9, 121], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(STATE.map); } document.getElementById('map-list').innerHTML = '<div style="text-align:center; padding:10px; color:#666;">ğŸ“¡ æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...</div>'; navigator.geolocation.getCurrentPosition(p => { const userLat = p.coords.latitude; const userLng = p.coords.longitude; STATE.map.setView([userLat, userLng], 13); if(STATE.userMarker) STATE.map.removeLayer(STATE.userMarker); STATE.userMarker = L.marker([userLat, userLng]).addTo(STATE.map).bindPopup("æ‚¨çš„ä½ç½®").openPopup(); findNearestPoints(userLat, userLng); }, () => { alert("ç„¡æ³•å–å¾—ä½ç½®"); }); }
        function closeMap() { document.getElementById('map-modal').style.display = 'none'; }
        function findNearestPoints(lat, lng) { if(!STATE.surveyPoints || STATE.surveyPoints.length === 0) { document.getElementById('map-list').innerHTML = '<div style="padding:10px; color:red;">âš ï¸ ç„¡æ³•è¼‰å…¥æ¨£é» (è«‹æª¢æŸ¥å¾Œå°)</div>'; return; } const pointsWithDist = STATE.surveyPoints.map(p => { return { ...p, dist: getDistance(lat, lng, p.lat, p.lng) }; }).sort((a, b) => a.dist - b.dist); STATE.map.eachLayer(layer => { if (layer instanceof L.Marker && layer !== STATE.userMarker) STATE.map.removeLayer(layer); }); renderPointsOnMap(pointsWithDist.slice(0, 3)); renderList(pointsWithDist.slice(0, 3)); }
        function renderPointsOnMap(points) { points.forEach(p => { L.marker([p.lat, p.lng], { icon: createRedIcon() }).addTo(STATE.map).bindPopup(`<b>${p.name}</b><br>${p.dist.toFixed(1)} km`).on('click', () => selectPoint(p)); }); }
        function renderList(points) { const listDiv = document.getElementById('map-list'); listDiv.innerHTML = ""; points.forEach(p => { const item = document.createElement('div'); item.className = 'point-item'; item.innerHTML = `<div><b>${p.name}</b> (${p.id})</div><div class="point-dist">${p.dist.toFixed(1)}km</div>`; item.onclick = () => { selectPoint(p); STATE.map.setView([p.lat, p.lng], 15); }; listDiv.appendChild(item); }); }
        function toggleMapMode() { const btn = document.getElementById('btn-toggle-map'); if(btn.innerText.includes("å…¨å°")) { STATE.map.setView([23.9, 121], 7); STATE.surveyPoints.forEach(p => { L.circleMarker([p.lat, p.lng], { radius: 5, color: '#587a30' }).addTo(STATE.map).bindPopup(p.name).on('click', () => selectPoint(p)); }); btn.innerText = "ğŸ“ é¡¯ç¤ºæœ€è¿‘"; } else { openMap(); btn.innerText = "ğŸ—ºï¸ é¡¯ç¤ºå…¨å°"; } }
        function createRedIcon() { return new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }); }
        function getDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }

        // V96: Media Session Strategy
        function toggleTimer(min) {
            let t = timers[min]; let box = document.getElementById(`timer-${min}`);
            if (t.running) { 
                clearInterval(t.interval); t.running = false; box.classList.remove('running');
                saveState(); releaseWakeLock(); activeAudio.pause(); // Stop audio
            } else {
                manualRequestNotification();
                if (!t.endTime || t.endTime <= Date.now()) t.endTime = Date.now() + (min * 60 * 1000);
                box.classList.remove('done'); box.classList.add('running'); t.running = true;
                saveState(); requestWakeLock(); 
                
                // V96: Setup Media Session
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({ title: 'è’é‡èª¿æŸ¥è¨ˆæ™‚ä¸­', artist: 'è«‹å‹¿é—œé–‰ç¶²é ', album: `å‰©é¤˜ ${min} åˆ†é˜` });
                }
                activeAudio.play().catch(e => console.log("Audio play failed", e)); // Play fake music

                resumeTimer(min);
            }
        }
        
        function resumeTimer(min) {
             let t = timers[min]; let box = document.getElementById(`timer-${min}`); box.classList.add('running');
             if(t.running) { requestWakeLock(); activeAudio.play().catch(()=>{}); }
             t.interval = setInterval(() => {
                const now = Date.now(); const diff = t.endTime - now;
                if (diff <= 0) {
                     clearInterval(t.interval); t.running = false; box.classList.remove('running'); box.classList.add('done'); 
                     document.getElementById(`time-display-${min}`).innerText = "00:00";
                     saveState(); releaseWakeLock(); activeAudio.pause(); triggerAlarm(); sendSystemNotification(); 
                } else {
                     let m = Math.floor((diff / 1000) / 60).toString().padStart(2, '0');
                     let s = Math.floor((diff / 1000) % 60).toString().padStart(2, '0');
                     document.getElementById(`time-display-${min}`).innerText = `${m}:${s}`;
                }
            }, 500); 
        }

        function triggerAlarm() { let utterance = new SpeechSynthesisUtterance("æ™‚é–“åˆ°ï¼Œè«‹çµæŸèª¿æŸ¥"); window.speechSynthesis.speak(utterance); showModal('alarm', 'æ™‚é–“åˆ°ï¼', 'è«‹çµæŸèª¿æŸ¥ä¸¦ä¸Šå‚³è³‡æ–™', () => { if(vibrationInterval) clearInterval(vibrationInterval); if(navigator.vibrate) navigator.vibrate(0); }); if(navigator.vibrate) { navigator.vibrate([500, 200, 500]); vibrationInterval = setInterval(() => { navigator.vibrate([500, 200, 500]); }, 1500); } }
        function stopAlarm() { document.getElementById('alarm-modal').style.display = 'none'; if(vibrationInterval) clearInterval(vibrationInterval); if(navigator.vibrate) navigator.vibrate(0); }
        function normalizeName(rawName) { if (!rawName) return "å…¶å®ƒ"; let clean = rawName.toString().trim(); if (clean.includes("å°ç£") || clean.includes("Taiwan")) return "ğŸ‡¹ğŸ‡¼ å°ç£"; if (clean.includes("ä¸­åœ‹") || clean.includes("China") || clean.includes("CN") || clean.includes("å¤§é™¸")) return "ğŸ‡¨ğŸ‡³ ä¸­åœ‹"; if (clean.includes("è¶Šå—") || clean.includes("Vietnam")) return "ğŸ‡»ğŸ‡³ è¶Šå—"; if (clean.includes("è²å¾‹è³“") || clean.includes("Philippines")) return "ğŸ‡µğŸ‡­ è²å¾‹è³“"; if (clean.includes("æ³°åœ‹") || clean.includes("Thailand")) return "ğŸ‡¹ğŸ‡­ æ³°åœ‹"; if (clean.includes("å°å°¼") || clean.includes("Indonesia")) return "ğŸ‡®ğŸ‡© å°å°¼"; if (clean.includes("é¦¬ä¾†è¥¿äº")) return "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº"; if (clean.includes("éŸ“åœ‹") || clean.includes("Korea")) return "ğŸ‡°ğŸ‡· éŸ“åœ‹"; if (clean.includes("æ—¥æœ¬") || clean.includes("Japan")) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬"; for (let code in PREFIX_DB) { if (PREFIX_DB[code] === clean) return clean; } if (Object.keys(COLORS).includes(clean)) return clean; return "å…¶å®ƒ"; }
        function switchTab(tabName) { document.querySelectorAll('.container').forEach(el => el.classList.remove('active-tab')); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById('view-' + tabName).classList.add('active-tab'); document.getElementById('nav-' + tabName).classList.add('active'); stopRecordScanner(); stopAiScanner(); }
        function handleImgUpload(input, type) { if (!input.files || !input.files[0]) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const imgId = `img-preview-${type}`; const imgEl = document.getElementById(imgId); imgEl.src = e.target.result; imgEl.style.display = 'block'; const icon = document.getElementById(`icon-${type}`); if(icon) icon.style.display = 'none'; const temp = new Image(); temp.src = e.target.result; temp.onload = function() { const cvs = document.createElement('canvas'); let s = 1024 / temp.width; if (s > 1) s = 1; cvs.width = temp.width * s; cvs.height = temp.height * s; cvs.getContext('2d').drawImage(temp, 0, 0, cvs.width, cvs.height); STATE.imgs[type] = cvs.toDataURL('image/jpeg', 0.7).split(',')[1]; } }; reader.readAsDataURL(file); }
        function takeAiSnapshot() { var videoEl = document.querySelector("#reader-ai video"); if (!videoEl) { alert("ç›¸æ©Ÿæœªå•Ÿå‹•"); return; } videoEl.pause(); document.getElementById('loading-mask').style.display = 'flex'; var cvs = document.createElement("canvas"); var max = 800; var w = videoEl.videoWidth; var h = videoEl.videoHeight; var s = (w>h ? (w>max?max/w:1) : (h>max?max/h:1)); cvs.width = w*s; cvs.height = h*s; cvs.getContext("2d").drawImage(videoEl, 0, 0, cvs.width, cvs.height); var b64Full = cvs.toDataURL("image/jpeg", 0.6); stopAiScanner(); fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "identify", image: b64Full.split(',')[1] }) }).then(res => res.json()).then(data => { document.getElementById('loading-mask').style.display = 'none'; if (data.status === "success") { try { var raw = typeof data.result === 'string' ? data.result : JSON.stringify(data.result); var match = raw.match(/\{[\s\S]*\}/); if (match) displayAiResult(JSON.parse(match[0]), b64Full); else alert("AI æ ¼å¼éŒ¯èª¤: " + raw); } catch(e) { alert("è§£æå¤±æ•—: " + e.message); } } else { alert("å¾Œç«¯éŒ¯èª¤: " + data.message); } }).catch(err => { document.getElementById('loading-mask').style.display = 'none'; alert("é€£ç·šå¤±æ•—: " + err); }); }
        function displayAiResult(data, imgSrc) { const box = document.getElementById('ai-result-box'); box.style.display = 'block'; document.getElementById('ai-preview-img').src = imgSrc; document.getElementById('ai-desc-text').innerText = data.keywords || "ç„¡ç‰¹å¾µ"; const select = document.getElementById('ai-country-select'); select.innerHTML = ""; let aiGuess = normalizeName(data.country); if (aiGuess !== "å…¶å®ƒ") { select.add(new Option(`ğŸ¤– AI: ${aiGuess}`, aiGuess, true, true)); select.add(new Option("---", "disabled", false, false)); } for (let c of Object.keys(COLORS)) { if (c !== aiGuess) select.add(new Option(c, c)); } if (aiGuess === "å…¶å®ƒ") select.value = "å…¶å®ƒ"; const query = `${data.country || ""} ${data.keywords || ""} bottle`.trim(); document.getElementById('btn-google-check').onclick = () => window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank'); document.getElementById('btn-confirm-ai').onclick = () => { if (select.value === "disabled") return; addRecord(select.value, 1); box.style.display = 'none'; switchTab('record'); }; }
        function handlePrefixCheck() { const code = document.getElementById('inp_prefix').value; if (!code || code.length < 3) { showModal('warning', 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥è‡³å°‘ 3 ç¢¼', null); return; } const prefix = code.substring(0, 3); const country = PREFIX_DB[prefix]; if (country) { showModal('confirm', 'æŸ¥è©¢çµæœ', `ä»£ç¢¼ï¼š${prefix}<br><span class="big-result-text">${country}</span>è¦åŠ å…¥è¨˜éŒ„å—ï¼Ÿ`, () => { addRecord(country, 1); document.getElementById('inp_prefix').value = ""; }); } else { showModal('warning', 'æŸ¥ç„¡çµæœ', `æŸ¥ç„¡ä»£ç¢¼ [${prefix}] çš„æ­¸å±¬åœ°`, null); } }
        function addRecord(country, qty) { let safeName = normalizeName(country); if (!STATE.stats[safeName]) STATE.stats[safeName] = 0; STATE.stats[safeName] += qty; STATE.count += qty; for(let i=0; i<qty; i++) STATE.historyStack.push({key: safeName, qty: 1}); updateUI(); saveState(); }
        function undoRecord() { if (STATE.historyStack.length === 0) return; const last = STATE.historyStack.pop(); STATE.stats[last.key] -= last.qty; if (STATE.stats[last.key] <= 0) delete STATE.stats[last.key]; STATE.count -= last.qty; updateUI(); saveState(); }
        function handleManualAdd() { addRecord(document.getElementById('sel_country').value, parseInt(document.getElementById('inp_qty').value)); }
        function updateUI() { document.getElementById('disp_count').innerText = STATE.count; const tbody = document.getElementById('stats-body'); tbody.innerHTML = ""; let grad = [], deg = 0; if (STATE.count === 0) { document.getElementById('css-pie').style.background = "transparent"; document.getElementById('css-pie').style.border = "2px dashed #ddd"; return; } else { document.getElementById('css-pie').style.border = "4px solid #fff"; } for (const [key, val] of Object.entries(STATE.stats)) { const color = COLORS[key] || '#757575'; const pct = ((val / STATE.count) * 100).toFixed(1); tbody.innerHTML += `<tr><td><span style='color:${color}'>â– </span> ${key} <small>(${pct}%)</small></td><td>${val}</td></tr>`; const d = (val / STATE.count) * 360; grad.push(`${color} ${deg}deg ${deg + d}deg`); deg += d; } document.getElementById('css-pie').style.background = `conic-gradient(${grad.join(", ")})`; }
        function uploadData() { if (STATE.count === 0) { showModal('warning', 'ç„¡è³‡æ–™', 'è«‹å…ˆæ”¶é›†æ•¸æ“šå†ä¸Šå‚³', null); return; } if (!document.getElementById('inp_name').value) { showModal('warning', 'è³‡æ–™æœªå¡«', 'è«‹å¡«å¯« [å¡«è¡¨äººå§“å]', () => switchTab('basic')); return; } if (!document.getElementById('inp_phone').value) { showModal('warning', 'è³‡æ–™æœªå¡«', 'è«‹å¡«å¯« [è¯çµ¡äººæ‰‹æ©Ÿ]', () => switchTab('basic')); return; } if (!document.getElementById('inp_participants').value) { showModal('warning', 'è³‡æ–™æœªå¡«', 'è«‹å¡«å¯« [åƒèˆ‡äººæ•¸]', () => switchTab('basic')); return; } if (!document.getElementById('inp_gps').value) { showModal('warning', 'å°šæœªå®šä½', 'è«‹æŒ‰ [å®šä½] æŒ‰éˆ•ç²å– GPS', () => switchTab('basic')); return; } localStorage.setItem('surveyor_name', document.getElementById('inp_name').value); localStorage.setItem('surveyor_phone', document.getElementById('inp_phone').value); let statsOut = { cnt_tw:0, cnt_cn:0, cnt_vn:0, cnt_ph:0, cnt_my:0, cnt_id:0, cnt_th:0, cnt_kr:0, cnt_jp:0, cnt_other:"" }; let others = []; for(let k in STATE.stats) { if(k.includes("å°ç£")) statsOut.cnt_tw += STATE.stats[k]; else if(k.includes("ä¸­åœ‹")) statsOut.cnt_cn += STATE.stats[k]; else if(k.includes("è¶Šå—")) statsOut.cnt_vn += STATE.stats[k]; else if(k.includes("è²å¾‹è³“")) statsOut.cnt_ph += STATE.stats[k]; else if(k.includes("æ³°åœ‹")) statsOut.cnt_th += STATE.stats[k]; else if(k.includes("å°å°¼")) statsOut.cnt_id += STATE.stats[k]; else if(k.includes("é¦¬ä¾†è¥¿äº")) statsOut.cnt_my += STATE.stats[k]; else if(k.includes("éŸ“åœ‹")) statsOut.cnt_kr += STATE.stats[k]; else if(k.includes("æ—¥æœ¬")) statsOut.cnt_jp += STATE.stats[k]; else others.push(`${k}*${STATE.stats[k]}`); } statsOut.cnt_other = others.join(", "); var payload = { action: "save", name: document.getElementById('inp_name').value, phone: document.getElementById('inp_phone').value, participants: document.getElementById('inp_participants').value, city: document.getElementById('inp_city').value, surveyPoint: document.getElementById('inp_point').value, gps: document.getElementById('inp_gps').value, total: STATE.count, note: document.getElementById('inp_note').value, hotspotData1: STATE.imgs.hotspot1 || "", hotspotData2: STATE.imgs.hotspot2 || "", hotspotData3: STATE.imgs.hotspot3 || "", envData: STATE.imgs.env || "", groupData: STATE.imgs.group || "", ...statsOut }; if (!navigator.onLine) { saveOffline(payload); return; } var btn = document.getElementById('btn-upload'); btn.innerText = "â³ ä¸Šå‚³ä¸­...è«‹ä¿æŒè¢å¹•é–‹å•Ÿ"; btn.disabled = true; requestWakeLock(); fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }).then(res => res.json()).then(data => { showModal('success', 'ä¸Šå‚³æˆåŠŸ', 'è³‡æ–™å·²å®‰å…¨å­˜å…¥é›²ç«¯', () => handleSuccessConfirm(false)); }).catch(err => { saveOffline(payload); }).finally(() => { btn.innerText = "ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯"; btn.disabled = false; releaseWakeLock(); }); }
        function handleSuccessConfirm(isOffline) { if(document.getElementById('success-modal')) document.getElementById('success-modal').style.display = 'none'; if(document.getElementById('custom-modal')) document.getElementById('custom-modal').style.display = 'none'; STATE.count=0; STATE.stats={}; STATE.historyStack=[]; STATE.imgs = { env: null, group: null, hotspot1: null, hotspot2: null, hotspot3: null }; ['env', 'group', 'hotspot1', 'hotspot2', 'hotspot3'].forEach(k => { document.getElementById(`img-preview-${k}`).style.display='none'; if(document.getElementById(`icon-${k}`)) document.getElementById(`icon-${k}`).style.display='block'; }); document.getElementById('inp_gps').value = ""; document.getElementById('inp_city').value = ""; STATE.currentCity = "æœªå®šä½"; document.getElementById('inp_point').value = ""; document.getElementById('sel_country').selectedIndex = 0; document.getElementById('inp_qty').value = 1; document.getElementById('inp_note').value = ""; clearState(); updateUI(); checkOfflineQueue(); switchTab('basic'); }
        function startRecordScanner() { if (STATE.scanners.record) return; document.getElementById('camera-box-record').style.display = 'block'; document.getElementById('btn-scan-start').style.display = 'none'; document.getElementById('btn-scan-stop').style.display = 'inline-block'; STATE.scanners.record = new Html5Qrcode("reader-record"); STATE.scanners.record.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { STATE.scanners.record.pause(); const c = getCountryFromCode(txt); showModal('confirm', 'æƒææˆåŠŸ', `æ¢ç¢¼æ­¸å±¬<br><span class="big-result-text">${c}</span>æ˜¯å¦åŠ å…¥è¨˜éŒ„ï¼Ÿ`, () => { addRecord(c, 1); setTimeout(()=>STATE.scanners.record.resume(), 500); }, () => { setTimeout(()=>STATE.scanners.record.resume(), 500); } ); }, ()=>{} ); }
        function stopRecordScanner() { if(STATE.scanners.record) STATE.scanners.record.stop().then(()=>{STATE.scanners.record.clear(); STATE.scanners.record=null;}).catch(()=>{}); document.getElementById('camera-box-record').style.display='none'; document.getElementById('btn-scan-start').style.display='inline-block'; document.getElementById('btn-scan-stop').style.display='none'; }
        function startAiCamera() { document.getElementById('ai-result-box').style.display='none'; document.getElementById('camera-box-ai').style.display='block'; document.getElementById('btn-ai-start').style.display='none'; STATE.scanners.ai = new Html5Qrcode("reader-ai"); STATE.scanners.ai.start({ facingMode: "environment" }, { fps: 10 }, ()=>{}, ()=>{}); }
        function stopAiScanner() { if(STATE.scanners.ai) STATE.scanners.ai.stop().then(()=>{STATE.scanners.ai.clear(); STATE.scanners.ai=null;}).catch(()=>{}); document.getElementById('camera-box-ai').style.display='none'; document.getElementById('btn-ai-start').style.display='inline-block'; }
        function getCountryFromCode(code) { return (code && code.length>=3) ? (PREFIX_DB[code.substring(0,3)]||"æœªçŸ¥") : "æœªçŸ¥"; }
        function updateNetworkStatus() { const bar = document.getElementById('network-status'); const syncBox = document.getElementById('offline-sync-box'); const btnAi = document.getElementById('btn-ai-start'); const warnAi = document.getElementById('ai-offline-warning'); if(navigator.onLine) { bar.className = 'status-online'; bar.innerText = "ğŸŸ¢ ç³»çµ±é€£ç·šä¸­"; checkOfflineQueue(); if(btnAi) { btnAi.className = 'btn-blue'; btnAi.disabled = false; btnAi.innerText = 'ğŸ“· å•Ÿå‹• AI ç›¸æ©Ÿ'; } if(warnAi) warnAi.style.display = 'none'; } else { bar.className = 'status-offline'; bar.innerText = "ğŸ”´ é›¢ç·šæ¨¡å¼ (è³‡æ–™å°‡æš«å­˜æ–¼æ‰‹æ©Ÿ)"; syncBox.style.display = 'none'; if(btnAi) { btnAi.className = 'btn-disabled'; btnAi.disabled = true; btnAi.innerText = 'âš ï¸ é›¢ç·šç„¡æ³•ä½¿ç”¨'; } if(warnAi) warnAi.style.display = 'block'; } }
        function saveOffline(payload) { try { let queue = JSON.parse(localStorage.getItem('offline_queue') || "[]"); queue.push(payload); localStorage.setItem('offline_queue', JSON.stringify(queue)); showModal('offline', 'å·²æš«å­˜', 'ç¶²è·¯ä¸é€šï¼Œè³‡æ–™å·²å®‰å…¨ä¿å­˜åœ¨æ‰‹æ©Ÿä¸­ã€‚<br>è«‹åœ¨ç¶²è·¯æ¢å¾©å¾ŒæŒ‰ã€ŒåŒæ­¥ã€ä¸Šå‚³ã€‚', () => handleSuccessConfirm(true)); } catch (e) { showModal('warning', 'å„²å­˜å¤±æ•—', 'æ‰‹æ©Ÿå„²å­˜ç©ºé–“ä¸è¶³ã€‚', null); } }
        function checkOfflineQueue() { let queue = JSON.parse(localStorage.getItem('offline_queue') || "[]"); const syncBox = document.getElementById('offline-sync-box'); if (queue.length > 0 && navigator.onLine) { syncBox.style.display = 'block'; document.getElementById('offline-count').innerText = queue.length; } else { syncBox.style.display = 'none'; } }
        async function syncOfflineData() { let queue = JSON.parse(localStorage.getItem('offline_queue') || "[]"); if (queue.length === 0) return; const btn = document.getElementById('btn-sync'); btn.disabled = true; btn.innerText = "â³ åŒæ­¥ä¸­ (è£œå…¨åœ°å€)..."; let successCount = 0; let failCount = 0; let newQueue = []; for (let item of queue) { if (item.gps && (item.city.includes("é›¢ç·š") || item.city === "")) { try { let [lat, long] = item.gps.split(', '); let res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${long}&localityLanguage=zh`); let data = await res.json(); item.city = `${(data.principalSubdivision || "").replace("Province", "").trim()} ${(data.locality || "").trim()}`; } catch(e) {} } try { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(item) }); successCount++; } catch (e) { failCount++; newQueue.push(item); } } localStorage.setItem('offline_queue', JSON.stringify(newQueue)); checkOfflineQueue(); btn.disabled = false; btn.innerText = "â˜ï¸ ç«‹å³ä¸Šå‚³æš«å­˜è³‡æ–™"; if (failCount === 0) showModal('success', 'åŒæ­¥å®Œæˆ', `æˆåŠŸä¸Šå‚³ ${successCount} ç­†è³‡æ–™ï¼<br>(åœ°å€å·²å˜—è©¦è£œå…¨)`, null); else showModal('warning', 'éƒ¨åˆ†å¤±æ•—', `æˆåŠŸ ${successCount} ç­†ï¼Œå¤±æ•— ${failCount} ç­†ã€‚<br>å¤±æ•—è³‡æ–™ä»ä¿ç•™åœ¨æš«å­˜å€ã€‚`, null); }
        function showModal(type, title, msg, onConfirm, onCancel) { const modal = document.getElementById('custom-modal'); const box = document.getElementById('modal-content-box'); const icon = document.getElementById('modal-icon'); const btnConfirm = document.getElementById('btn-modal-confirm'); const btnCancel = document.getElementById('btn-modal-cancel'); box.className = 'modal-content'; btnCancel.style.display = 'block'; btnConfirm.innerText = "ç¢ºå®š"; document.getElementById('modal-title').innerText = title; document.getElementById('modal-msg').innerHTML = msg; if (type === 'warning') { box.classList.add('style-warning'); icon.innerText = "âš ï¸"; btnCancel.style.display = 'none'; btnConfirm.innerText = "æˆ‘çŸ¥é“äº†"; } else if (type === 'success') { box.classList.add('style-success'); icon.innerText = "ğŸ‰"; btnCancel.style.display = 'none'; btnConfirm.innerText = "å¥½ï¼Œç¹¼çºŒä¸‹ä¸€ç­†"; } else if (type === 'alarm') { box.classList.add('style-alarm'); icon.innerText = "â°"; btnCancel.style.display = 'none'; btnConfirm.innerText = "ç¢ºå®š (åœæ­¢éœ‡å‹•)"; } else if (type === 'offline') { box.classList.add('style-offline'); icon.innerText = "ğŸ’¾"; btnCancel.style.display = 'none'; btnConfirm.innerText = "æˆ‘çŸ¥é“äº†"; } else { icon.innerText = "ğŸ¤”"; } btnConfirm.onclick = () => { modal.style.display = 'none'; if (onConfirm) onConfirm(); }; btnCancel.onclick = () => { modal.style.display = 'none'; if (onCancel) onCancel(); }; modal.style.display = 'flex'; }
    </script>
</body>
</html>
