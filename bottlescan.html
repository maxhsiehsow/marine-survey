<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è’é‡æ•¸ä½æ­¸æª”åŠ©æ‰‹ V1.0</title>
  <style>
    /* --- CSS æ¨£å¼ç¹¼æ‰¿è‡ª UI åŸå‹ (ä¿æŒä¸è®Š) --- */
    :root { --primary: #587a30; --primary-dark: #3e5c20; --accent: #f57c00; --bg-light: #f4f7f4; --panel-bg: #ffffff; --border: #e0e0e0; --scan-line: #ff0000; }
    body { margin: 0; padding: 0; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-light); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    header { background: var(--primary); color: white; height: 50px; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; justify-content: space-between; }
    .brand { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    
    .main-container { display: flex; flex: 1; height: calc(100vh - 50px); }
    .image-panel { flex: 2; background: #222; display: flex; flex-direction: column; position: relative; border-right: 1px solid #444; }
    .toolbar { background: #333; padding: 10px; display: flex; gap: 10px; }
    .toolbar input { flex: 1; background: #444; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
    .toolbar button { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    .toolbar button:hover { background: var(--primary-dark); }
    
    .canvas-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; }
    #main-image { max-width: 95%; max-height: 95%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

    .scan-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; background: linear-gradient(to bottom, transparent 49%, rgba(0, 255, 0, 0.1) 50%, transparent 51%); z-index: 10; }
    .scan-line { width: 100%; height: 2px; background: var(--scan-line); box-shadow: 0 0 10px var(--scan-line); position: absolute; top: 0; animation: scanMove 2s infinite linear; }
    @keyframes scanMove { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    
    .ai-tags { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .tag { background: rgba(0, 0, 0, 0.7); color: #00e676; padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; border: 1px solid #00e676; backdrop-filter: blur(4px); }

    .form-panel { flex: 1; background: var(--panel-bg); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
    .panel-header { margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
    .status-box { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; border-radius: 4px; margin-bottom: 20px; transition: all 0.3s; }
    .status-box.success { background: #e8f5e9; border-color: #4caf50; }
    .status-box.warning { background: #fff3e0; border-color: #ff9800; }
    .status-box.error { background: #ffebee; border-color: #ef5350; }
    .status-title { font-weight: bold; margin-bottom: 5px; display: block; }
    .status-desc { font-size: 0.9rem; color: #555; margin: 0; }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 0.9rem; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
    .form-group input:focus { border-color: var(--primary); outline: none; background: #fafafa; }
    
    .btn-group { margin-top: auto; display: flex; gap: 10px; padding-top: 20px; border-top: 1px solid var(--border); }
    .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; transition: filter 0.2s; }
    .btn-primary { background: var(--primary); color: white; flex: 2; }
    .btn-danger { background: #ffebee; color: #d32f2f; border: 1px solid #ef5350; }
    .btn:hover { filter: brightness(0.95); }
    .btn:disabled { background: #ccc; cursor: not-allowed; color: #666; }

    .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; display: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
  </style>
  <!-- å¼•å…¥ html5-qrcode ç”¨æ–¼å‰ç«¯æƒç¢¼ -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>

<header>
  <div class="brand"><span>ğŸŒ¿</span> è’é‡ç“¶ç½æ•¸ä½æ­¸æª”åŠ©æ‰‹ <span style="font-size:0.8em; background:#ffffff33; padding:2px 6px; border-radius:4px;">V1.0</span></div>
  <div class="user-info">å·²è™•ç†ï¼š<span id="counter">0</span> ç­†</div>
</header>

<div class="main-container">
  <div class="image-panel">
    <div class="toolbar">
      <input type="text" id="folder-id" placeholder="è«‹è¼¸å…¥ Google Drive è³‡æ–™å¤¾ ID">
      <button onclick="startProcess()">ğŸ“‚ è¼‰å…¥ä¸‹ä¸€å¼µ</button>
    </div>
    <div class="canvas-container">
      <img id="main-image" src="" style="display:none;">
      <div id="loader" class="loader"><div class="spinner"></div><div id="loader-text">è®€å–ä¸­...</div></div>
      <div id="scan-overlay" class="scan-overlay"><div class="scan-line"></div></div>
      <div id="ai-tags" class="ai-tags"></div>
    </div>
  </div>

  <div class="form-panel">
    <div class="panel-header">
      <div class="panel-title">æ­¸æª”è³‡æ–™ç¢ºèª</div>
      <div class="file-meta" id="file-meta">å°šæœªè¼‰å…¥æª”æ¡ˆ</div>
    </div>
    
    <div id="status-box" class="status-box warning">
      <span class="status-title">â³ ç­‰å¾…æ“ä½œ</span>
      <p class="status-desc">è«‹è¼¸å…¥è³‡æ–™å¤¾ ID ä¸¦é»æ“Šè¼‰å…¥ã€‚</p>
    </div>

    <div class="form-group">
      <label>1. æ¢ç¢¼ (Barcode)</label>
      <input type="text" id="inp-barcode" placeholder="æƒæçµæœ...">
    </div>
    <div class="form-group">
      <label>2. ä¾†æºåœ‹ (Country)</label>
      <input type="text" list="country-list" id="inp-country" placeholder="é¸æ“‡æˆ–è¼¸å…¥ä¾†æºåœ‹">
      <datalist id="country-list">
        <option value="ğŸ‡¹ğŸ‡¼ å°ç£"><option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹"><option value="ğŸ‡»ğŸ‡³ è¶Šå—">
        <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“"><option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬"><option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">
        <option value="ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº"><option value="ğŸ‡®ğŸ‡© å°å°¼"><option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">
      </datalist>
    </div>
    <div class="form-group">
      <label>3. å“ç‰Œ/å‚™è¨»</label>
      <input type="text" id="inp-note" placeholder="å¦‚ï¼šå¯å£å¯æ¨‚">
    </div>
    <div class="form-group">
      <label>4. æ­¸æª”äººå“¡</label>
      <input type="text" id="inp-operator" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
    </div>

    <div class="btn-group">
      <button class="btn btn-danger" onclick="skipImage()">è·³é</button>
      <button class="btn btn-primary" id="btn-submit" onclick="submitData()">âœ… ç¢ºèªä¸¦æ­¸æª” (Enter)</button>
    </div>
  </div>
</div>

<script>
  // --- å…¨åŸŸè®Šæ•¸ ---
  let CURRENT_FILE = null; // å„²å­˜ç•¶å‰æª”æ¡ˆè³‡è¨Š
  let CURRENT_BASE64 = null; // å„²å­˜ç•¶å‰åœ–ç‰‡ Base64
  let AI_METHOD = "None"; // è¨˜éŒ„æ˜¯ Barcode é‚„æ˜¯ AI

  // é é¢è¼‰å…¥æ™‚
  window.onload = () => {
    // è¨˜æ†¶åŠŸèƒ½ï¼šè‡ªå‹•å¡«å…¥ä¸Šæ¬¡çš„è³‡æ–™å¤¾ ID èˆ‡ å§“å
    if(localStorage.getItem('folder_id')) document.getElementById('folder-id').value = localStorage.getItem('folder_id');
    if(localStorage.getItem('operator')) document.getElementById('inp-operator').value = localStorage.getItem('operator');
  };

  // --- 1. å•Ÿå‹•ï¼šè¼‰å…¥ä¸‹ä¸€å¼µ ---
  function startProcess() {
    const folderId = document.getElementById('folder-id').value.trim();
    if (!folderId) return alert("è«‹è¼¸å…¥è³‡æ–™å¤¾ ID");
    
    // å„²å­˜è¨­å®š
    localStorage.setItem('folder_id', folderId);
    
    // UI é‡ç½®
    resetUI();
    showLoader("å¾é›²ç«¯è®€å–ç…§ç‰‡ä¸­...");
    
    // å‘¼å«å¾Œç«¯ï¼šgetNextImage
    google.script.run
      .withSuccessHandler(onImageLoaded)
      .withFailureHandler(onFailure)
      .getNextImage(folderId);
  }

  function onImageLoaded(res) {
    if (res.status !== 'success') {
      hideLoader();
      updateStatus('error', 'åœæ­¢', res.message);
      if(res.status === 'empty') alert("ğŸ‰ è³‡æ–™å¤¾è™•ç†å®Œç•¢ï¼");
      return;
    }

    CURRENT_FILE = res;
    CURRENT_BASE64 = res.base64;
    
    // é¡¯ç¤ºåœ–ç‰‡
    const img = document.getElementById('main-image');
    img.src = `data:${res.mimeType};base64,${res.base64}`;
    img.style.display = 'block';
    document.getElementById('file-meta').innerText = res.fileName;
    hideLoader();

    // åœ–ç‰‡è¼‰å…¥å®Œæˆå¾Œï¼Œé–‹å§‹åˆ†æ
    img.onload = () => {
      runAnalysis();
    };
  }

  // --- 2. åˆ†æï¼šå…ˆè©¦å‰ç«¯æ¢ç¢¼ -> å¤±æ•—å‰‡å‘¼å«å¾Œç«¯ AI ---
  function runAnalysis() {
    document.getElementById('scan-overlay').style.display = 'block';
    updateStatus('warning', 'ğŸ¤– åˆ†æä¸­...', 'æ­£åœ¨æƒææ¢ç¢¼èˆ‡ç‰¹å¾µ...');
    
    // å˜—è©¦å‰ç«¯æƒç¢¼ (ä½¿ç”¨ html5-qrcode)
    const html5QrCode = new Html5Qrcode("scan-overlay"); // å€Ÿç”¨ä¸€å€‹ div IDï¼Œå…¶å¯¦ä¸éœ€è¦é¡¯ç¤ºç›¸æ©Ÿä»‹é¢
    const imageFile = base64ToFile(CURRENT_BASE64, CURRENT_FILE.fileName);
    
    html5QrCode.scanFile(imageFile, true)
      .then(decodedText => {
        // æˆåŠŸæƒåˆ°æ¢ç¢¼
        console.log("å‰ç«¯æƒç¢¼æˆåŠŸ:", decodedText);
        document.getElementById('scan-overlay').style.display = 'none';
        
        document.getElementById('inp-barcode').value = decodedText;
        AI_METHOD = "Barcode_Client";
        autoFillCountry(decodedText); // æ ¹æ“šæ¢ç¢¼å‰ç¶´å¡«å¯«åœ‹å®¶
        updateStatus('success', 'âœ… æƒç¢¼æˆåŠŸ', `è®€å–åˆ°æ¢ç¢¼ï¼š${decodedText}`);
        addTag("æ¢ç¢¼è­˜åˆ¥");
      })
      .catch(err => {
        // å‰ç«¯æƒä¸åˆ° -> å‘¼å«å¾Œç«¯ Gemini AI
        console.log("ç„¡æ¢ç¢¼ï¼Œå‘¼å« AI...");
        AI_METHOD = "AI_Gemini";
        callBackendAI();
      });
  }

  function callBackendAI() {
    updateStatus('warning', 'ğŸ¤– AI è¦–è¦ºè¾¨è­˜ä¸­...', 'æ¢ç¢¼ä¸æ¸…ï¼Œæ­£åœ¨è«‹æ±‚ Gemini å”åŠ©...');
    
    google.script.run
      .withSuccessHandler(onAiResult)
      .withFailureHandler(onFailure)
      .callGeminiAI(CURRENT_BASE64);
  }

  function onAiResult(res) {
    document.getElementById('scan-overlay').style.display = 'none';
    
    if (res.status === 'success') {
      const data = res.data;
      document.getElementById('inp-country').value = data.country || "";
      document.getElementById('inp-barcode').value = data.barcode || "";
      document.getElementById('inp-note').value = data.brand || "";
      
      // é¡¯ç¤ºé—œéµå­—æ¨™ç±¤
      if (data.keywords) {
        data.keywords.forEach(k => addTag(k));
      }
      addTag("Gemini Vision");
      
      let msg = "AI å·²å®Œæˆè¾¨è­˜ï¼Œè«‹äººå·¥ç¢ºèªã€‚";
      if(!data.barcode) msg += " (æœªç™¼ç¾æ¢ç¢¼)";
      updateStatus('success', 'âœ… AI åˆ†æå®Œæˆ', msg);
    } else {
      updateStatus('error', 'âš ï¸ AI è¾¨è­˜å¤±æ•—', res.message);
    }
  }

  // --- 3. æäº¤ï¼šå­˜æª”ä¸¦ä¸‹ä¸€å¼µ ---
  function submitData() {
    const operator = document.getElementById('inp-operator').value;
    if (!operator) return alert("è«‹è¼¸å…¥æ­¸æª”äººå“¡å§“å");
    localStorage.setItem('operator', operator);

    const country = document.getElementById('inp-country').value;
    if (!country) return alert("è«‹å¡«å¯«ä¾†æºåœ‹");

    // UI é–å®š
    const btn = document.getElementById('btn-submit');
    btn.disabled = true;
    btn.innerText = "ğŸ’¾ æ­¸æª”ä¸­...";
    updateStatus('warning', 'â˜ï¸ é›²ç«¯å­˜æª”ä¸­', 'æ­£åœ¨å¯«å…¥ Google Sheet ä¸¦ç§»å‹•æª”æ¡ˆ...');

    const payload = {
      folderId: document.getElementById('folder-id').value,
      fileId: CURRENT_FILE.fileId,
      fileName: CURRENT_FILE.fileName,
      country: country,
      barcode: document.getElementById('inp-barcode').value,
      note: document.getElementById('inp-note').value,
      operator: operator,
      method: AI_METHOD
    };

    google.script.run
      .withSuccessHandler(() => {
        // æˆåŠŸå¾Œï¼šæ›´æ–°è¨ˆæ•¸å™¨ï¼Œä¸¦è¼‰å…¥ä¸‹ä¸€å¼µ
        let count = parseInt(document.getElementById('counter').innerText);
        document.getElementById('counter').innerText = count + 1;
        
        btn.disabled = false;
        btn.innerText = "âœ… ç¢ºèªä¸¦æ­¸æª” (Enter)";
        startProcess(); // è‡ªå‹•ä¸‹ä¸€å¼µ
      })
      .withFailureHandler((err) => {
        btn.disabled = false;
        btn.innerText = "âœ… ç¢ºèªä¸¦æ­¸æª” (Enter)";
        alert("å­˜æª”å¤±æ•—: " + err);
      })
      .saveAndArchive(payload);
  }

  function skipImage() {
    if(confirm("ç¢ºå®šè·³éé€™å¼µå—ï¼Ÿ(ä¸æœƒæ­¸æª”ï¼Œç›´æ¥çœ‹ä¸‹ä¸€å¼µ)")) {
      startProcess();
    }
  }

  // --- è¼”åŠ©å·¥å…· ---
  function resetUI() {
    document.getElementById('main-image').style.display = 'none';
    document.getElementById('scan-overlay').style.display = 'none';
    document.getElementById('ai-tags').innerHTML = '';
    document.getElementById('inp-barcode').value = '';
    document.getElementById('inp-country').value = '';
    document.getElementById('inp-note').value = '';
    document.getElementById('file-meta').innerText = 'æº–å‚™è¼‰å…¥...';
  }

  function showLoader(msg) {
    document.getElementById('loader').style.display = 'block';
    document.getElementById('loader-text').innerText = msg;
  }
  function hideLoader() { document.getElementById('loader').style.display = 'none'; }

  function updateStatus(type, title, desc) {
    const box = document.getElementById('status-box');
    box.className = `status-box ${type}`;
    box.querySelector('.status-title').innerText = title;
    box.querySelector('.status-desc').innerText = desc;
  }

  function addTag(text) {
    const tag = document.createElement('div');
    tag.className = 'tag'; tag.innerText = text;
    document.getElementById('ai-tags').appendChild(tag);
  }

  function onFailure(err) {
    hideLoader();
    alert("ç³»çµ±éŒ¯èª¤: " + err);
    updateStatus('error', 'ç³»çµ±éŒ¯èª¤', err.message);
  }

  // Base64 è½‰ File ç‰©ä»¶ (çµ¦ html5-qrcode ç”¨)
  function base64ToFile(base64, filename) {
    const arr = base64.split(','); // å¦‚æœæœ‰ data URI é ­è¦å»æ‰ï¼Œä½† GAS å›å‚³çš„æ˜¯ç´” B64
    // é€™è£¡ GAS Utilities.base64Encode å›å‚³çš„æ˜¯ç´”å…§å®¹ï¼Œæ²’æœ‰ data:image... å‰ç¶´
    // æ‰€ä»¥ç›´æ¥ç”¨
    const byteString = atob(base64);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
      ia[i] = byteString.charCodeAt(i);
    }
    return new File([ab], filename, {type: "image/jpeg"});
  }
  
  function autoFillCountry(code) {
    const p = code.substring(0, 3);
    const db = {'471':'ğŸ‡¹ğŸ‡¼ å°ç£','690':'ğŸ‡¨ğŸ‡³ ä¸­åœ‹','691':'ğŸ‡¨ğŸ‡³ ä¸­åœ‹','692':'ğŸ‡¨ğŸ‡³ ä¸­åœ‹','490':'ğŸ‡¯ğŸ‡µ æ—¥æœ¬','450':'ğŸ‡¯ğŸ‡µ æ—¥æœ¬','880':'ğŸ‡°ğŸ‡· éŸ“åœ‹','893':'ğŸ‡»ğŸ‡³ è¶Šå—','885':'ğŸ‡¹ğŸ‡­ æ³°åœ‹','899':'ğŸ‡®ğŸ‡© å°å°¼','955':'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº'};
    if(db[p]) document.getElementById('inp-country').value = db[p];
  }

  // éµç›¤ç›£è½
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') submitData();
  });
</script>
</body>
</html>
