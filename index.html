<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V24</title>

    <style>
        /* åŸºç¤è¨­å®š */
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 80px; color: #333; }
        
        .card { 
            background: white; padding: 15px; border-radius: 12px; 
            margin-bottom: 15px; border: 1px solid #ddd; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h2 { margin-top: 0; color: #0056b3; font-size: 18px; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; }
        
        input, select { 
            width: 100%; padding: 12px; font-size: 16px; margin: 5px 0 15px 0; 
            border: 2px solid #cfd8dc; border-radius: 8px; background: #fff; box-sizing: border-box;
        }

        button { 
            width: 100%; padding: 14px; font-size: 16px; font-weight: bold; 
            margin-top: 5px; cursor: pointer; color: white; border: none; border-radius: 8px; 
        }
        .btn-blue { background: #0288d1; }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #d32f2f; }
        .btn-orange { background: #f57c00; }
        .btn-upload { background: #673ab7; } /* ç´«è‰²ä¸Šå‚³æŒ‰éˆ• */

        /* CSS ç´”ä»£ç¢¼åœ“é¤…åœ– (ç¸®å°ç‰ˆï¼Œæ–¹ä¾¿æˆªåœ–) */
        .pie-chart {
            width: 120px; height: 120px; border-radius: 50%; 
            background: conic-gradient(#eee 0% 100%);
            margin: 10px auto; border: 1px solid #ccc;
        }

        /* æƒæè¦–çª— */
        #reader { width: 100%; background: #000; display: none; margin-bottom: 10px; min-height: 200px; }

        /* å ±å‘Šå€ (ç·Šæ¹Šæ’ç‰ˆ) */
        #report-layout {
            border: 3px solid #0056b3; background: white; padding: 0;
        }
        .rep-head { background: #0056b3; color: white; padding: 8px; text-align: center; font-weight: bold; }
        .rep-body { padding: 10px; font-size: 13px; line-height: 1.4; }
        
        .evidence-img { 
            width: 100%; height: 150px; object-fit: cover; object-position: center;
            display: none; margin-top: 5px; border: 1px solid #333; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
        
        #scan-loading { display: none; color: #f57c00; font-weight: bold; margin-bottom: 5px; }
    </style>

    <script>
        // === 1. åˆå§‹åŒ– ===
        window.onload = function() {
            var d = new Date();
            document.getElementById('out_date').innerText = d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate();
        };

        // === è®Šæ•¸ ===
        var count = 0;
        var stats = {};
        var historyStack = [];
        var html5QrCode = null;
        var isLibLoaded = false;
        var currentCity = "æœªå®šä½"; // ç”¨ä¾†å­˜ç¸£å¸‚

        // âš ï¸âš ï¸âš ï¸ã€é‡è¦ã€‘è«‹å°‡ä¸‹é¢çš„å¼•è™Ÿå…§æ›æˆæ‚¨çš„ Google Apps Script ç¶²å€ âš ï¸âš ï¸âš ï¸
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhPWysxZoVHQreEsFyPJMPU_Ko4f-d50etDLiNmI_k0c7Vf1ncchVRAQnA73YbdvbGUw/exec"; 

        var colors = {
            'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#43a047',
            'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#fdd835', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#fb8c00',
            'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 'ğŸ‡ºğŸ‡¸ ç¾åœ‹': '#546e7a',
            'â“ ç„¡æ³•è¾¨è­˜': '#757575'
        };

        // === 2. å‹•æ…‹è¼‰å…¥æƒæåº« ===
        function loadScannerAndStart() {
            if (isLibLoaded) { startCamera(); return; }
            document.getElementById('scan-loading').style.display = 'block';
            document.getElementById('scan-loading').innerText = "â³ ä¸‹è¼‰æ¨¡çµ„ä¸­...";
            var script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js";
            script.onload = function() { isLibLoaded = true; document.getElementById('scan-loading').style.display = 'none'; startCamera(); };
            script.onerror = function() { document.getElementById('scan-loading').style.display = 'none'; alert("æ¨¡çµ„ä¸‹è¼‰å¤±æ•—"); };
            document.head.appendChild(script);
        }

        function startCamera() {
            document.getElementById('reader').style.display = 'block';
            document.getElementById('btn-scan').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';
            try {
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 200, experimentalFeatures: { useBarCodeDetectorIfSupported: true } },
                    function(decodedText) {
                        if(navigator.vibrate) navigator.vibrate(200);
                        stopCamera();
                        var country = identifyBarcode(decodedText);
                        alert("æƒææˆåŠŸï¼" + country);
                        addRecord(country);
                    }, function(err) {}
                ).catch(err => { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—"); stopCamera(); });
            } catch(e) { alert("ç›¸æ©ŸéŒ¯èª¤"); stopCamera(); }
        }

        function stopCamera() {
            if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{});
            document.getElementById('reader').style.display = 'none';
            document.getElementById('btn-scan').style.display = 'inline-block';
            document.getElementById('btn-stop').style.display = 'none';
        }

        function identifyBarcode(code) {
            if(!code || code.length < 3) return "â“ ç„¡æ³•è¾¨è­˜";
            var p = parseInt(code.substring(0,3));
            if(p==471) return "ğŸ‡¹ğŸ‡¼ å°ç£";
            if(p>=690 && p<=699) return "ğŸ‡¨ğŸ‡³ ä¸­åœ‹";
            if(p>=450 && p<=459 || (p>=490 && p<=499)) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬";
            if(p==880) return "ğŸ‡°ğŸ‡· éŸ“åœ‹";
            if(p==893) return "ğŸ‡»ğŸ‡³ è¶Šå—";
            if(p==885) return "ğŸ‡¹ğŸ‡­ æ³°åœ‹";
            if(p==899) return "ğŸ‡®ğŸ‡© å°å°¼";
            if(p==480) return "ğŸ‡µğŸ‡­ è²å¾‹è³“";
            if(p==955) return "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº";
            if(p>=0 && p<=139) return "ğŸ‡ºğŸ‡¸ ç¾åœ‹";
            return "â“ ç„¡æ³•è¾¨è­˜";
        }

        // === 3. GPS èˆ‡ é€†å‘åœ°ç†ç·¨ç¢¼ (æ–°åŠŸèƒ½) ===
        function runGPS() {
            var field = document.getElementById('inp_gps');
            var locField = document.getElementById('out_loc_city');
            field.value = "å®šä½ä¸­...";
            
            if(!navigator.geolocation) { alert("ä¸æ”¯æ´ GPS"); return; }
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    var lat = pos.coords.latitude;
                    var lng = pos.coords.longitude;
                    var txt = lat.toFixed(5) + ", " + lng.toFixed(5);
                    field.value = txt;
                    document.getElementById('out_gps').innerText = txt;
                    
                    // å‘¼å«å…è²» API æŸ¥ç¸£å¸‚
                    fetchCityName(lat, lng);
                },
                function(err) { field.value = "å®šä½å¤±æ•—"; alert("å®šä½å¤±æ•—"); }
            );
        }

        function fetchCityName(lat, lng) {
            // ä½¿ç”¨ BigDataCloud å…è²» API (ä¸éœ€ Keyï¼Œé©åˆå‰ç«¯ä½¿ç”¨)
            var api = "https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=" + lat + "&longitude=" + lng + "&localityLanguage=zh";
            
            document.getElementById('out_loc_city').innerText = "(æŸ¥è©¢ç¸£å¸‚ä¸­...)";
            
            fetch(api)
            .then(response => response.json())
            .then(data => {
                // å˜—è©¦æŠ“å–ç¸£å¸‚åç¨±
                var city = data.principalSubdivision || data.locality || "æœªçŸ¥ç¸£å¸‚";
                // ç°¡å–®éæ¿¾ï¼Œåªè¦å°ç£çš„ç¸£å¸‚
                city = city.replace("Province", "").trim(); 
                
                currentCity = city; // å­˜èµ·ä¾†ç­‰ç­‰ä¸Šå‚³ç”¨
                document.getElementById('out_loc_city').innerText = city;
                alert("å®šä½æˆåŠŸï¼ä½æ–¼ï¼š" + city);
            })
            .catch(err => {
                document.getElementById('out_loc_city').innerText = "æœªçŸ¥";
                alert("GPS æˆåŠŸï¼Œä½†ç„¡æ³•å–å¾—ç¸£å¸‚åç¨± (ç¶²è·¯å•é¡Œ)");
            });
        }

        // === 4. ä¸Šå‚³åˆ° Google Sheets (æ–°åŠŸèƒ½) ===
        function uploadData() {
            if(GOOGLE_SCRIPT_URL.indexOf("è²¼åœ¨é€™è£¡") > -1) {
                alert("âš ï¸ è¨­å®šéŒ¯èª¤ï¼š\nè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€ï¼");
                return;
            }
            if(count === 0) { alert("æ²’æœ‰è³‡æ–™å¯ä»¥ä¸Šå‚³ï¼"); return; }
            if(!document.getElementById('inp_name').value) { alert("è«‹å…ˆè¼¸å…¥å§“å"); return; }

            var btn = document.getElementById('btn-upload');
            btn.innerText = "â³ ä¸Šå‚³ä¸­...";
            btn.disabled = true;

            // æ•´ç†è³‡æ–™
            var payload = {
                name: document.getElementById('inp_name').value,
                loc: document.getElementById('inp_loc').value,
                city: currentCity,
                gps: document.getElementById('inp_gps').value,
                stats: JSON.stringify(stats) // æŠŠçµ±è¨ˆç‰©ä»¶è½‰æˆæ–‡å­—å­˜
            };

            // ç™¼é€ (ä½¿ç”¨ no-cors é¿å…è·¨åŸŸéŒ¯èª¤ï¼Œé›–ç„¶æ”¶ä¸åˆ°å›æ‡‰ä½†æœƒæˆåŠŸç™¼é€)
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼\nè³‡æ–™å·²å‚³é€è‡³ Google è©¦ç®—è¡¨ã€‚");
                btn.innerText = "â˜ï¸ ä¸Šå‚³æˆåŠŸ";
                btn.disabled = false;
            }).catch(err => {
                alert("âŒ ä¸Šå‚³å¤±æ•— (ç¶²è·¯å•é¡Œ)");
                btn.innerText = "â˜ï¸ é‡è©¦ä¸Šå‚³";
                btn.disabled = false;
            });
        }

        // === 5. å…¶ä»–æ ¸å¿ƒ ===
        function syncData() {
            document.getElementById('out_name').innerText = document.getElementById('inp_name').value;
            document.getElementById('out_loc').innerText = document.getElementById('inp_loc').value;
        }

        function addRecord(scannedVal) {
            var val = scannedVal;
            if(!val) val = document.getElementById('sel_country').value;
            if(!val) { alert("è«‹é¸æ“‡åœ‹å®¶"); return; }

            if(!stats[val]) stats[val] = 0;
            stats[val]++;
            count++;
            historyStack.push(val);

            document.getElementById('disp_count').innerText = count;
            document.getElementById('sel_country').value = "";
            renderTable();
            drawCssChart();
            
            if(count == 10) alert("ğŸ‰ å·²æ»¿ 10 å€‹ï¼è¨˜å¾—ä¸Šå‚³è³‡æ–™å–”ï¼");
        }

        function undoRecord() {
            if(count <= 0) return;
            var last = historyStack.pop();
            stats[last]--;
            if(stats[last] === 0) delete stats[last];
            count--;
            document.getElementById('disp_count').innerText = count;
            renderTable();
            drawCssChart();
        }

        function renderTable() {
            var tbody = document.getElementById('stats-body');
            tbody.innerHTML = "";
            if(count === 0) { tbody.innerHTML = "<tr><td colspan='2'>ç„¡è³‡æ–™</td></tr>"; return; }
            for(var key in stats) {
                var tr = document.createElement('tr');
                tr.innerHTML = "<td><span style='color:"+colors[key]+"'>â– </span> " + key + "</td><td>" + stats[key] + "</td>";
                tbody.appendChild(tr);
            }
        }

        function drawCssChart() {
            if(count === 0) { document.getElementById('css-pie').style.background = "#eee"; return; }
            var gradientStr = [];
            var currentDeg = 0;
            for(var key in stats) {
                var percent = stats[key] / count;
                var deg = percent * 360;
                var color = colors[key] || '#999';
                gradientStr.push(color + " " + currentDeg.toFixed(1) + "deg " + (currentDeg + deg).toFixed(1) + "deg");
                currentDeg += deg;
            }
            document.getElementById('css-pie').style.background = "conic-gradient(" + gradientStr.join(", ") + ")";
        }

        function previewImage(event) {
            var file = event.target.files[0];
            if(file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.getElementById('out_img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }
    </script>
</head>
<body>

    <h1>ğŸ“‹ æµ·å»¢èª¿æŸ¥å“¡ V24</h1>

    <div class="card">
        <h2>1. è¨­å®š</h2>
        <label>å§“åï¼š</label>
        <input type="text" id="inp_name" placeholder="è¼¸å…¥å§“å" oninput="syncData()">
        <label>GPS / åœ°é»ï¼š</label>
        <button onclick="runGPS()" class="btn-blue" style="margin-bottom:5px;">ğŸ“ æŠ“å–åº§æ¨™ & ç¸£å¸‚</button>
        <input type="text" id="inp_gps" readonly value="å°šæœªå®šä½" style="background:#f1f8e9;">
        <input type="text" id="inp_loc" placeholder="è¼¸å…¥åœ°é»åç¨± (å¦‚: å¤–æ¾³æ²™ç˜)" oninput="syncData()">
    </div>

    <div class="card">
        <h2>2. è¨˜éŒ„</h2>
        <div style="text-align:center; font-size:20px; font-weight:bold; margin-bottom:10px;">
            æ•¸é‡ï¼š<span id="disp_count" style="color:red;">0</span> / 10
        </div>
        
        <div id="scan-loading"></div>
        <div id="reader"></div>
        <button id="btn-scan" onclick="loadScannerAndStart()" class="btn-orange">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ¢ç¢¼</button>
        <button id="btn-stop" onclick="stopCamera()" class="btn-red" style="display:none;">â¹ é—œé–‰ç›¸æ©Ÿ</button>

        <label style="margin-top:15px;">æˆ–æ‰‹å‹•é¸æ“‡ï¼š</label>
        <select id="sel_country">
            <option value="">ğŸ‘‡ é»æ­¤é¸æ“‡...</option>
            <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option>
            <option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
            <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
            <option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
            <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option>
            <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
            <option value="ğŸ‡®ğŸ‡© å°å°¼">ğŸ‡®ğŸ‡© å°å°¼</option>
            <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
            <option value="ğŸ‡ºğŸ‡¸ ç¾åœ‹">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option>
            <option value="â“ ç„¡æ³•è¾¨è­˜">â“ ç„¡æ³•è¾¨è­˜</option>
        </select>

        <button onclick="addRecord()" class="btn-green">â• å¢åŠ ä¸€ç­†</button>
        <button onclick="undoRecord()" class="btn-red">â†©ï¸ åˆªé™¤ä¸Šä¸€ç­†</button>
    </div>

    <div class="card">
        <h2>3. å ±å‘Š & ä¸Šå‚³</h2>
        
        <div id="report-layout">
            <div class="rep-head">æµ·å»¢èª¿æŸ¥é›»å­å ±å‘Š</div>
            <div class="rep-body">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <strong>æ—¥æœŸï¼š</strong><span id="out_date"></span><br>
                        <strong>å§“åï¼š</strong><span id="out_name"></span>
                    </div>
                    <div style="text-align:right;">
                        <strong>åœ°é»ï¼š</strong><span id="out_loc"></span><br>
                        <span id="out_loc_city" style="color:#e91e63; font-weight:bold;">(æœªå®šä½ç¸£å¸‚)</span><br>
                        <span id="out_gps" style="font-size:11px; color:#666;"></span>
                    </div>
                </div>
                
                <hr style="margin:8px 0; border:0; border-top:1px solid #ccc;">
                
                <div style="display:flex; align-items:center;">
                    <div style="flex:1; text-align:center;">
                        <div id="css-pie" class="pie-chart"></div>
                    </div>
                    <div style="flex:1; padding-left:10px;">
                        <table id="stats-table">
                            <thead><tr><th>åœ‹å®¶</th><th>æ•¸é‡</th></tr></thead>
                            <tbody id="stats-body"><tr><td colspan="2">ç„¡è³‡æ–™</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <img id="out_img" class="evidence-img">
            </div>
        </div>

        <label style="margin-top:10px;">ğŸ“¸ ç…§ç‰‡ä¸Šå‚³ (é¸å¡«)ï¼š</label>
        <input type="file" accept="image/*" onchange="previewImage(event)">

        <hr style="margin: 20px 0;">
        
        <label>â˜ï¸ é›²ç«¯å­˜æª” (éœ€ç¶²è·¯)ï¼š</label>
        <button id="btn-upload" onclick="uploadData()" class="btn-upload">ğŸ“¤ ä¸Šå‚³è³‡æ–™åˆ° Google Sheets</button>
    </div>

</body>
</html>
