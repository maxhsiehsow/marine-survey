<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V9 (è¨ºæ–·ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #e0f2f1; text-align: center; padding: 10px; margin: 0; padding-bottom: 100px; }
        .page { display: none; }
        #p1 { display: block; } /* é è¨­é¡¯ç¤ºç¬¬ä¸€é  */
        
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left; border: 1px solid #ccc; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 2px solid #b2dfdb; border-radius: 5px; font-size: 16px; background: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
        .btn-green { background: #2e7d32; }
        .btn-blue { background: #0277bd; }
        .btn-red { background: #c62828; }
        .btn-orange { background: #ef6c00; }

        /* é™¤éŒ¯è¦–çª—æ¨£å¼ */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: #333; color: #0f0; font-family: monospace;
            font-size: 12px; overflow-y: scroll; text-align: left;
            padding: 5px; z-index: 9999; opacity: 0.9;
        }
        
        #reader { width: 100%; background: black; display: none; margin-bottom: 10px; }
        #report-area { background: white; padding: 10px; text-align: center; border: 2px solid #00695c; }
        .evidence-img { width: 100%; display: none; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="debug-console">ç³»çµ±å•Ÿå‹•ä¸­...<br>è‹¥ç„¡åæ‡‰è«‹çœ‹é€™è£¡çš„éŒ¯èª¤è¨Šæ¯ã€‚<br></div>

    <div id="p1" class="page">
        <h1>ğŸ” æµ·å»¢èª¿æŸ¥ V9</h1>
        <div class="card">
            <h3>1. è¨­å®š</h3>
            <label>å§“åï¼š</label>
            <input type="text" id="inp_name" placeholder="è«‹è¼¸å…¥å§“å">
            <label>äººæ•¸ï¼š</label>
            <input type="number" id="inp_team" value="1">
        </div>
        <div class="card">
            <h3>2. å®šä½</h3>
            <button class="btn-blue" onclick="doGPS()">ğŸ“ æŠ“å– GPS</button>
            <input type="text" id="inp_gps" placeholder="å°šæœªå®šä½" readonly style="background:#eee;">
            <label>åœ°é»ï¼š</label>
            <input type="text" id="inp_loc" placeholder="ä¾‹å¦‚ï¼šå¤–æ¾³">
        </div>
        <button class="btn-green" onclick="goP2()">ä¸‹ä¸€æ­¥ â¡ï¸</button>
    </div>

    <div id="p2" class="page">
        <div class="card" style="text-align:center;">
            <b>é€²åº¦ï¼š<span id="txt_count" style="color:red; font-size:20px;">0</span> / 10</b>
            <button class="btn-orange" id="force-btn" style="display:none; font-size:14px;" onclick="goP3()">ğŸ å¼·åˆ¶çµç®—</button>
        </div>

        <div class="card">
            <h3>ğŸ“· æƒæ</h3>
            <div id="reader"></div>
            <button class="btn-blue" id="btn-cam-start" onclick="startCam()">å•Ÿå‹•ç›¸æ©Ÿ</button>
            <button class="btn-red" id="btn-cam-stop" onclick="stopCam()" style="display:none;">é—œé–‰ç›¸æ©Ÿ</button>
        </div>

        <div class="card">
            <h3>âŒ¨ï¸ æ‰‹å‹•</h3>
            <select id="sel_country">
                <option value="">ğŸ‘‡ é¸æ“‡åœ‹å®¶...</option>
                <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                <option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
                <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                <option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
                <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
                <option value="ğŸ‡®ğŸ‡© å°å°¼">ğŸ‡®ğŸ‡© å°å°¼</option>
                <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
                <option value="â“ ç„¡æ³•è¾¨è­˜">â“ ç„¡æ³•è¾¨è­˜</option>
            </select>
            <button class="btn-green" onclick="addRec()">è¨˜éŒ„</button>
        </div>
        <button class="btn-red" onclick="undo()" style="opacity:0.7">â†©ï¸ åˆªé™¤ä¸Šä¸€ç­†</button>
    </div>

    <div id="p3" class="page">
        <h1>ğŸ‰ å®Œæˆ</h1>
        <div class="card">
            <h3>ğŸ“¸ æ‹ç…§</h3>
            <input type="file" accept="image/*" onchange="loadImg(event)">
        </div>
        <div class="card">
            <div id="report-area">
                <h3 style="background:#00695c; color:white; margin:0; padding:5px;">æµ·å»¢å ±å‘Š</h3>
                <div style="text-align:left; font-size:14px; padding:5px;">
                    æ—¥æœŸï¼š<span id="out_date"></span><br>
                    äººå“¡ï¼š<span id="out_name"></span><br>
                    GPSï¼š<span id="out_gps"></span>
                </div>
                <canvas id="chart" style="max-height:200px;"></canvas>
                <img id="out_img" class="evidence-img">
            </div>
        </div>
        <button class="btn-orange" id="dl-btn" onclick="dlImg()">ğŸ“¥ ä¸‹è¼‰åœ–ç‰‡</button>
        <button class="btn-blue" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
    </div>

<script>
    // === é™¤éŒ¯å·¥å…· ===
    function log(msg) {
        var box = document.getElementById('debug-console');
        var time = new Date().toLocaleTimeString();
        box.innerHTML += "<div>[" + time + "] " + msg + "</div>";
        box.scrollTop = box.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        console.log(msg);
    }

    window.onerror = function(message, source, lineno, colno, error) {
        log("âŒ éŒ¯èª¤: " + message);
        return false;
    };

    // === æª¢æŸ¥ç¨‹å¼åº« ===
    window.onload = function() {
        log("ç³»çµ±è¼‰å…¥å®Œæˆ");
        if(typeof Html5Qrcode === 'undefined') log("âš ï¸ è­¦å‘Š: QR Code åº«è¼‰å…¥å¤±æ•—");
        if(typeof Chart === 'undefined') log("âš ï¸ è­¦å‘Š: Chart åº«è¼‰å…¥å¤±æ•—");
        if(typeof html2canvas === 'undefined') log("âš ï¸ è­¦å‘Š: æˆªåœ–åº«è¼‰å…¥å¤±æ•—");
    }

    // === è®Šæ•¸ ===
    var count = 0;
    var target = 10;
    var stats = {};
    var historyStack = [];
    var html5QrCode = null;

    // ===
