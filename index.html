<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V66 (å¤šåœ–+æ‰‹å‹•ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root { --primary: #0056b3; --bg: #f4f7f6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        .container { padding: 15px; display: none; animation: fadeIn 0.3s; }
        .active-tab { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: var(--primary); font-size: 18px; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; }
        label { display: block; margin: 8px 0 4px; font-weight: bold; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; background: #fff; }
        
        button, .btn { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; color: white; border: none; border-radius: 8px; text-align: center; }
        .btn-blue { background: #0288d1; } .btn-green { background: #2e7d32; } .btn-red { background: #d32f2f; }
        .btn-orange { background: #f57c00; } .btn-upload { background: #673ab7; }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
        
        /* åœ–ç‰‡é è¦½å€ */
        .img-preview-box { display: flex; gap: 10px; margin-top: 5px; overflow-x: auto; }
        .preview-item { width: 80px; height: 80px; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; border: 1px dashed #999; flex-shrink: 0; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-label { font-size: 10px; position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; text-align: center; }

        /* åº•éƒ¨å°èˆª */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; font-size: 12px; color: #999; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { display: block; font-size: 22px; margin-bottom: 2px; }

        /* ç›¸æ©Ÿèˆ‡ AI çµæœ */
        .camera-box { position: relative; display: none; background: #000; border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .scanner-view { width: 100%; min-height: 300px; }
        .btn-snap-div { width: 70px; height: 70px; background: rgba(255,255,255,0.9); border-radius: 50%; border: 4px solid var(--primary); display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 0 auto; position: absolute; bottom: 20px; left: 0; right: 0; z-index: 10; font-size: 30px; }
        
        .ai-result-box { display: none; border: 2px solid var(--primary); background: #e3f2fd; padding: 15px; border-radius: 12px; margin-top: 10px; text-align: center; }
        
        /* Loading Mask */
        #loading-mask { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); flex-direction:column; justify-content:center; align-items:center; z-index:9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* çµ±è¨ˆåœ–è¡¨ */
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; background: #eee; margin: 10px auto; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 5px; }
        th, td { border-bottom: 1px solid #eee; padding: 6px; }
    </style>
</head>
<body>

    <div id="loading-mask"><div class="spinner"></div><p id="loading-text">è¼‰å…¥ä¸­...</p></div>

    <div id="view-basic" class="container active-tab">
        <h2>ğŸ“ 1. åŸºæœ¬è³‡è¨Šèˆ‡ç…§ç‰‡</h2>
        <div class="card">
            <label>å¡«è¡¨äºº / åƒèˆ‡äººæ•¸</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_name" placeholder="æ‚¨çš„å§“å" style="flex:2;">
                <input type="number" id="inp_participants" value="1" min="1" style="flex:1; text-align:center;">
            </div>

            <label>åœ°é» / GPS</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="inp_gps" readonly placeholder="å°šæœªå®šä½" style="flex:2; font-size:12px; background:#f9f9f9;">
                <button onclick="runGPS()" class="btn-blue" style="flex:1; margin-top:0; padding:10px;">ğŸ“ å®šä½</button>
            </div>
            <input type="text" id="inp_loc" placeholder="åœ°é»åç¨± (å¦‚: è²¢å¯®æ²™ç˜)" style="margin-top:10px;">
            
            <label>ğŸ“¸ ç¾å ´ç…§ç‰‡ä¸Šå‚³ (é»æ“Šæ–¹å¡Š)</label>
            <div class="img-preview-box">
                <input type="file" id="file-env" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'env')">
                <input type="file" id="file-group" accept="image/*" style="display:none" onchange="handleImgUpload(this, 'group')">
                
                <div class="preview-item" onclick="document.getElementById('file-env').click()">
                    <img id="img-preview-env" src="" style="display:none">
                    <div class="preview-label">ç’°å¢ƒç…§</div>
                    <span id="icon-env" style="font-size:24px; color:#ccc;">ğŸï¸</span>
                </div>
                <div class="preview-item" onclick="document.getElementById('file-group').click()">
                    <img id="img-preview-group" src="" style="display:none">
                    <div class="preview-label">åˆç…§</div>
                    <span id="icon-group" style="font-size:24px; color:#ccc;">ğŸ‘¥</span>
                </div>
            </div>
        </div>
    </div>

    <div id="view-record" class="container">
        <h2>ğŸ“Š 2. è¨˜éŒ„èˆ‡çµ±è¨ˆ</h2>
        <div class="card">
            <div style="text-align:center; font-size:20px; font-weight:bold; margin-bottom:10px;">
                ç›®å‰æ”¶é›†: <span id="disp_count" style="color:var(--primary); font-size:32px;">0</span> / 100
            </div>
            
            <button id="btn-scan-start" onclick="startRecordScanner()" class="btn-orange">ğŸ“· æƒææ¢ç¢¼åŠ å…¥</button>
            <button id="btn-scan-stop" onclick="stopRecordScanner()" class="btn-red" style="display:none;">â¹ åœæ­¢æƒæ</button>
            <div id="camera-box-record" class="camera-box"><div id="reader-record" class="scanner-view"></div></div>

            <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">

            <label>ğŸ” æ¢ç¢¼å‰ 3 ç¢¼æŸ¥è©¢ (å¦‚ 471)</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="inp_prefix" placeholder="è¼¸å…¥ä»£ç¢¼" style="margin-bottom:0;">
                <button onclick="handlePrefixCheck()" class="btn-blue" style="width:80px; margin-top:0;">æŸ¥è©¢</button>
            </div>

            <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">

            <label>æ‰‹å‹•æ–°å¢</label>
            <div style="display:flex; gap:10px;">
                <select id="sel_country" style="flex:2;">
                    <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                    <option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
                    <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option>
                    <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
                    <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
                    <option value="ğŸ‡®ğŸ‡© å°å°¼">ğŸ‡®ğŸ‡© å°å°¼</option>
                    <option value="ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº">ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº</option>
                    <option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
                    <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
                    <option value="å…¶å®ƒ">â“ å…¶å®ƒ</option>
                </select>
                <input type="number" id="inp_qty" value="1" style="flex:1; text-align:center; margin-bottom:0;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="handleManualAdd()" class="btn-green">â• æ–°å¢</button>
                <button onclick="undoRecord()" class="btn-outline">â†©ï¸ å¾©åŸ</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex;">
                <div style="flex:1; text-align:center;"><div id="css-pie" class="pie-chart"></div></div>
                <div style="flex:1;"><table id="stats-table"><tbody id="stats-body"></tbody></table></div>
            </div>
            <label style="margin-top:15px;">ç“¶ç½ç‰¹å¯«ç…§ (ä¸Šå‚³è­‰æ“š)</label>
            <input type="file" accept="image/*" onchange="handleImgUpload(this, 'evidence')">
            <img id="img-preview-evidence" style="width:100%; height:150px; object-fit:cover; margin-top:5px; display:none; border-radius:8px;">
            <label style="margin-top:10px;">å‚™è¨»</label>
            <textarea id="inp_note" rows="2"></textarea>
            <button id="btn-upload" onclick="uploadData()" class="btn-upload" style="margin-top:15px;">ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯</button>
        </div>
    </div>

    <div id="view-ai" class="container">
        <h2>ğŸ¤– 3. AI é‘‘å®šå®¤</h2>
        <div class="card" style="text-align:center;">
            <p>æ‹ä¸€å¼µï¼ŒAI å¹«ä½ åˆ†é¡ï¼<br><small>å¦‚æœä¸æº–ï¼Œæ‚¨é‚„å¯ä»¥æ‰‹å‹•ä¿®æ­£å–”ã€‚</small></p>
            <button id="btn-ai-start" onclick="startAiCamera()" class="btn-blue">ğŸ“· å•Ÿå‹• AI ç›¸æ©Ÿ</button>
            
            <div id="camera-box-ai" class="camera-box">
                <div id="reader-ai" class="scanner-view"></div>
                <div onclick="takeAiSnapshot()" class="btn-snap-div">ğŸ“¸</div>
            </div>

            <div id="ai-result-box" class="ai-result-box">
                <img id="ai-preview-img" style="width:120px; height:120px; object-fit:cover; border-radius:8px; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                
                <h3 style="color:#0056b3; margin:10px 0 5px;">AI èªç‚ºæ˜¯ï¼š</h3>
                
                <select id="ai-country-select" style="font-size:18px; font-weight:bold; color:#333; padding:8px; border:2px solid #0056b3;">
                    </select>

                <p style="font-size:13px; color:#666; background:white; padding:5px; border-radius:4px; margin-top:5px;">ç‰¹å¾µï¼š<span id="ai-desc-text"></span></p>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button id="btn-google-check" class="btn-outline" style="font-size:14px;">ğŸ” Google æŸ¥è­‰</button>
                    <button id="btn-confirm-ai" class="btn-green">âœ… ç¢ºèªåŠ å…¥</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-basic" onclick="switchTab('basic')"><span>ğŸ“</span>åŸºæœ¬</div>
        <div class="nav-item" id="nav-record" onclick="switchTab('record')"><span>ğŸ“Š</span>è¨˜éŒ„</div>
        <div class="nav-item" id="nav-ai" onclick="switchTab('ai')"><span>ğŸ¤–</span>AI é‘‘å®š</div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // === å…¨å±€ç‹€æ…‹ ===
        const STATE = {
            count: 0, target: 100, stats: {}, historyStack: [],
            currentCity: "æœªå®šä½",
            imgs: { env: null, group: null, evidence: null }, // å„²å­˜ä¸‰å¼µåœ–çš„ Base64
            scanners: { record: null, ai: null }
        };

        const PREFIX_DB = {
            "471": "ğŸ‡¹ğŸ‡¼ å°ç£", "690": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "691": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "692": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "693": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", 
            "694": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "695": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "696": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹", "697": "ğŸ‡¨ğŸ‡³ ä¸­åœ‹",
            "893": "ğŸ‡»ğŸ‡³ è¶Šå—", "480": "ğŸ‡µğŸ‡­ è²å¾‹è³“", "955": "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº", "899": "ğŸ‡®ğŸ‡© å°å°¼", 
            "885": "ğŸ‡¹ğŸ‡­ æ³°åœ‹", "880": "ğŸ‡°ğŸ‡· éŸ“åœ‹", "450": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬", "490": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬"
        };
        
        const COLORS = {
            'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 
            'ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº': '#8d6e63', 'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#ff9800', 
            'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#212121', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#fbc02d', 'å…¶å®ƒ': '#757575'
        };

        // âš ï¸ è«‹ç¢ºèªé€™æ˜¯ V66 çš„ç¶²å€
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1kiaaRdWuUtBEBnjG-HuTqedenqisFug4zQ6pyCWXrT0Ja7TF4RCAicTA1Q3u8TA9/exec";

        // === æ ¸å¿ƒé‚è¼¯ ===
        function normalizeName(rawName) {
            if (!rawName) return "å…¶å®ƒ";
            let clean = rawName.toString().trim();
            if (clean.includes("å°ç£") || clean.includes("Taiwan") || clean.includes("ROC")) return "ğŸ‡¹ğŸ‡¼ å°ç£";
            if (clean.includes("ä¸­åœ‹") || clean.includes("China") || clean.includes("CN") || clean.includes("å¤§é™¸")) return "ğŸ‡¨ğŸ‡³ ä¸­åœ‹";
            if (clean.includes("è¶Šå—") || clean.includes("Vietnam")) return "ğŸ‡»ğŸ‡³ è¶Šå—";
            if (clean.includes("è²å¾‹è³“") || clean.includes("Philippines")) return "ğŸ‡µğŸ‡­ è²å¾‹è³“";
            if (clean.includes("æ³°åœ‹") || clean.includes("Thailand")) return "ğŸ‡¹ğŸ‡­ æ³°åœ‹";
            if (clean.includes("å°å°¼") || clean.includes("Indonesia")) return "ğŸ‡®ğŸ‡© å°å°¼";
            if (clean.includes("é¦¬ä¾†è¥¿äº") || clean.includes("Malaysia")) return "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº";
            if (clean.includes("éŸ“åœ‹") || clean.includes("Korea")) return "ğŸ‡°ğŸ‡· éŸ“åœ‹";
            if (clean.includes("æ—¥æœ¬") || clean.includes("Japan")) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬";
            // è‹¥ç‚ºæ¨™æº–æ ¼å¼å‰‡ç›´æ¥å›å‚³
            if (Object.values(PREFIX_DB).includes(clean)) return clean;
            if (Object.keys(COLORS).includes(clean)) return clean;
            return "å…¶å®ƒ"; // é è¨­æ­¸é¡ç‚ºå…¶å®ƒ
        }

        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active-tab'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active-tab');
            document.getElementById('nav-' + tabName).classList.add('active');
            stopRecordScanner(); stopAiScanner();
        }

        // === åœ–ç‰‡è™•ç† (é€šç”¨ç‰ˆ) ===
        function handleImgUpload(input, type) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                // é¡¯ç¤ºé è¦½
                const imgId = type === 'evidence' ? 'img-preview-evidence' : `img-preview-${type}`;
                const imgEl = document.getElementById(imgId);
                imgEl.src = e.target.result;
                imgEl.style.display = 'block';
                if(type !== 'evidence') document.getElementById(`icon-${type}`).style.display = 'none';

                // å£“ç¸®ä¸¦å„²å­˜ Base64
                const temp = new Image();
                temp.src = e.target.result;
                temp.onload = function() {
                    const cvs = document.createElement('canvas');
                    let s = 1024 / temp.width; if (s > 1) s = 1;
                    cvs.width = temp.width * s; cvs.height = temp.height * s;
                    cvs.getContext('2d').drawImage(temp, 0, 0, cvs.width, cvs.height);
                    STATE.imgs[type] = cvs.toDataURL('image/jpeg', 0.7).split(',')[1];
                }
            };
            reader.readAsDataURL(file);
        }

        // === AI é‘‘å®š (å«ä¸‹æ‹‰é¸å–®ä¿®æ­£) ===
        function takeAiSnapshot() {
            var videoEl = document.querySelector("#reader-ai video");
            if (!videoEl) { alert("ç›¸æ©Ÿæœªå•Ÿå‹•"); return; }
            videoEl.pause();
            document.getElementById('loading-mask').style.display = 'flex';

            var cvs = document.createElement("canvas");
            var max = 800; var w = videoEl.videoWidth; var h = videoEl.videoHeight;
            var s = (w>h ? (w>max?max/w:1) : (h>max?max/h:1));
            cvs.width = w*s; cvs.height = h*s;
            cvs.getContext("2d").drawImage(videoEl, 0, 0, cvs.width, cvs.height);
            var b64Full = cvs.toDataURL("image/jpeg", 0.6);
            
            stopAiScanner();

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ action: "identify", image: b64Full.split(',')[1] })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading-mask').style.display = 'none';
                if (data.status === "success") {
                    try {
                        var raw = typeof data.result === 'string' ? data.result : JSON.stringify(data.result);
                        var match = raw.match(/\{[\s\S]*\}/);
                        if (match) displayAiResult(JSON.parse(match[0]), b64Full);
                        else alert("AI æ ¼å¼éŒ¯èª¤: " + raw);
                    } catch(e) { alert("è§£æå¤±æ•—: " + e.message); }
                } else { alert("å¾Œç«¯éŒ¯èª¤: " + data.message); }
            })
            .catch(err => { document.getElementById('loading-mask').style.display = 'none'; alert("é€£ç·šå¤±æ•—: " + err); });
        }

        function displayAiResult(data, imgSrc) {
            const box = document.getElementById('ai-result-box');
            box.style.display = 'block';
            document.getElementById('ai-preview-img').src = imgSrc;
            document.getElementById('ai-desc-text').innerText = data.keywords || "ç„¡ç‰¹å¾µ";

            // 1. åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
            const select = document.getElementById('ai-country-select');
            select.innerHTML = ""; // æ¸…ç©º
            
            // 2. åˆ¤æ–· AI çš„å»ºè­°
            let aiGuess = normalizeName(data.country); // æŠŠ "æœªå®š" è½‰æˆ "å…¶å®ƒ" æˆ–å°æ‡‰åœ‹å®¶
            
            // 3. å»ºç«‹é¸é … (æŠŠæ‰€æœ‰åœ‹å®¶éƒ½åˆ—å‡ºä¾†ï¼Œæ–¹ä¾¿ä¿®æ­£)
            // å…ˆæŠŠ AI çŒœçš„æ”¾ç¬¬ä¸€å€‹ (å¦‚æœä¸æ˜¯å…¶å®ƒ)
            if (aiGuess !== "å…¶å®ƒ") {
                select.add(new Option(`ğŸ¤– AI: ${aiGuess}`, aiGuess, true, true));
                select.add(new Option("---", "disabled", false, false));
            }
            // åˆ—å‡ºæ‰€æœ‰å›ºå®šé¸é …
            for (let c of Object.keys(COLORS)) {
                if (c !== aiGuess) select.add(new Option(c, c));
            }
            // å¦‚æœ AI çŒœæ˜¯å…¶å®ƒï¼Œé è¨­é¸ä¸­å…¶å®ƒ
            if (aiGuess === "å…¶å®ƒ") select.value = "å…¶å®ƒ";

            // 4. Google æŸ¥è­‰æŒ‰éˆ• (ä¿®å¾©)
            // çµ„åˆé—œéµå­—: åœ‹å®¶ + é—œéµå­— + bottle
            const query = `${data.country || ""} ${data.keywords || ""} bottle`.trim();
            const gBtn = document.getElementById('btn-google-check');
            gBtn.onclick = () => window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank');

            // 5. ç¢ºèªåŠ å…¥æŒ‰éˆ•
            document.getElementById('btn-confirm-ai').onclick = () => {
                const finalChoice = select.value;
                if (finalChoice === "disabled") return;
                addRecord(finalChoice, 1);
                box.style.display = 'none';
                switchTab('record');
            };
        }

        // === æ¢ç¢¼èˆ‡è¨˜éŒ„ ===
        function handlePrefixCheck() {
            const code = document.getElementById('inp_prefix').value;
            if (!code || code.length < 3) { alert("è«‹è¼¸å…¥è‡³å°‘ 3 ç¢¼"); return; }
            const country = PREFIX_DB[code.substring(0, 3)];
            if (country) {
                if(confirm(`æŸ¥è©¢çµæœï¼š${country}\nè¦åŠ å…¥å—ï¼Ÿ`)) {
                    addRecord(country, 1);
                    document.getElementById('inp_prefix').value = "";
                }
            } else {
                alert("âŒ æŸ¥ç„¡æ­¤ä»£ç¢¼æ­¸å±¬");
            }
        }

        function addRecord(country, qty) {
            let safeName = normalizeName(country);
            if (!STATE.stats[safeName]) STATE.stats[safeName] = 0;
            STATE.stats[safeName] += qty;
            STATE.count += qty;
            for(let i=0; i<qty; i++) STATE.historyStack.push({key: safeName, qty: 1});
            updateUI();
        }

        function undoRecord() {
            if (STATE.historyStack.length === 0) return;
            const last = STATE.historyStack.pop();
            STATE.stats[last.key] -= last.qty;
            if (STATE.stats[last.key] <= 0) delete STATE.stats[last.key];
            STATE.count -= last.qty;
            updateUI();
        }
        
        function handleManualAdd() {
            addRecord(document.getElementById('sel_country').value, parseInt(document.getElementById('inp_qty').value));
        }

        function updateUI() {
            document.getElementById('disp_count').innerText = STATE.count;
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = "";
            let grad = [], deg = 0;
            if (STATE.count === 0) {
                document.getElementById('css-pie').style.background = "#eee"; return;
            }
            for (const [key, val] of Object.entries(STATE.stats)) {
                const color = COLORS[key] || '#757575';
                const pct = ((val / STATE.count) * 100).toFixed(1);
                tbody.innerHTML += `<tr><td><span style='color:${color}'>â– </span> ${key} <small>(${pct}%)</small></td><td>${val}</td></tr>`;
                const d = (val / STATE.count) * 360;
                grad.push(`${color} ${deg}deg ${deg + d}deg`);
                deg += d;
            }
            document.getElementById('css-pie').style.background = `conic-gradient(${grad.join(", ")})`;
        }

      function uploadData() {
            if (STATE.count === 0) { alert("ç„¡è³‡æ–™"); return; }
            var btn = document.getElementById('btn-upload');
            btn.innerText = "â³ ä¸Šå‚³ä¸­..."; btn.disabled = true;

            // æº–å‚™çµ±è¨ˆè³‡æ–™ (ç¢ºä¿æ¯å€‹åœ‹å®¶éƒ½æœ‰æ¬„ä½ï¼Œå³ä½¿æ˜¯ 0)
            let statsOut = { 
                cnt_tw:0, cnt_cn:0, cnt_vn:0, cnt_ph:0, cnt_my:0, 
                cnt_id:0, cnt_th:0, cnt_kr:0, cnt_jp:0, cnt_other:"" 
            };
            let others = [];

            for(let k in STATE.stats) {
                // æ¨¡ç³Šæ¯”å°ï¼Œæ­¸é¡åˆ°æ­£ç¢ºçš„æ¬„ä½
                if(k.includes("å°ç£")) statsOut.cnt_tw += STATE.stats[k];
                else if(k.includes("ä¸­åœ‹")) statsOut.cnt_cn += STATE.stats[k];
                else if(k.includes("è¶Šå—")) statsOut.cnt_vn += STATE.stats[k];
                else if(k.includes("è²å¾‹è³“")) statsOut.cnt_ph += STATE.stats[k];
                else if(k.includes("æ³°åœ‹")) statsOut.cnt_th += STATE.stats[k];
                else if(k.includes("å°å°¼")) statsOut.cnt_id += STATE.stats[k];
                else if(k.includes("é¦¬ä¾†è¥¿äº")) statsOut.cnt_my += STATE.stats[k];
                else if(k.includes("éŸ“åœ‹")) statsOut.cnt_kr += STATE.stats[k];
                else if(k.includes("æ—¥æœ¬")) statsOut.cnt_jp += STATE.stats[k];
                else others.push(`${k}*${STATE.stats[k]}`);
            }
            statsOut.cnt_other = others.join(", ");

            var payload = {
                action: "save",
                name: document.getElementById('inp_name').value,
                participants: document.getElementById('inp_participants').value,
                loc: document.getElementById('inp_loc').value,
                city: STATE.currentCity,
                gps: document.getElementById('inp_gps').value,
                total: STATE.count,
                note: document.getElementById('inp_note').value,
                // ä¸‰å¼µåœ–ç‰‡
                fileData: STATE.imgs.evidence || "",
                envData: STATE.imgs.env || "",
                groupData: STATE.imgs.group || "",
                // å±•é–‹çµ±è¨ˆæ•¸æ“š
                ...statsOut
            };

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
                // é‡ç½®æ‰€æœ‰ç‹€æ…‹
                STATE.count=0; STATE.stats={}; STATE.historyStack=[]; 
                STATE.imgs = { env: null, group: null, evidence: null };
                
                // é‡ç½®ä»‹é¢
                document.getElementById('img-preview-env').src=""; 
                document.getElementById('img-preview-env').style.display='none'; 
                document.getElementById('icon-env').style.display='block';

                document.getElementById('img-preview-group').src=""; 
                document.getElementById('img-preview-group').style.display='none'; 
                document.getElementById('icon-group').style.display='block';

                document.getElementById('img-preview-evidence').src="";
                document.getElementById('img-preview-evidence').style.display='none';
                
                document.getElementById('inp_note').value = "";
                document.getElementById('file-env').value = "";
                document.getElementById('file-group').value = "";

                updateUI(); switchTab('basic');
            })
            .catch(err => alert("ä¸Šå‚³å¤±æ•—: " + err))
            .finally(() => { btn.innerText = "ğŸš€ ä¸Šå‚³è³‡æ–™è‡³é›²ç«¯"; btn.disabled = false; });
        }
        // ç›¸æ©Ÿå•Ÿå‹•å™¨ (ä¿æŒåŸæ¨£)
        function startRecordScanner() {
            if (STATE.scanners.record) return;
            document.getElementById('camera-box-record').style.display = 'block';
            document.getElementById('btn-scan-start').style.display = 'none';
            document.getElementById('btn-scan-stop').style.display = 'inline-block';
            STATE.scanners.record = new Html5Qrcode("reader-record");
            STATE.scanners.record.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (txt) => {
                    STATE.scanners.record.pause();
                    const c = getCountryFromCode(txt);
                    if(confirm(`æƒæï¼š${c}\nåŠ å…¥å—ï¼Ÿ`)) { addRecord(c, 1); }
                    setTimeout(()=>STATE.scanners.record.resume(), 500);
                }, ()=>{}
            );
        }
        function stopRecordScanner() {
            if(STATE.scanners.record) STATE.scanners.record.stop().then(()=>{STATE.scanners.record.clear(); STATE.scanners.record=null;}).catch(()=>{});
            document.getElementById('camera-box-record').style.display='none';
            document.getElementById('btn-scan-start').style.display='inline-block';
            document.getElementById('btn-scan-stop').style.display='none';
        }
        function startAiCamera() {
            document.getElementById('ai-result-box').style.display='none';
            document.getElementById('camera-box-ai').style.display='block';
            document.getElementById('btn-ai-start').style.display='none';
            STATE.scanners.ai = new Html5Qrcode("reader-ai");
            STATE.scanners.ai.start({ facingMode: "environment" }, { fps: 10 }, ()=>{}, ()=>{});
        }
        function stopAiScanner() {
            if(STATE.scanners.ai) STATE.scanners.ai.stop().then(()=>{STATE.scanners.ai.clear(); STATE.scanners.ai=null;}).catch(()=>{});
            document.getElementById('camera-box-ai').style.display='none';
            document.getElementById('btn-ai-start').style.display='inline-block';
        }
        function getCountryFromCode(code) { return (code && code.length>=3) ? (PREFIX_DB[code.substring(0,3)]||"æœªçŸ¥") : "æœªçŸ¥"; }
        function runGPS() {
            document.getElementById('inp_gps').value="å®šä½ä¸­...";
            navigator.geolocation.getCurrentPosition(p=>{
                document.getElementById('inp_gps').value=`${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`;
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&localityLanguage=zh`).then(r=>r.json()).then(d=>{STATE.currentCity=(d.principalSubdivision||"").replace("Province","").trim(); document.getElementById('inp_loc').value=STATE.currentCity;});
            }, ()=>{alert("å®šä½å¤±æ•—"); document.getElementById('inp_gps').value="";});
        }
    </script>
</body>
</html>


