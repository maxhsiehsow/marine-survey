<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å»¢èª¿æŸ¥å“¡ V23</title>

    <style>
        /* åŸºç¤è¨­å®š */
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 80px; color: #333; }
        
        .card { 
            background: white; padding: 15px; border-radius: 12px; 
            margin-bottom: 15px; border: 1px solid #ddd; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h2 { margin-top: 0; color: #0056b3; font-size: 18px; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; }
        
        input, select { 
            width: 100%; padding: 12px; font-size: 16px; margin: 5px 0 15px 0; 
            border: 2px solid #cfd8dc; border-radius: 8px; background: #fff; box-sizing: border-box;
        }

        button { 
            width: 100%; padding: 14px; font-size: 16px; font-weight: bold; 
            margin-top: 5px; cursor: pointer; color: white; border: none; border-radius: 8px; 
        }
        .btn-blue { background: #0288d1; }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #d32f2f; }
        .btn-orange { background: #f57c00; }

        /* CSS ç´”ä»£ç¢¼åœ“é¤…åœ– (ç¸®å°ç‰ˆï¼Œæ–¹ä¾¿æˆªåœ–) */
        .pie-chart {
            width: 120px; height: 120px; border-radius: 50%; /* ç¸®å°å°ºå¯¸ */
            background: conic-gradient(#eee 0% 100%);
            margin: 10px auto; border: 1px solid #ccc;
        }

        /* æƒæè¦–çª— */
        #reader { width: 100%; background: #000; display: none; margin-bottom: 10px; min-height: 200px; }

        /* å ±å‘Šå€ (ç·Šæ¹Šæ’ç‰ˆ) */
        #report-layout {
            border: 3px solid #0056b3; background: white; padding: 0;
        }
        .rep-head { background: #0056b3; color: white; padding: 8px; text-align: center; font-weight: bold; }
        .rep-body { padding: 10px; font-size: 13px; line-height: 1.4; }
        
        /* ç…§ç‰‡ç¸®åœ–è¨­å®š (é—œéµä¿®æ”¹) */
        .evidence-img { 
            width: 100%; 
            height: 150px;       /* å›ºå®šé«˜åº¦ */
            object-fit: cover;   /* è£åˆ‡å¡«æ»¿ï¼Œä¿æŒç¾è§€ */
            object-position: center;
            display: none; 
            margin-top: 5px; 
            border: 1px solid #333; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
        
        /* è¼‰å…¥æç¤º */
        #scan-loading { display: none; color: #f57c00; font-weight: bold; margin-bottom: 5px; }
    </style>

    <script>
        // === 1. åˆå§‹åŒ– ===
        window.onload = function() {
            // å¡«å…¥æ—¥æœŸ
            var d = new Date();
            document.getElementById('out_date').innerText = d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate();
        };

        // === è®Šæ•¸ ===
        var count = 0;
        var stats = {};
        var historyStack = [];
        var html5QrCode = null;
        var isLibLoaded = false;

        // å®šç¾©é¡è‰²
        var colors = {
            'ğŸ‡¹ğŸ‡¼ å°ç£': '#e53935', 'ğŸ‡¨ğŸ‡³ ä¸­åœ‹': '#1e88e5', 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬': '#43a047',
            'ğŸ‡°ğŸ‡· éŸ“åœ‹': '#fdd835', 'ğŸ‡»ğŸ‡³ è¶Šå—': '#8e24aa', 'ğŸ‡¹ğŸ‡­ æ³°åœ‹': '#fb8c00',
            'ğŸ‡®ğŸ‡© å°å°¼': '#00acc1', 'ğŸ‡µğŸ‡­ è²å¾‹è³“': '#6d4c41', 'ğŸ‡ºğŸ‡¸ ç¾åœ‹': '#546e7a',
            'â“ ç„¡æ³•è¾¨è­˜': '#757575'
        };

        // === 2. å‹•æ…‹è¼‰å…¥æƒæåº« (é—œéµåŠŸèƒ½) ===
        function loadScannerAndStart() {
            if (isLibLoaded) {
                startCamera(); // å·²ç¶“è¼‰å…¥éï¼Œç›´æ¥é–‹
                return;
            }

            document.getElementById('scan-loading').style.display = 'block';
            document.getElementById('scan-loading').innerText = "â³ æ­£åœ¨ä¸‹è¼‰æƒææ¨¡çµ„ï¼Œè«‹ç¨å€™...";

            var script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js";
            
            script.onload = function() {
                isLibLoaded = true;
                document.getElementById('scan-loading').style.display = 'none';
                startCamera();
            };
            
            script.onerror = function() {
                document.getElementById('scan-loading').style.display = 'none';
                alert("âŒ ç¶²è·¯å°é–äº†æƒæåŠŸèƒ½ã€‚\nè«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œæ‰‹å‹•é¸æ“‡ã€ç¹¼çºŒèª¿æŸ¥ã€‚");
            };
            
            document.head.appendChild(script);
        }

        // === 3. å•Ÿå‹•ç›¸æ©Ÿ ===
        function startCamera() {
            document.getElementById('reader').style.display = 'block';
            document.getElementById('btn-scan').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';

            try {
                html5QrCode = new Html5Qrcode("reader");
                // è¨­å®šæ”¯æ´æ¢ç¢¼ (EAN_13) å’Œ QR Code
                var config = { fps: 10, qrbox: 200, experimentalFeatures: { useBarCodeDetectorIfSupported: true } };
                
                html5QrCode.start({ facingMode: "environment" }, config,
                    function(decodedText) {
                        // æƒææˆåŠŸ
                        playBeep();
                        stopCamera();
                        
                        var country = identifyBarcode(decodedText);
                        alert("ğŸ“· æƒææˆåŠŸï¼\næ¢ç¢¼: " + decodedText + "\nåˆ¤æ–·: " + country);
                        
                        addRecord(country);
                    },
                    function(err) {} // å¿½ç•¥æƒæéç¨‹ä¸­çš„éŒ¯èª¤
                ).catch(err => {
                    alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•— (è«‹ç¢ºèª HTTPS é€£ç·š)");
                    stopCamera();
                });
            } catch(e) {
                alert("ç›¸æ©Ÿæ¨¡çµ„éŒ¯èª¤ï¼Œè«‹æ”¹ç”¨æ‰‹å‹•");
                stopCamera();
            }
        }

        function stopCamera() {
            if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(()=>{});
            document.getElementById('reader').style.display = 'none';
            document.getElementById('btn-scan').style.display = 'inline-block';
            document.getElementById('btn-stop').style.display = 'none';
        }

        // === 4. æ¢ç¢¼è¾¨è­˜é‚è¼¯ ===
        function identifyBarcode(code) {
            if(!code || code.length < 3) return "â“ ç„¡æ³•è¾¨è­˜";
            var p = parseInt(code.substring(0,3));
            
            if(p==471) return "ğŸ‡¹ğŸ‡¼ å°ç£";
            if(p>=690 && p<=699) return "ğŸ‡¨ğŸ‡³ ä¸­åœ‹";
            if(p>=450 && p<=459) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬";
            if(p>=490 && p<=499) return "ğŸ‡¯ğŸ‡µ æ—¥æœ¬";
            if(p==880) return "ğŸ‡°ğŸ‡· éŸ“åœ‹";
            if(p==893) return "ğŸ‡»ğŸ‡³ è¶Šå—";
            if(p==885) return "ğŸ‡¹ğŸ‡­ æ³°åœ‹";
            if(p==899) return "ğŸ‡®ğŸ‡© å°å°¼";
            if(p==480) return "ğŸ‡µğŸ‡­ è²å¾‹è³“";
            if(p==955) return "ğŸ‡²ğŸ‡¾ é¦¬ä¾†è¥¿äº";
            if(p>=0 && p<=139) return "ğŸ‡ºğŸ‡¸ ç¾åœ‹";
            
            return "â“ ç„¡æ³•è¾¨è­˜";
        }

        // === 5. å…¶ä»–æ ¸å¿ƒåŠŸèƒ½ ===
        function runGPS() {
            var field = document.getElementById('inp_gps');
            field.value = "å®šä½ä¸­...";
            if(!navigator.geolocation) { alert("ä¸æ”¯æ´ GPS"); return; }
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    var txt = pos.coords.latitude.toFixed(5) + ", " + pos.coords.longitude.toFixed(5);
                    field.value = txt;
                    document.getElementById('out_gps').innerText = txt;
                    alert("å®šä½æˆåŠŸ");
                },
                function(err) { field.value = "å®šä½å¤±æ•—"; alert("å®šä½å¤±æ•—"); }
            );
        }

        function syncData() {
            document.getElementById('out_name').innerText = document.getElementById('inp_name').value;
            document.getElementById('out_loc').innerText = document.getElementById('inp_loc').value;
        }

        function addRecord(scannedVal) {
            var val = scannedVal;
            if(!val) val = document.getElementById('sel_country').value;
            if(!val) { alert("è«‹é¸æ“‡åœ‹å®¶"); return; }

            if(!stats[val]) stats[val] = 0;
            stats[val]++;
            count++;
            historyStack.push(val);

            document.getElementById('disp_count').innerText = count;
            document.getElementById('sel_country').value = ""; // é‡ç½®é¸å–®

            renderTable();
            drawCssChart();
            
            if(count == 10) alert("ğŸ‰ å·²æ»¿ 10 å€‹ï¼è«‹æˆªåœ–ä¿å­˜å ±å‘Šã€‚");
        }

        function undoRecord() {
            if(count <= 0) return;
            var last = historyStack.pop();
            stats[last]--;
            if(stats[last] === 0) delete stats[last];
            count--;
            document.getElementById('disp_count').innerText = count;
            renderTable();
            drawCssChart();
        }

        // === 6. æ¸²æŸ“ç•«é¢ ===
        function renderTable() {
            var tbody = document.getElementById('stats-body');
            tbody.innerHTML = "";
            if(count === 0) { tbody.innerHTML = "<tr><td colspan='2'>ç„¡è³‡æ–™</td></tr>"; return; }
            for(var key in stats) {
                var tr = document.createElement('tr');
                tr.innerHTML = "<td><span style='color:"+colors[key]+"'>â– </span> " + key + "</td><td>" + stats[key] + "</td>";
                tbody.appendChild(tr);
            }
        }

        function drawCssChart() {
            if(count === 0) {
                document.getElementById('css-pie').style.background = "#eee";
                return;
            }
            var gradientStr = [];
            var currentDeg = 0;
            for(var key in stats) {
                var percent = stats[key] / count;
                var deg = percent * 360;
                var color = colors[key] || '#999';
                gradientStr.push(color + " " + currentDeg.toFixed(1) + "deg " + (currentDeg + deg).toFixed(1) + "deg");
                currentDeg += deg;
            }
            document.getElementById('css-pie').style.background = "conic-gradient(" + gradientStr.join(", ") + ")";
        }

        function previewImage(event) {
            var file = event.target.files[0];
            if(file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = document.getElementById('out_img');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }
        
        function playBeep() {
            try { if(navigator.vibrate) navigator.vibrate(200); } catch(e){}
        }
    </script>
</head>
<body>

    <h1>ğŸ“‹ æµ·å»¢èª¿æŸ¥å“¡ V23</h1>

    <div class="card">
        <h2>1. è¨­å®š</h2>
        <label>å§“åï¼š</label>
        <input type="text" id="inp_name" placeholder="è¼¸å…¥å§“å" oninput="syncData()">
        <label>GPS / åœ°é»ï¼š</label>
        <button onclick="runGPS()" class="btn-blue" style="margin-bottom:5px;">ğŸ“ æŠ“å–åº§æ¨™</button>
        <input type="text" id="inp_gps" readonly value="å°šæœªå®šä½" style="background:#f1f8e9;">
        <input type="text" id="inp_loc" placeholder="è¼¸å…¥åœ°é»åç¨±" oninput="syncData()">
    </div>

    <div class="card">
        <h2>2. è¨˜éŒ„ (æƒæ/æ‰‹å‹•)</h2>
        <div style="text-align:center; font-size:20px; font-weight:bold; margin-bottom:10px;">
            æ•¸é‡ï¼š<span id="disp_count" style="color:red;">0</span> / 10
        </div>
        
        <div id="scan-loading"></div>
        <div id="reader"></div>
        <button id="btn-scan" onclick="loadScannerAndStart()" class="btn-orange">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒæ¢ç¢¼</button>
        <button id="btn-stop" onclick="stopCamera()" class="btn-red" style="display:none;">â¹ é—œé–‰ç›¸æ©Ÿ</button>

        <label style="margin-top:15px;">æˆ–æ‰‹å‹•é¸æ“‡ï¼š</label>
        <select id="sel_country">
            <option value="">ğŸ‘‡ é»æ­¤é¸æ“‡...</option>
            <option value="ğŸ‡¹ğŸ‡¼ å°ç£">ğŸ‡¹ğŸ‡¼ å°ç£</option>
            <option value="ğŸ‡¨ğŸ‡³ ä¸­åœ‹">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</option>
            <option value="ğŸ‡¯ğŸ‡µ æ—¥æœ¬">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</option>
            <option value="ğŸ‡°ğŸ‡· éŸ“åœ‹">ğŸ‡°ğŸ‡· éŸ“åœ‹</option>
            <option value="ğŸ‡»ğŸ‡³ è¶Šå—">ğŸ‡»ğŸ‡³ è¶Šå—</option>
            <option value="ğŸ‡¹ğŸ‡­ æ³°åœ‹">ğŸ‡¹ğŸ‡­ æ³°åœ‹</option>
            <option value="ğŸ‡®ğŸ‡© å°å°¼">ğŸ‡®ğŸ‡© å°å°¼</option>
            <option value="ğŸ‡µğŸ‡­ è²å¾‹è³“">ğŸ‡µğŸ‡­ è²å¾‹è³“</option>
            <option value="ğŸ‡ºğŸ‡¸ ç¾åœ‹">ğŸ‡ºğŸ‡¸ ç¾åœ‹</option>
            <option value="â“ ç„¡æ³•è¾¨è­˜">â“ ç„¡æ³•è¾¨è­˜</option>
        </select>

        <button onclick="addRecord()" class="btn-green">â• å¢åŠ ä¸€ç­†</button>
        <button onclick="undoRecord()" class="btn-red">â†©ï¸ åˆªé™¤ä¸Šä¸€ç­†</button>
    </div>

    <div class="card">
        <h2>3. å ±å‘Š (è«‹æˆªåœ–)</h2>
        
        <div id="report-layout">
            <div class="rep-head">æµ·å»¢èª¿æŸ¥é›»å­å ±å‘Š</div>
            <div class="rep-body">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <strong>æ—¥æœŸï¼š</strong><span id="out_date"></span><br>
                        <strong>å§“åï¼š</strong><span id="out_name"></span>
                    </div>
                    <div style="text-align:right;">
                        <strong>åœ°é»ï¼š</strong><span id="out_loc"></span><br>
                        <span id="out_gps" style="font-size:11px; color:#666;"></span>
                    </div>
                </div>
                
                <hr style="margin:8px 0; border:0; border-top:1px solid #ccc;">
                
                <div style="display:flex; align-items:center;">
                    <div style="flex:1; text-align:center;">
                        <div id="css-pie" class="pie-chart"></div>
                    </div>
                    <div style="flex:1; padding-left:10px;">
                        <table id="stats-table">
                            <thead><tr><th>åœ‹å®¶</th><th>æ•¸é‡</th></tr></thead>
                            <tbody id="stats-body"><tr><td colspan="2">ç„¡è³‡æ–™</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <img id="out_img" class="evidence-img">
            </div>
        </div>

        <label style="margin-top:10px;">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ (è‡ªå‹•ç¸®åœ–)ï¼š</label>
        <input type="file" accept="image/*" onchange="previewImage(event)">
    </div>

</body>
</html>
