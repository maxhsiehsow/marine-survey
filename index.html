<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>海廢調查員 V20</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 100px; color: #333; }
        
        /* 狀態列 */
        #status-bar {
            background: #333; color: #fff; font-size: 12px; padding: 5px; 
            margin-bottom: 10px; border-radius: 5px; text-align: center;
        }
        .badge { padding: 2px 6px; border-radius: 4px; margin: 0 5px; font-weight: bold; }
        .bg-green { background: #28a745; color: white; }
        .bg-red { background: #dc3545; color: white; }

        .card { 
            background: white; padding: 15px; border-radius: 10px; 
            margin-bottom: 15px; border: 1px solid #ccc; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h2 { margin-top: 0; color: #0056b3; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        input, select { 
            width: 100%; padding: 12px; font-size: 16px; margin: 5px 0 15px 0; 
            border: 2px solid #ccc; border-radius: 5px; box-sizing: border-box; background: #fff;
        }

        button { 
            width: 100%; padding: 15px; font-size: 18px; font-weight: bold; 
            margin-top: 5px; cursor: pointer; color: white; border: none; border-radius: 5px; 
        }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-orange { background: #fd7e14; }

        /* 相機視窗 */
        #reader { width: 100%; background: black; display: none; margin-bottom: 10px; border-radius: 5px; }

        /* 報告區塊 */
        #report-section {
            background: #fff; border: 3px solid #0056b3; padding: 10px; display: block;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #999; padding: 8px; text-align: left; }
    </style>

    <script>
        // === 變數 ===
        var count = 0;
        var stats = {};
        var historyStack = [];
        var html5QrCode = null;
        var myChart = null; // 圖表物件

        // === 系統自我檢查 ===
        window.onload = function() {
            var camStatus = document.getElementById('status-cam');
            var chartStatus = document.getElementById('status-chart');

            if(typeof Html5Qrcode !== 'undefined') {
                camStatus.className = "badge bg-green"; camStatus.innerText = "相機 OK";
            } else {
                camStatus.className = "badge bg-red"; camStatus.innerText = "相機 X";
            }

            if(typeof Chart !== 'undefined') {
                chartStatus.className = "badge bg-green"; chartStatus.innerText = "圖表 OK";
            } else {
                chartStatus.className = "badge bg-red"; chartStatus.innerText = "圖表 X";
            }

            // 填入日期
            var d = new Date();
            document.getElementById('out_date').innerText = d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate();
        };

        // === 同步資料 ===
        window.syncData = function() {
            document.getElementById('out_name').innerText = document.getElementById('inp_name').value;
            document.getElementById('out_loc').innerText = document.getElementById('inp_loc').value;
        };

        // === GPS ===
        window.runGPS = function() {
            var field = document.getElementById('inp_gps');
            field.value = "定位中...";

            if(!navigator.geolocation)
