<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†å“å¿«æœåµæ¢ V6 (ç©©å®šç‰ˆ)</title>
    <style>
        :root { --primary: #587a30; --bg: #f4f7f4; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 480px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-scan { background: #f57c00; }
        .btn-ai { background: #0288d1; }
        .btn-reset { background: #607d8b; margin-top: 20px; }
        
        #camera-box, #result-box { display: none; margin-top: 15px; border-radius: 12px; overflow: hidden; }
        #camera-box { background: #000; position: relative; min-height: 300px; } /* è¨­å®šæœ€å°é«˜åº¦é¿å…é–ƒçˆ */
        .scanner-view { width: 100%; height: 100%; }
        
        .btn-snap { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.9); border: 4px solid var(--primary); z-index: 10; font-size: 30px; display: flex; align-items: center; justify-content: center; color: #333; cursor: pointer; }

        .result-card { background: #e8f5e9; border: 2px solid var(--primary); padding: 20px; border-radius: 12px; }
        .result-id { font-size: 12px; color: #999; text-align: right; margin-bottom: 5px; }
        
        .result-title { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 5px; line-height: 1.3; }
        .result-label { font-size: 12px; color: #666; margin-top: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .result-val { font-size: 16px; color: #333; font-weight: 500; }
        
        .info-row { display: flex; gap: 15px; margin-top: 5px; }
        .info-col { flex: 1; }

        #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ” å•†å“å¿«æœåµæ¢ V6</h1>
        
        <div class="btn-group">
            <button class="btn-scan" onclick="startScanner()">ğŸ“· æƒæ¢ç¢¼</button>
            <button class="btn-ai" onclick="startAiCam()">ğŸ¤– AI è¾¨è­˜</button>
        </div>

        <div id="camera-box">
            <div id="reader" class="scanner-view"></div>
            <div id="ai-snap-btn" class="btn-snap" onclick="takeSnapshot()" style="display:none;">ğŸ“¸</div>
        </div>

        <div id="result-box">
            <div class="result-card">
                <div class="result-id">
                    <span id="res-source">ä¾†æº: -</span> 
                    <span id="res-id" style="margin-left:10px;"></span>
                </div>
                
                <div class="result-title" id="res-name">å•†å“åç¨±</div>
                
                <div class="info-row">
                    <div class="info-col">
                        <div class="result-label">ğŸ·ï¸ å“ç‰Œ</div>
                        <div class="result-val" id="res-brand">-</div>
                    </div>
                    <div class="info-col">
                        <div class="result-label">ğŸŒ ç”Ÿç”¢åœ‹å®¶</div>
                        <div class="result-val" id="res-country">-</div>
                    </div>
                </div>

                <div class="result-label">ğŸ­ è£½ä½œå» å•†</div>
                <div class="result-val" id="res-manufacturer">-</div>

                <div class="result-label">ğŸ“ è©³ç´°æè¿°</div>
                <div class="result-val" id="res-desc" style="font-size:14px; color:#555; line-height:1.5;">-</div>
            </div>
            <button class="btn-reset" onclick="resetView()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#555;">æ­£åœ¨åˆ†æä¸­...</p>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // âš ï¸ è«‹å†æ¬¡ç¢ºèªé€™è£¡å·²æ›æˆæ‚¨æœ€æ–°éƒ¨ç½²çš„ GAS ç¶²å€
        const API_URL = "https://script.google.com/macros/s/æ‚¨çš„æ–°GASç¶²å€/exec";
        
        let html5QrCode = null;

        // å•Ÿå‹•æƒç¢¼æ¨¡å¼
        function startScanner() {
            initScanner(false); // false = æƒç¢¼æ¨¡å¼
        }

        // å•Ÿå‹• AI æ¨¡å¼
        function startAiCam() {
            initScanner(true); // true = AI æ¨¡å¼
        }

        // çµ±ä¸€çš„ç›¸æ©Ÿåˆå§‹åŒ–å‡½å¼ (åŒ…å«é˜²å‘†æ¸…é™¤èˆŠç›¸æ©Ÿ)
        async function initScanner(isAi) {
            try {
                // 1. å…ˆå¼·åˆ¶æ¸…ç†èˆŠçš„ç›¸æ©Ÿèˆ‡ä»‹é¢
                await resetView(); 
                
                document.getElementById('camera-box').style.display = 'block';
                document.getElementById('ai-snap-btn').style.display = isAi ? 'flex' : 'none';

                // 2. å»ºç«‹æ–°å¯¦ä¾‹
                html5QrCode = new Html5Qrcode("reader");
                
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                // 3. æ ¹æ“šæ¨¡å¼å•Ÿå‹•
                if (isAi) {
                    // AI æ¨¡å¼ï¼šä¸çµ¦ callbackï¼Œåªè·‘ç•«é¢
                    await html5QrCode.start({ facingMode: "environment" }, config, ()=>{}, ()=>{});
                } else {
                    // æƒç¢¼æ¨¡å¼ï¼šæƒåˆ°å°±è§¸ç™¼ onScanSuccess
                    await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
                }
            } catch (err) {
                console.error(err);
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚\néŒ¯èª¤: " + err);
                resetView();
            }
        }

        // æƒç¢¼æˆåŠŸæ™‚çš„å›å‘¼
        async function onScanSuccess(decodedText, decodedResult) {
            // 1. åœæ­¢ä¸¦æ¸…é™¤ç›¸æ©Ÿ (å¾¹åº•é‡‹æ”¾è³‡æº)
            await stopAndClearScanner();
            document.getElementById('camera-box').style.display = 'none';
            
            // 2. é€²è¡ŒæŸ¥è©¢
            queryBarcode(decodedText);
        }

        // æ‹ç…§ (AI æ¨¡å¼)
        async function takeSnapshot() {
            const video = document.querySelector("#reader video");
            if(!video) return;

            // æˆªåœ–é‚è¼¯
            const canvas = document.createElement("canvas");
            const w = video.videoWidth;
            const h = video.videoHeight;
            const scale = Math.min(800/w, 1); 
            canvas.width = w * scale;
            canvas.height = h * scale;
            canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
            
            // 1. åœæ­¢ä¸¦æ¸…é™¤ç›¸æ©Ÿ
            await stopAndClearScanner();
            document.getElementById('camera-box').style.display = 'none';
            
            // 2. é€²è¡Œåˆ†æ
            analyzeImage(base64);
        }

        // åœæ­¢ä¸¦æ¸…é™¤ç›¸æ©Ÿçš„æ ¸å¿ƒå‡½å¼
        async function stopAndClearScanner() {
            if (html5QrCode) {
                try {
                    // å˜—è©¦åœæ­¢ (å¦‚æœæ­£åœ¨è·‘)
                    if (html5QrCode.isScanning) {
                        await html5QrCode.stop();
                    }
                    // å‹™å¿…æ¸…é™¤ (æŠŠ video æ¨™ç±¤å¾ div ç§»é™¤)
                    await html5QrCode.clear();
                } catch (e) {
                    console.log("æ¸…ç†ç›¸æ©Ÿæ™‚å¿½ç•¥éŒ¯èª¤:", e);
                }
                html5QrCode = null; // æ­¸é›¶
            }
        }

        // é‡ç½®ä»‹é¢ (é‡æ–°é–‹å§‹)
        async function resetView() {
            await stopAndClearScanner(); // ç¢ºä¿ç›¸æ©Ÿå·²æ­»
            document.getElementById('camera-box').style.display = 'none';
            document.getElementById('result-box').style.display = 'none';
        }

        function queryBarcode(code) {
            showLoading(true);
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "queryBarcode", code: code })
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if(data.found) {
                    showResult("è³‡æ–™åº«", data.data);
                } else {
                    if(confirm("è³‡æ–™åº«æ‰¾ä¸åˆ°æ­¤æ¢ç¢¼ï¼š" + code + "\n\nè¦å˜—è©¦ç”¨ AI è¾¨è­˜å¤–è§€å—ï¼Ÿ")) {
                        startAiCam();
                    } else {
                        // é›–ç„¶åœ¨ confirm è£¡ï¼Œä½†æœ€å¥½é‚„æ˜¯ç¢ºä¿ reset ç‹€æ…‹
                        resetView();
                    }
                }
            })
            .catch(err => { 
                alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š"); 
                showLoading(false); 
                resetView(); // å¤±æ•—å¾Œå›åˆ°åˆå§‹ç‹€æ…‹
            });
        }

        function analyzeImage(base64) {
            showLoading(true);
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "identifyProduct", image: base64 })
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if(data.status === "success") {
                    try {
                        const info = JSON.parse(data.result);
                        showResult("AI è¾¨è­˜", {
                            id: "è‡ªå‹•åˆ†æ",
                            name: info.name,
                            country: info.country,
                            manufacturer: info.manufacturer,
                            brand: info.brand,
                            description: info.description
                        });
                    } catch(e) {
                        alert("è§£æå¤±æ•—");
                        resetView();
                    }
                } else {
                    alert("AI ç™¼ç”ŸéŒ¯èª¤: " + data.message);
                    resetView();
                }
            })
            .catch(err => { 
                alert("AI é€£ç·šå¤±æ•—"); 
                showLoading(false); 
                resetView(); 
            });
        }

        function showResult(source, data) {
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('res-source').innerText = "ä¾†æº: " + source;
            document.getElementById('res-id').innerText = data.id ? "#" + data.id : "";
            
            document.getElementById('res-name').innerText = data.name || "æœªçŸ¥å“å";
            document.getElementById('res-brand').innerText = data.brand || "æœªçŸ¥";
            document.getElementById('res-country').innerText = data.country || "æœªçŸ¥";
            document.getElementById('res-manufacturer').innerText = data.manufacturer || "æœªçŸ¥";
            document.getElementById('res-desc').innerText = data.description || "ç„¡";
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
