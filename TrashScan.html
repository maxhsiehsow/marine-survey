<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•†å“å¿«æœåµæ¢ V8 (ä¿®æ­£ç‰ˆ)</title>
    <style>
        /* æ¨£å¼ä¿æŒä¸è®Š */
        :root { --primary: #587a30; --bg: #f4f7f4; --text: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        
        .container { max-width: 480px; margin: 0 auto; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-scan { background: #f57c00; }
        .btn-ai { background: #0288d1; }
        .btn-reset { background: #607d8b; margin-top: 20px; }
        
        #camera-box, #result-box { display: none; margin-top: 15px; border-radius: 12px; overflow: hidden; }
        #camera-box { background: #000; position: relative; min-height: 300px; }
        .scanner-view { width: 100%; height: 100%; }
        
        .btn-snap { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.9); border: 4px solid var(--primary); z-index: 10; font-size: 30px; display: flex; align-items: center; justify-content: center; color: #333; cursor: pointer; }

        .result-card { background: #e8f5e9; border: 2px solid var(--primary); padding: 20px; border-radius: 12px; }
        .result-id { font-size: 12px; color: #999; text-align: right; margin-bottom: 5px; }
        .result-img { width: 100%; height: 200px; object-fit: contain; background: white; border-radius: 8px; margin-bottom: 10px; display:none; }
        .result-title { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 5px; line-height: 1.3; }
        .result-label { font-size: 12px; color: #666; margin-top: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .result-val { font-size: 16px; color: #333; font-weight: 500; }
        .info-row { display: flex; gap: 15px; margin-top: 5px; }
        .info-col { flex: 1; }

        #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ” å•†å“å¿«æœåµæ¢ V8</h1>
        
        <div class="btn-group">
            <button class="btn-scan" onclick="startScanner()">ğŸ“· æƒæ¢ç¢¼ (API)</button>
            <button class="btn-ai" onclick="startAiCam()">ğŸ¤– AI è¾¨è­˜</button>
        </div>

        <div id="camera-box">
            <div id="reader" class="scanner-view"></div>
            <div id="ai-snap-btn" class="btn-snap" onclick="takeSnapshot()" style="display:none;">ğŸ“¸</div>
        </div>

        <div id="result-box">
            <div class="result-card">
                <div class="result-id">
                    <span id="res-source">ä¾†æº: -</span> 
                    <span id="res-id" style="margin-left:10px;"></span>
                </div>
                <img id="res-img" class="result-img" src="" alt="å•†å“åœ–ç‰‡">
                <div class="result-title" id="res-name">å•†å“åç¨±</div>
                <div class="info-row">
                    <div class="info-col">
                        <div class="result-label">ğŸ·ï¸ å“ç‰Œ</div>
                        <div class="result-val" id="res-brand">-</div>
                    </div>
                    <div class="info-col">
                        <div class="result-label">ğŸŒ ç”Ÿç”¢åœ‹å®¶/ç”¢åœ°</div>
                        <div class="result-val" id="res-country">-</div>
                    </div>
                </div>
                <div class="result-label">ğŸ­ åˆ†é¡/å» å•†</div>
                <div class="result-val" id="res-manufacturer">-</div>
                <div class="result-label">ğŸ“ æˆåˆ†æˆ–æè¿°</div>
                <div class="result-val" id="res-desc" style="font-size:14px; color:#555; line-height:1.5;">-</div>
            </div>
            <button class="btn-reset" onclick="resetView()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:#555;">æ­£åœ¨è™•ç†ä¸­...</p>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ GAS ç¶²å€
        const GAS_AI_URL = "https://script.google.com/macros/s/æ‚¨çš„æ–°GASç¶²å€/exec";
        
        let html5QrCode = null;

        function startScanner() { initScanner(false); }
        function startAiCam() { initScanner(true); }

        async function initScanner(isAi) {
            try {
                await resetView();
                document.getElementById('camera-box').style.display = 'block';
                document.getElementById('ai-snap-btn').style.display = isAi ? 'flex' : 'none';
                html5QrCode = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                if (isAi) {
                    await html5QrCode.start({ facingMode: "environment" }, config, ()=>{}, ()=>{});
                } else {
                    await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
                }
            } catch (err) {
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err);
                resetView();
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            await stopAndClearScanner();
            document.getElementById('camera-box').style.display = 'none';
            lookupOnline(decodedText);
        }

        // === é—œéµä¿®æ­£ï¼šå®Œå…¨é‚„åŸ V94 çš„æ‹ç…§å£“ç¸®é‚è¼¯ ===
        async function takeSnapshot() {
            var videoEl = document.querySelector("#reader video");
            if (!videoEl) return;

            // 1. ä½¿ç”¨ V94 çš„ Canvas é‹ç®—é‚è¼¯
            var cvs = document.createElement("canvas");
            var max = 800;
            var w = videoEl.videoWidth;
            var h = videoEl.videoHeight;
            // åˆ¤æ–·é•·é‚Šæ˜¯å¦è¶…é 800ï¼Œè¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
            var s = (w > h ? (w > max ? max/w : 1) : (h > max ? max/h : 1));
            
            cvs.width = w * s;
            cvs.height = h * s;
            cvs.getContext("2d").drawImage(videoEl, 0, 0, cvs.width, cvs.height);
            
            // 2. é—œéµï¼šå£“ç¸®å“è³ªæ”¹å› 0.6 (èˆ‡ V94 ä¸€è‡´)
            var b64Full = cvs.toDataURL("image/jpeg", 0.6);
            
            // 3. å»é™¤å‰ç¶´
            var base64 = b64Full.split(',')[1];

            await stopAndClearScanner();
            document.getElementById('camera-box').style.display = 'none';
            analyzeImage(base64);
        }

        async function stopAndClearScanner() {
            if (html5QrCode) {
                try {
                    if (html5QrCode.isScanning) await html5QrCode.stop();
                    await html5QrCode.clear();
                } catch (e) {}
                html5QrCode = null;
            }
        }

        async function resetView() {
            await stopAndClearScanner();
            document.getElementById('camera-box').style.display = 'none';
            document.getElementById('result-box').style.display = 'none';
        }

        async function lookupOnline(barcode) {
            showLoading(true);
            const url = `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            try {
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: { "User-Agent": "MarineDebrisApp - WebVersion - V8.0" }
                });
                clearTimeout(timeoutId);
                const data = await response.json();

                if (data.status === 1) {
                    const p = data.product;
                    showResult("OpenFoodFacts", {
                        id: barcode,
                        name: p.product_name || p.product_name_zh || "æœªçŸ¥å•†å“",
                        brand: p.brands || "æœªçŸ¥å“ç‰Œ",
                        country: p.countries || p.origin || "æœªçŸ¥",
                        manufacturer: p.manufacturing_places || p.categories || "-",
                        description: p.ingredients_text || "ç„¡æˆåˆ†è³‡æ–™",
                        imageUrl: p.image_url
                    });
                } else {
                    handleNotFound(barcode);
                }
            } catch (error) {
                console.error("API Error:", error);
                handleNotFound(barcode);
            } finally {
                showLoading(false);
            }
        }

        function handleNotFound(code) {
            if(confirm(`ç·šä¸Šè³‡æ–™åº«æŸ¥ç„¡æ­¤æ¢ç¢¼ (${code})ã€‚\n\næ˜¯å¦å•Ÿå‹• AI è¾¨è­˜ä¾†è¨˜éŒ„å•†å“è³‡è¨Šï¼Ÿ`)) {
                startAiCam();
            } else {
                resetView();
            }
        }

        function analyzeImage(base64) {
            showLoading(true);
            fetch(GAS_AI_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "identifyProduct", image: base64 })
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if(data.status === "success") {
                    try {
                        const info = JSON.parse(data.result);
                        showResult("AI æ™ºæ…§è¾¨è­˜", {
                            id: "è‡ªå‹•åˆ†æ",
                            name: info.name,
                            country: info.country,
                            manufacturer: info.manufacturer,
                            brand: info.brand,
                            description: info.description
                        });
                    } catch(e) { alert("AI è§£æå¤±æ•—"); resetView(); }
                } else { alert("AI éŒ¯èª¤: " + data.message); resetView(); }
            })
            .catch(err => { 
                alert("AI é€£ç·šå¤±æ•— (è«‹æª¢æŸ¥ç¶²è·¯æˆ–åœ–ç‰‡å¤§å°)"); 
                showLoading(false); 
                resetView(); 
            });
        }

        function showResult(source, data) {
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('res-source').innerText = "ä¾†æº: " + source;
            document.getElementById('res-id').innerText = data.id ? "#" + data.id : "";
            
            const imgEl = document.getElementById('res-img');
            if(data.imageUrl) {
                imgEl.src = data.imageUrl;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            document.getElementById('res-name').innerText = data.name;
            document.getElementById('res-brand').innerText = data.brand;
            document.getElementById('res-country').innerText = data.country;
            document.getElementById('res-manufacturer').innerText = data.manufacturer;
            document.getElementById('res-desc').innerText = data.description;
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
